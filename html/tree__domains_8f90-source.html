<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PEPC: tree_domains.f90 Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7-20060810 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_75b82e7e4a5feb05200b9ad7adf06257.html">home</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_28272fc65e3d756317163f9acb2ad644.html">gibbon</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e3e416c1e3f7ebc92335d37fb0dd4777.html">pepc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_445afc100a243ec0eaed19e4a2dc673c.html">lpepcsrc</a></div>
<h1>tree_domains.f90</h1><a href="tree__domains_8f90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 !  ================================
<a name="l00003"></a>00003 !
<a name="l00004"></a>00004 !         TREE_DOMAINS
<a name="l00005"></a>00005 !
<a name="l00006"></a>00006 !     Domain decomposition:
<a name="l00007"></a>00007 !     Share particle keys amoung PEs
<a name="l00008"></a>00008 !     - weighting according to load incurred on 
<a name="l00009"></a>00009 !       previous timestep
<a name="l00010"></a>00010 !
<a name="l00011"></a>00011 !  ================================
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 
<a name="l00014"></a><a class="code" href="tree__domains_8f90.html#e5a33667647f8b6535921f4e1ddeca6c">00014</a> subroutine <a class="code" href="tree__domains_8f90.html#e5a33667647f8b6535921f4e1ddeca6c">tree_domains</a>(<a class="code" href="namelist_8h.html#b8c12579d5380e3cd3777e1c2a43d242">xl</a>,<a class="code" href="namelist_8h.html#920848accbcb0bcb52d1d0d8c31eda24">yl</a>,<a class="code" href="namelist_8h.html#6fd88682b343fc37fa3c1e56f0c3a194">zl</a>)
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 
<a name="l00017"></a>00017   use treevars
<a name="l00018"></a>00018   use tree_utils
<a name="l00019"></a>00019   use utils
<a name="l00020"></a>00020   implicit none
<a name="l00021"></a>00021   include 'mpif.h'
<a name="l00022"></a>00022 
<a name="l00023"></a>00023   real, intent(in) :: <a class="code" href="namelist_8h.html#b8c12579d5380e3cd3777e1c2a43d242">xl</a>,<a class="code" href="namelist_8h.html#920848accbcb0bcb52d1d0d8c31eda24">yl</a>,<a class="code" href="namelist_8h.html#6fd88682b343fc37fa3c1e56f0c3a194">zl</a>  ! initial box limits
<a name="l00024"></a>00024   integer*8, dimension(<a class="code" href="namespacetreevars.html#9e75bc118eec193572c6977e290cc74e">nppm</a>) :: ix, iy, iz
<a name="l00025"></a>00025   integer*8, dimension(<a class="code" href="namespacetreevars.html#9e75bc118eec193572c6977e290cc74e">nppm</a>) :: ixd, iyd, izd
<a name="l00026"></a>00026   integer*8, dimension(<a class="code" href="namespacetreevars.html#9e75bc118eec193572c6977e290cc74e">nppm</a>) :: local_key
<a name="l00027"></a>00027   integer*8, dimension(2) :: ixbox, iybox, izbox, key_box
<a name="l00028"></a>00028 
<a name="l00029"></a>00029   integer ::  source_pe(<a class="code" href="namespacetreevars.html#9e75bc118eec193572c6977e290cc74e">nppm</a>)
<a name="l00030"></a>00030   integer :: i, j, ind_recv, inc, prev, next, handle(4)
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 
<a name="l00033"></a>00033   integer :: nbits
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 
<a name="l00036"></a>00036   real*8 :: s
<a name="l00037"></a>00037   real*8 :: xmin_local, xmax_local, ymin_local, ymax_local, zmin_local, zmax_local
<a name="l00038"></a>00038   logical :: boundary_debug=.false. 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040   integer status(MPI_STATUS_SIZE), <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>, tag1
<a name="l00041"></a>00041 
<a name="l00042"></a>00042   ! arrays for parallel sort
<a name="l00043"></a>00043 
<a name="l00044"></a>00044   type (particle) :: ship_parts(<a class="code" href="namespacetreevars.html#9e75bc118eec193572c6977e290cc74e">nppm</a>), get_parts(nppm)
<a name="l00045"></a>00045 
<a name="l00046"></a>00046   integer*8 :: xarray(nppm),keys(nppm),w1(nppm),wi2(nppm),wi3(nppm)
<a name="l00047"></a>00047   integer :: indxl(nppm),irnkl(nppm)
<a name="l00048"></a>00048 
<a name="l00049"></a>00049   integer :: islen(<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>),irlen(num_pe)
<a name="l00050"></a>00050   integer :: fposts(num_pe+1),gposts(num_pe+1)
<a name="l00051"></a>00051 
<a name="l00052"></a>00052   integer :: npnew,npold
<a name="l00053"></a>00053   integer :: iteration, niterations
<a name="l00054"></a>00054   integer :: errcount, proc_debug
<a name="l00055"></a>00055 
<a name="l00056"></a>00056   integer, dimension(nppm) ::  w2, w3 ! scratch arrays for integer*4 permute
<a name="l00057"></a>00057   integer*8 :: tmp
<a name="l00058"></a>00058   logical :: sort_debug
<a name="l00059"></a>00059   real*8 :: xboxsize, yboxsize, zboxsize
<a name="l00060"></a>00060 
<a name="l00061"></a>00061   !POMP$ INST BEGIN(keys)
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     call MPI_BARRIER( MPI_COMM_WORLD, ierr)  ! Wait for everyone to catch up
<a name="l00064"></a>00064   sort_debug=<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a>
<a name="l00065"></a>00065   proc_debug=5
<a name="l00066"></a>00066 
<a name="l00067"></a>00067   if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0 .and. <a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>) write(*,'(a)') 'LPEPC | DOMAINS..'
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 
<a name="l00070"></a>00070   ! Find limits of local simulation region
<a name="l00071"></a>00071   xmin_local = minval(<a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>))
<a name="l00072"></a>00072   xmax_local = maxval(<a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>))
<a name="l00073"></a>00073   ymin_local = minval(<a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>))
<a name="l00074"></a>00074   ymax_local = maxval(<a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>))
<a name="l00075"></a>00075   zmin_local = minval(<a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>))
<a name="l00076"></a>00076   zmax_local = maxval(<a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>))
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   ! Find global limits
<a name="l00079"></a>00079 
<a name="l00080"></a>00080   call MPI_ALLREDUCE(xmin_local, <a class="code" href="namespacetreevars.html#2ec63c3b9cf68233a13c938d6db6a02d">xmin</a>, 1, MPI_REAL8, MPI_MIN,  MPI_COMM_WORLD, ierr )
<a name="l00081"></a>00081   call MPI_ALLREDUCE(xmax_local, <a class="code" href="namespacetreevars.html#a38e10142dd775dee00930af92583362">xmax</a>, 1, MPI_REAL8, MPI_MAX,  MPI_COMM_WORLD, ierr )
<a name="l00082"></a>00082   call MPI_ALLREDUCE(ymin_local, <a class="code" href="namespacetreevars.html#341f905fe7f315fa0c25845356344e6a">ymin</a>, 1, MPI_REAL8, MPI_MIN,  MPI_COMM_WORLD, ierr )
<a name="l00083"></a>00083   call MPI_ALLREDUCE(ymax_local, <a class="code" href="namespacetreevars.html#547c7725185c4acf1d9b1cc1e32db2d1">ymax</a>, 1, MPI_REAL8, MPI_MAX,  MPI_COMM_WORLD, ierr )
<a name="l00084"></a>00084   call MPI_ALLREDUCE(zmin_local, <a class="code" href="namespacetreevars.html#9c95b8df2b8d5e4e8131e52a3ee19647">zmin</a>, 1, MPI_REAL8, MPI_MIN,  MPI_COMM_WORLD, ierr )
<a name="l00085"></a>00085   call MPI_ALLREDUCE(zmax_local, <a class="code" href="namespacetreevars.html#094a88ceb292294fbb3df63db8ae77e9">zmax</a>, 1, MPI_REAL8, MPI_MAX,  MPI_COMM_WORLD, ierr )
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   xboxsize = xmax-xmin
<a name="l00089"></a>00089   yboxsize = ymax-ymin
<a name="l00090"></a>00090   zboxsize = zmax-zmin
<a name="l00091"></a>00091 
<a name="l00092"></a>00092   ! Safety margin - put buffer region around particles
<a name="l00093"></a>00093   xmax = xmax + xboxsize/10000.
<a name="l00094"></a>00094   xmin = xmin - xboxsize/10000.
<a name="l00095"></a>00095   ymax = ymax + yboxsize/10000.
<a name="l00096"></a>00096   ymin = ymin - yboxsize/10000.
<a name="l00097"></a>00097   zmax = zmax + zboxsize/10000.
<a name="l00098"></a>00098   zmin = zmin - zboxsize/10000.
<a name="l00099"></a>00099 
<a name="l00100"></a>00100   <a class="code" href="namespacetreevars.html#8b7d0bfaafb4911e08470411d32719f7">boxsize</a> = max(xmax-xmin, ymax-ymin, zmax-zmin)
<a name="l00101"></a>00101 
<a name="l00102"></a>00102   if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a>) write (<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,'(4(a15,f12.4/))') &amp;
<a name="l00103"></a>00103        'xmin = ',xmin,'xmax = ',xmax, &amp;
<a name="l00104"></a>00104        'ymin = ',ymin,'ymax = ',ymax, &amp;
<a name="l00105"></a>00105        'zmin = ',zmin,'zmax = ',zmax, &amp;
<a name="l00106"></a>00106        '<a class="code" href="namespacetreevars.html#8b7d0bfaafb4911e08470411d32719f7">boxsize</a> = ',boxsize
<a name="l00107"></a>00107 
<a name="l00108"></a>00108   s=boxsize/2**<a class="code" href="namespacetreevars.html#5f5b3f17c0444f500a18ba56caa6fa48">nlev</a>       ! refinement length
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   ! (xmin, ymin, zmin) is the translation vector from the tree box to the simulation region (in 1st octant)
<a name="l00111"></a>00111 
<a name="l00112"></a>00112   ix(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>) = ( <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>) - xmin )/s           ! partial keys
<a name="l00113"></a>00113   iy(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>) = ( <a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>) - ymin )/s           !
<a name="l00114"></a>00114   iz(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>) = ( <a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>) - zmin )/s        
<a name="l00115"></a>00115 
<a name="l00116"></a>00116   ! construct keys by interleaving coord bits and add placeholder bit
<a name="l00117"></a>00117   ! - note use of 64-bit constants to ensure correct arithmetic
<a name="l00118"></a>00118 
<a name="l00119"></a>00119   nbits = <a class="code" href="namespacetreevars.html#5f5b3f17c0444f500a18ba56caa6fa48">nlev</a>+1
<a name="l00120"></a>00120   do j = 1,<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>
<a name="l00121"></a>00121      !     local_key(j) = <a class="code" href="namespacetreevars.html#dc35764a2ebcba3e60d5cefa52bf1104">iplace</a> + &amp;
<a name="l00122"></a>00122      !          SUM( (/ (8_8**i*(4_8*ibits( iz(j),i,1) + 2_8*ibits( iy(j),i,1 ) + 1_8*ibits( ix(j),i,1) ),i=0,nbits-1) /) )
<a name="l00123"></a>00123      local_key(j) = <a class="code" href="namespacetreevars.html#dc35764a2ebcba3e60d5cefa52bf1104">iplace</a>
<a name="l00124"></a>00124      do i=0,nbits-1
<a name="l00125"></a>00125         local_key(j) = local_key(j) &amp;
<a name="l00126"></a>00126              + 8_8**i*(4_8*ibits( iz(j),i,1) + 2_8*ibits( iy(j),i,1 ) + 1_8*ibits( ix(j),i,1) )
<a name="l00127"></a>00127      end do
<a name="l00128"></a>00128   end do
<a name="l00129"></a>00129 
<a name="l00130"></a>00130   !  Find keys corresponding to corners of graphics box (initial target container)
<a name="l00131"></a>00131   if (xmin&lt;0) then
<a name="l00132"></a>00132      ixbox(1) = -xmin/s
<a name="l00133"></a>00133      ixbox(2) = (xl - xmin)/s
<a name="l00134"></a>00134   else
<a name="l00135"></a>00135      ixbox(1) = 0
<a name="l00136"></a>00136      ixbox(2) = (xmax-xmin)/s
<a name="l00137"></a>00137   endif
<a name="l00138"></a>00138 
<a name="l00139"></a>00139   if (ymin&lt;0) then
<a name="l00140"></a>00140      iybox(1) = -ymin/s
<a name="l00141"></a>00141      iybox(2) = (yl - ymin)/s
<a name="l00142"></a>00142   else
<a name="l00143"></a>00143      iybox(1) = 0
<a name="l00144"></a>00144      iybox(2) = (ymax - ymin)/s
<a name="l00145"></a>00145   endif
<a name="l00146"></a>00146 
<a name="l00147"></a>00147   if (zmin&lt;0) then
<a name="l00148"></a>00148      izbox(1) =-zmin/s
<a name="l00149"></a>00149      izbox(2) = (<a class="code" href="namelist_8h.html#6fd88682b343fc37fa3c1e56f0c3a194">zl</a> - zmin)/s
<a name="l00150"></a>00150   else
<a name="l00151"></a>00151      izbox(1) = 0
<a name="l00152"></a>00152      izbox(2) = (zmax - zmin)/s
<a name="l00153"></a>00153   endif
<a name="l00154"></a>00154 
<a name="l00155"></a>00155   do j=1,2
<a name="l00156"></a>00156      key_box(j) = <a class="code" href="namespacetreevars.html#dc35764a2ebcba3e60d5cefa52bf1104">iplace</a> + &amp;
<a name="l00157"></a>00157           SUM( (/ (8_8**i*(4_8*ibits( izbox(j),i,1) &amp;
<a name="l00158"></a>00158           + 2_8*ibits( iybox(j),i,1 ) &amp;
<a name="l00159"></a>00159           + 1_8*ibits( ixbox(j),i,1) ),i=0,nbits-1) /) )
<a name="l00160"></a>00160   end do
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 
<a name="l00163"></a>00163   if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a>) then
<a name="l00164"></a>00164      write (ipefile,'(a,2z20)') 'Box keys:', key_box(1),key_box(2)
<a name="l00165"></a>00165      write (ipefile,'(/a/a/(z21,i8,3f12.4,3i8,2f12.4))') 'Particle list before key sort:', &amp;
<a name="l00166"></a>00166           '  key,             label   coords     <a class="code" href="namespacetreevars.html#b9d8e8e7c77d33688592fb8fc698342f">q</a> ', &amp;
<a name="l00167"></a>00167           (local_key(i),<a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i),<a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(i),<a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(i),<a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(i),ix(i),iy(i),iz(i),q(i),<a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a>(i),i=1,<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>) 
<a name="l00168"></a>00168      !    write (ipefile,'(/a/a/(z21,i8,3f12.4,3i8))') '(last 10):', &amp;
<a name="l00169"></a>00169      !         '  key,                  label        coords              q ', &amp;
<a name="l00170"></a>00170      !         (local_key(i),<a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i),<a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(i),<a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(i),<a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(i),ix(i),iy(i),iz(i),q(i),<a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a>(i),i=max(1,<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>-10),npp) 
<a name="l00171"></a>00171 
<a name="l00172"></a>00172      call <a class="code" href="namespaceutils.html#826d7af61f40edacd18f12786f96966d">blankn</a>(ipefile)
<a name="l00173"></a>00173   endif
<a name="l00174"></a>00174 
<a name="l00175"></a>00175   !POMP$ INST END(keys)
<a name="l00176"></a>00176 
<a name="l00177"></a>00177   !POMP$ INST BEGIN(sort)
<a name="l00178"></a>00178 
<a name="l00179"></a>00179   ! Use Parallel Sort by Regular Sampling (PSRS) 
<a name="l00180"></a>00180 
<a name="l00181"></a>00181   call MPI_BARRIER( MPI_COMM_WORLD, ierr)   ! Synchronize first
<a name="l00182"></a>00182 
<a name="l00183"></a>00183   if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a> .and. <a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==proc_debug) then
<a name="l00184"></a>00184      write (*,*) 'MPI <a class="code" href="namespacetree__utils.html#2c0780b82b3a179b11745124db0a2bb2">psrssort</a>() commencing'
<a name="l00185"></a>00185      write (*,*) 'iproc=',<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>
<a name="l00186"></a>00186      write (*,*) 'num_pe=',num_pe
<a name="l00187"></a>00187      write (*,*) 'npp=',npp
<a name="l00188"></a>00188   endif
<a name="l00189"></a>00189 
<a name="l00190"></a>00190   iteration = 0
<a name="l00191"></a>00191   niterations = 3  ! Max <span class="preprocessor"># iterations</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>  errcount = 1
<a name="l00193"></a>00193   npold = npp
<a name="l00194"></a>00194   npnew = npp
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 
<a name="l00197"></a>00197   ! start permutation of local key list
<a name="l00198"></a>00198   <span class="keywordflow">do</span> i=1,npp
<a name="l00199"></a>00199      xarray(i) = local_key(i)
<a name="l00200"></a>00200   enddo
<a name="l00201"></a>00201 
<a name="l00202"></a>00202   do while (errcount /= 0 .or. iteration == niterations)
<a name="l00203"></a>00203      iteration = iteration + 1
<a name="l00204"></a>00204 
<a name="l00205"></a>00205      if (iteration .lt. niterations) then
<a name="l00206"></a>00206         do i=1,npold
<a name="l00207"></a>00207            keys(i) = xarray(i)
<a name="l00208"></a>00208         enddo
<a name="l00209"></a>00209      else
<a name="l00210"></a>00210         if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a> .and. errcount .eq. 0) then
<a name="l00211"></a>00211            write (ipefile,*) 'This time we are using already sorted data'
<a name="l00212"></a>00212         endif
<a name="l00213"></a>00213         npold = npnew
<a name="l00214"></a>00214         do i=1,npold
<a name="l00215"></a>00215            xarray(i) = w1(i)
<a name="l00216"></a>00216            keys(i) = w1(i)
<a name="l00217"></a>00217         enddo
<a name="l00218"></a>00218      endif
<a name="l00219"></a>00219 
<a name="l00220"></a>00220      if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a>.and.<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) then
<a name="l00221"></a>00221         write (ipefile,'(a/(i5,z20,i8))') 'input array (1st 10):  ',(i,keys(i),<a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i),i=1,min(10,npold))
<a name="l00222"></a>00222         write (ipefile,'(a/(i5,z20,i8))') 'input array (last 10):  ',(i,keys(i),<a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i),i=max(1,npold-10),npold)
<a name="l00223"></a>00223         write (ipefile,*) 'npold=',npold
<a name="l00224"></a>00224      endif
<a name="l00225"></a>00225 
<a name="l00226"></a>00226      ! perform index sort on keys
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 !     call <a class="code" href="namespacetree__utils.html#c107318c9b8e56b8cd87d9381ce5d4c5">pswssort</a>(nppm,npold,npnew,num_pe,<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>,keys, &amp;
<a name="l00229"></a>00229 !        indxl,irnkl,islen,irlen,fposts,gposts,w1,<a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a>,key_box,<a class="code" href="namespacetreevars.html#a09bfc5f3d0322ca9ff874dea4ee4864">load_balance</a>,sort_debug)
<a name="l00230"></a>00230      call <a class="code" href="namespacetree__utils.html#0eb24bef7e6c449c596242b1c3db15c1">pbalsort</a>(nppm,npold,npnew,num_pe,me,keys, &amp;
<a name="l00231"></a>00231           indxl,irnkl,islen,irlen,fposts,gposts,<a class="code" href="namespacetreevars.html#f6ade0ddb16dec71ab9f6583a8d2745e">pivots</a>,w1,work,key_box,load_balance,sort_debug,<a class="code" href="namespacetreevars.html#6ccbebd32d635e79b3f80fff71840543">work_local</a>)
<a name="l00232"></a>00232 
<a name="l00233"></a>00233      do i=1,npold
<a name="l00234"></a>00234         w1(i) = xarray(i)
<a name="l00235"></a>00235      enddo
<a name="l00236"></a>00236 
<a name="l00237"></a>00237      ! permute keys according to sorted indices
<a name="l00238"></a>00238      call pll_permute(nppm,npold,npnew,num_pe,me,w1,wi2,wi3, &amp;
<a name="l00239"></a>00239           indxl,irnkl,islen,irlen,fposts,gposts)
<a name="l00240"></a>00240 
<a name="l00241"></a>00241      if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a>) then
<a name="l00242"></a>00242         write (ipefile,*) 'npnew=',npnew,' on ',me
<a name="l00243"></a>00243         !         write (ipefile,'(a/(i5,z20))') 'output array (1st 10): ',(i,w1(i),i=1,10)
<a name="l00244"></a>00244         !         write (ipefile,'(a/(i5,z20))') 'output array (last 10): ',(i,w1(i),i=npnew-10,npnew)
<a name="l00245"></a>00245 !        if (me.eq.50) then
<a name="l00246"></a>00246            write (ipefile,'(a/(i5,z20))') 'output array (1st 10): ',(i,w1(i),i=1,min(10,npnew))
<a name="l00247"></a>00247            write (ipefile,'(a/(i5,z20))') 'output array (last 10): ',(i,w1(i),i=max(1,npnew-10),npnew)
<a name="l00248"></a>00248 !        endif
<a name="l00249"></a>00249         write (ipefile,*) 'npnew=',npnew
<a name="l00250"></a>00250      endif
<a name="l00251"></a>00251 
<a name="l00252"></a>00252      ! Check if sort finished
<a name="l00253"></a>00253      errcount = 0
<a name="l00254"></a>00254      do i=2,npnew
<a name="l00255"></a>00255         if (w1(i) .lt. w1(i-1)) then
<a name="l00256"></a>00256            errcount = errcount + 1
<a name="l00257"></a>00257            if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a> .and. errcount .lt. 10) then
<a name="l00258"></a>00258               write (ipefile,'(a,i5,2z20)') 'i,w1(i),w1(i-1)=',i,w1(i),w1(i-1)
<a name="l00259"></a>00259            endif
<a name="l00260"></a>00260         endif
<a name="l00261"></a>00261      enddo
<a name="l00262"></a>00262 
<a name="l00263"></a>00263      ! Define wraps for ring network  0 -&gt; 1 -&gt; 2 -&gt; ... ... -&gt; num_pe-1 -&gt; 0 ...
<a name="l00264"></a>00264      if (me == 0) then
<a name="l00265"></a>00265         prev = num_pe - 1
<a name="l00266"></a>00266      else
<a name="l00267"></a>00267         prev = me-1
<a name="l00268"></a>00268      endif
<a name="l00269"></a>00269 
<a name="l00270"></a>00270      if (me == num_pe-1 ) then
<a name="l00271"></a>00271         next = 0
<a name="l00272"></a>00272      else
<a name="l00273"></a>00273         next = me+1
<a name="l00274"></a>00274      endif
<a name="l00275"></a>00275 
<a name="l00276"></a>00276      ! swap end items
<a name="l00277"></a>00277      if (me .<a class="code" href="namelist_8h.html#c570850af67b707ee0fabd68903062f7">ne</a>. 0) then
<a name="l00278"></a>00278         call MPI_ISEND(w1, 1, MPI_INTEGER8, prev, 1, MPI_COMM_WORLD, handle(1), ierr)
<a name="l00279"></a>00279         call MPI_REQUEST_FREE(handle(1),ierr)
<a name="l00280"></a>00280      endif
<a name="l00281"></a>00281 
<a name="l00282"></a>00282      if (me .<a class="code" href="namelist_8h.html#c570850af67b707ee0fabd68903062f7">ne</a>. num_pe-1) then
<a name="l00283"></a>00283         call MPI_RECV(tmp, 1, MPI_INTEGER8, next, 1, MPI_COMM_WORLD, status, ierr)
<a name="l00284"></a>00284      endif
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 
<a name="l00287"></a>00287      if (me .<a class="code" href="namelist_8h.html#c570850af67b707ee0fabd68903062f7">ne</a>. num_pe-1) then
<a name="l00288"></a>00288         !    if (me == 50 ) then
<a name="l00289"></a>00289         if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a> .and. tmp .lt. w1(npnew)) then          ! still something to sort
<a name="l00290"></a>00290            write (*,'(a,i3,a1,2z20)') 'w1(npnew), w1(1) from',me+1, '=',w1(npnew),tmp
<a name="l00291"></a>00291            errcount = errcount + 1  
<a name="l00292"></a>00292         endif
<a name="l00293"></a>00293      endif
<a name="l00294"></a>00294 
<a name="l00295"></a>00295      if (errcount .<a class="code" href="namelist_8h.html#c570850af67b707ee0fabd68903062f7">ne</a>. 0 .and. <a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a>) then
<a name="l00296"></a>00296         write (ipefile,*) 'errcount=',errcount
<a name="l00297"></a>00297      endif
<a name="l00298"></a>00298 
<a name="l00299"></a>00299      call MPI_BARRIER(MPI_COMM_WORLD, ierr)
<a name="l00300"></a>00300 
<a name="l00301"></a>00301   enddo
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   npp = npnew
<a name="l00306"></a>00306   <a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(1:npp) = w1(1:npp)
<a name="l00307"></a>00307 
<a name="l00308"></a>00308   ! Check for identical keys
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   do i=2,npp
<a name="l00311"></a>00311      if (<a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(i) == <a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(i-1)) then
<a name="l00312"></a>00312 !        write(*,'(a15,i5,a30,2i8)') 'LPEPC | PE ',me,' WARNING: identical keys found for particles  ',<a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i),<a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i-1)
<a name="l00313"></a>00313         
<a name="l00314"></a>00314         <a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(i) = <a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(i) + 1  ! Augment higher key
<a name="l00315"></a>00315 !        write(ipefile,'(a,o21)') 'LPEPC | Upper key increased to:  ',<a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(i)
<a name="l00316"></a>00316      endif
<a name="l00317"></a>00317   end do
<a name="l00318"></a>00318 
<a name="l00319"></a>00319   ! Now permute remaining particle properties : <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>,<a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>,<a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>; vx,vy,vz; q,<a class="code" href="namespacetreevars.html#6c12d2901c45a88c6f838e61074b3577">m</a>, label, load
<a name="l00320"></a>00320 
<a name="l00321"></a>00321   source_pe(1:npold) = <a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(1:npold)   ! where particle came from
<a name="l00322"></a>00322 
<a name="l00323"></a>00323   ! Set up particle structure - keys and source_pe are dummies
<a name="l00324"></a>00324   ! ( <a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a> is already sorted)
<a name="l00325"></a>00325 
<a name="l00326"></a>00326   do i=1,npold
<a name="l00327"></a>00327      ship_parts(i) = particle( x(indxl(i)), y(indxl(i)), z(indxl(i)), &amp;
<a name="l00328"></a>00328           <a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>(indxl(i)), <a class="code" href="namespacetreevars.html#091b9d7991d39847f53ba7abd87ec1d4">uy</a>(indxl(i)), <a class="code" href="namespacetreevars.html#3b14c2f77b072cc356b49d5163e12f36">uz</a>(indxl(i)), &amp;
<a name="l00329"></a>00329           q(indxl(i)), <a class="code" href="namespacetreevars.html#6c12d2901c45a88c6f838e61074b3577">m</a>(indxl(i)), work(indxl(i)), &amp;
<a name="l00330"></a>00330 !          ax(indxl(i)), ay(indxl(i)), az(indxl(i)), &amp;
<a name="l00331"></a>00331           ex(indxl(i)), ey(indxl(i)), ez(indxl(i)), &amp;
<a name="l00332"></a>00332           keys(indxl(i)), <a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(indxl(i)), source_pe(indxl(i))    )
<a name="l00333"></a>00333   enddo
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 
<a name="l00336"></a>00336   ! perform permute
<a name="l00337"></a>00337   call MPI_alltoallv(  ship_parts, islen, fposts, <a class="code" href="namespacetreevars.html#036dcc5d5f84ea66e74c53d6e2977d46">mpi_type_particle</a>, &amp;
<a name="l00338"></a>00338        get_parts, irlen, gposts, mpi_type_particle, &amp;
<a name="l00339"></a>00339        MPI_COMM_WORLD,ierr)
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   do i=1,npp
<a name="l00342"></a>00342      x(irnkl(i)) = get_parts(i)%x
<a name="l00343"></a>00343      y(irnkl(i)) = get_parts(i)%y
<a name="l00344"></a>00344      z(irnkl(i)) = get_parts(i)%z
<a name="l00345"></a>00345      <a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>(irnkl(i)) = get_parts(i)%<a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>
<a name="l00346"></a>00346      <a class="code" href="namespacetreevars.html#091b9d7991d39847f53ba7abd87ec1d4">uy</a>(irnkl(i)) = get_parts(i)%<a class="code" href="namespacetreevars.html#091b9d7991d39847f53ba7abd87ec1d4">uy</a>
<a name="l00347"></a>00347      <a class="code" href="namespacetreevars.html#3b14c2f77b072cc356b49d5163e12f36">uz</a>(irnkl(i)) = get_parts(i)%<a class="code" href="namespacetreevars.html#3b14c2f77b072cc356b49d5163e12f36">uz</a>
<a name="l00348"></a>00348      q(irnkl(i)) = get_parts(i)%q
<a name="l00349"></a>00349      <a class="code" href="namespacetreevars.html#6c12d2901c45a88c6f838e61074b3577">m</a>(irnkl(i)) = get_parts(i)%<a class="code" href="namespacetreevars.html#6c12d2901c45a88c6f838e61074b3577">m</a>
<a name="l00350"></a>00350      work(irnkl(i)) = get_parts(i)%work
<a name="l00351"></a>00351 !     ax(irnkl(i)) = get_parts(i)%ax
<a name="l00352"></a>00352 !     ay(irnkl(i)) = get_parts(i)%ay
<a name="l00353"></a>00353 !     az(irnkl(i)) = get_parts(i)%az
<a name="l00354"></a>00354      ex(irnkl(i)) = get_parts(i)%ax
<a name="l00355"></a>00355      ey(irnkl(i)) = get_parts(i)%ay
<a name="l00356"></a>00356      ez(irnkl(i)) = get_parts(i)%az
<a name="l00357"></a>00357      <a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(irnkl(i)) = get_parts(i)%label
<a name="l00358"></a>00358   enddo
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 
<a name="l00361"></a>00361   <a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(1:npp) = me  ! new owner
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a>) then
<a name="l00367"></a>00367      do j=1,npp
<a name="l00368"></a>00368         ixd(j) = SUM( (/ (2_8**i*ibits( <a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(j)-<a class="code" href="namespacetreevars.html#dc35764a2ebcba3e60d5cefa52bf1104">iplace</a>,3*i,1 ), i=0,nbits-2) /) )
<a name="l00369"></a>00369         iyd(j) = SUM( (/ (2_8**i*ibits( <a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(j)-iplace,3*i+1,1 ), i=0,nbits-2) /) )
<a name="l00370"></a>00370         izd(j) = SUM( (/ (2_8**i*ibits( <a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(j)-iplace,3*i+2,1 ), i=0,nbits-2) /) )
<a name="l00371"></a>00371      end do
<a name="l00372"></a>00372      write (ipefile,'(/a/a/(z21,2i6,a2,i8,6f12.4))') 'Particle list after key sort:', &amp;
<a name="l00373"></a>00373           '  key,                owner,    from PE  |  label  Fetched coords      derived from key', &amp;
<a name="l00374"></a>00374           (<a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(i),<a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(i),source_pe(i),'|', &amp;
<a name="l00375"></a>00375           <a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i),x(i),y(i),z(i),ixd(i)*s+xmin,iyd(i)*s+ymin,izd(i)*s+zmin,i=1,npp) 
<a name="l00376"></a>00376 
<a name="l00377"></a>00377      call <a class="code" href="namespaceutils.html#826d7af61f40edacd18f12786f96966d">blankn</a>(ipefile)
<a name="l00378"></a>00378   endif
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   ! Each PE now has sorted segment of particles of length npp
<a name="l00382"></a>00382   ! Note that now npp /= <a class="code" href="namespacetreevars.html#ac21a2dc42e5595e66cba603534873bd">npart</a>/num_pe, only approx depending on key distribution, or target shape.
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 
<a name="l00385"></a>00385   ! Copy boundary particles to adjacent PEs to ensure proper tree construction
<a name="l00386"></a>00386   !  - if we don't do this, can get two particles on separate PEs 'sharing' a leaf
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 
<a name="l00389"></a>00389 !  <a class="code" href="namespacetreevars.html#91492fbd344715a6805b92048a06b0ad">ship_props</a> = particle ( x(1), y(1), z(1), <a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>(1), <a class="code" href="namespacetreevars.html#091b9d7991d39847f53ba7abd87ec1d4">uy</a>(1), <a class="code" href="namespacetreevars.html#3b14c2f77b072cc356b49d5163e12f36">uz</a>(1), q(1), <a class="code" href="namespacetreevars.html#6c12d2901c45a88c6f838e61074b3577">m</a>(1), work(1), &amp;
<a name="l00390"></a>00390 !       ax(1),ay(1),az(1), <a class="code" href="namespacetreevars.html#cba952608d98a8f29384930ed9cd0b35">pekey</a>(1), <a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(1), <a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(1) )
<a name="l00391"></a>00391 
<a name="l00392"></a>00392   <a class="code" href="namespacetreevars.html#91492fbd344715a6805b92048a06b0ad">ship_props</a> = particle ( x(1), y(1), z(1), ux(1), uy(1), uz(1), q(1), m(1), work(1), &amp;
<a name="l00393"></a>00393        ax(1),ay(1),az(1), pekey(1), pelabel(1), <a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(1) )
<a name="l00394"></a>00394 
<a name="l00395"></a>00395   !  write (*,'(9f12.3,z20,2i6)') <a class="code" href="namespacetreevars.html#91492fbd344715a6805b92048a06b0ad">ship_props</a>
<a name="l00396"></a>00396 
<a name="l00397"></a>00397   ! Ship 1st particle data to end of list of LH neighbour PE
<a name="l00398"></a>00398 
<a name="l00399"></a>00399   if (me /= 0 ) then
<a name="l00400"></a>00400      call MPI_ISEND( <a class="code" href="namespacetreevars.html#91492fbd344715a6805b92048a06b0ad">ship_props</a>, 1, mpi_type_particle, prev, 1, MPI_COMM_WORLD, handle(1), ierr ) 
<a name="l00401"></a>00401      call MPI_REQUEST_FREE(handle(1),ierr) 
<a name="l00402"></a>00402   endif
<a name="l00403"></a>00403 
<a name="l00404"></a>00404   ! Place incoming data at end of array
<a name="l00405"></a>00405   if ( me /= num_pe-1) then
<a name="l00406"></a>00406      !     call MPI_IRECV( <a class="code" href="namespacetreevars.html#656cfc72705848b706282b137ed649a0">get_props</a>, 1, mpi_type_particle, next, 1,  MPI_COMM_WORLD, handle(2), ierr )
<a name="l00407"></a>00407      call MPI_RECV( get_props, 1, mpi_type_particle, next, 1,  MPI_COMM_WORLD, status, ierr )
<a name="l00408"></a>00408      x(npp+1) = get_props%x
<a name="l00409"></a>00409      y(npp+1) = get_props%y
<a name="l00410"></a>00410      z(npp+1) = get_props%z
<a name="l00411"></a>00411      ux(npp+1) = get_props%ux
<a name="l00412"></a>00412      uy(npp+1) = get_props%uy
<a name="l00413"></a>00413      uz(npp+1) = get_props%uz
<a name="l00414"></a>00414      q(npp+1) = get_props%q
<a name="l00415"></a>00415      m(npp+1) = get_props%m
<a name="l00416"></a>00416      work(npp+1) = get_props%work
<a name="l00417"></a>00417      ex(npp+1) = get_props%ax
<a name="l00418"></a>00418      ey(npp+1) = get_props%ay
<a name="l00419"></a>00419      ez(npp+1) = get_props%az
<a name="l00420"></a>00420 !     ax(npp+1) = get_props%ax
<a name="l00421"></a>00421 !     ay(npp+1) = get_props%ay
<a name="l00422"></a>00422 !     az(npp+1) = get_props%az
<a name="l00423"></a>00423      pekey(npp+1) = get_props%key
<a name="l00424"></a>00424      pelabel(npp+1) = get_props%label
<a name="l00425"></a>00425      <a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(npp+1) = get_props%pid
<a name="l00426"></a>00426   endif
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 
<a name="l00430"></a>00430   call MPI_BARRIER(MPI_COMM_WORLD, ierr)
<a name="l00431"></a>00431   !  if (me /= num_pe-1) call MPI_WAIT(handle(2),status,ierr)
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 
<a name="l00434"></a>00434   ! Ship  end particle data to start of list of RH neighbour PE
<a name="l00435"></a>00435 
<a name="l00436"></a>00436 !  ship_props = particle ( x(npp), y(npp), z(npp), ux(npp), uy(npp), uz(npp), q(npp), m(npp), work(npp), &amp;
<a name="l00437"></a>00437 !       ax(npp),ay(npp),az(npp), pekey(npp), pelabel(npp), <a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(npp) )
<a name="l00438"></a>00438 
<a name="l00439"></a>00439   ship_props = particle ( x(npp), y(npp), z(npp), ux(npp), uy(npp), uz(npp), q(npp), m(npp), work(npp), &amp;
<a name="l00440"></a>00440        ex(npp),ey(npp),ez(npp), pekey(npp), pelabel(npp), <a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(npp) )
<a name="l00441"></a>00441 
<a name="l00442"></a>00442   if (me /= num_pe-1 ) then
<a name="l00443"></a>00443      call MPI_ISEND( ship_props, 1, mpi_type_particle, next, 2, MPI_COMM_WORLD, handle(3), ierr )
<a name="l00444"></a>00444      call MPI_REQUEST_FREE(handle(3),ierr) 
<a name="l00445"></a>00445   endif
<a name="l00446"></a>00446 
<a name="l00447"></a>00447   ! Place incoming data at end of array
<a name="l00448"></a>00448 
<a name="l00449"></a>00449   if (me == num_pe-1) then
<a name="l00450"></a>00450      ind_recv = npp+1   ! PEn array hasn't yet received boundary value
<a name="l00451"></a>00451   else
<a name="l00452"></a>00452      ind_recv = npp+2
<a name="l00453"></a>00453   endif
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   if ( me /= 0) then
<a name="l00456"></a>00456      !     call MPI_IRECV( get_props, 1, mpi_type_particle, prev, 2,  MPI_COMM_WORLD, handle(4), ierr )
<a name="l00457"></a>00457      call MPI_RECV( get_props, 1, mpi_type_particle, prev, 2,  MPI_COMM_WORLD, status, ierr )
<a name="l00458"></a>00458      x(ind_recv) = get_props%x
<a name="l00459"></a>00459      y(ind_recv) = get_props%y
<a name="l00460"></a>00460      z(ind_recv) = get_props%z
<a name="l00461"></a>00461      ux(ind_recv) = get_props%ux
<a name="l00462"></a>00462      uy(ind_recv) = get_props%uy
<a name="l00463"></a>00463      uz(ind_recv) = get_props%uz
<a name="l00464"></a>00464      q(ind_recv) = get_props%q
<a name="l00465"></a>00465      m(ind_recv) = get_props%m
<a name="l00466"></a>00466      work(ind_recv) = get_props%work
<a name="l00467"></a>00467 !     ax(ind_recv) = get_props%ax
<a name="l00468"></a>00468 !     ay(ind_recv) = get_props%ay
<a name="l00469"></a>00469 !     az(ind_recv) = get_props%az
<a name="l00470"></a>00470      ex(ind_recv) = get_props%ax
<a name="l00471"></a>00471      ey(ind_recv) = get_props%ay
<a name="l00472"></a>00472      ez(ind_recv) = get_props%az
<a name="l00473"></a>00473      pekey(ind_recv) = get_props%key
<a name="l00474"></a>00474      pelabel(ind_recv) = get_props%label
<a name="l00475"></a>00475      <a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(ind_recv) = get_props%pid
<a name="l00476"></a>00476   endif
<a name="l00477"></a>00477 
<a name="l00478"></a>00478 
<a name="l00479"></a>00479   !  if (me /= 0) call MPI_WAIT(handle(4),status,ierr)
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   if (boundary_debug) then
<a name="l00482"></a>00482      if (me /= 0 .and. me /= num_pe-1) then
<a name="l00483"></a>00483         inc = 1
<a name="l00484"></a>00484      else
<a name="l00485"></a>00485         inc = 0
<a name="l00486"></a>00486      endif
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 
<a name="l00489"></a>00489 
<a name="l00490"></a>00490      write (ipefile,'(/a/a/(i5,z21,2i8,3f12.5,2f12.3))') 'Particle list after boundary swap:', &amp;
<a name="l00491"></a>00491           ' index   key,     label,   on PE,    x      y     q       m', &amp;
<a name="l00492"></a>00492           (i,pekey(i),pelabel(i),<a class="code" href="namespacetreevars.html#6f1233e9ba9d5552e1b9dcec0fe6565d">pepid</a>(i),x(i),y(i),z(i),q(i),m(i),i=1,npp+1+inc) 
<a name="l00493"></a>00493 
<a name="l00494"></a>00494      call <a class="code" href="namespaceutils.html#826d7af61f40edacd18f12786f96966d">blankn</a>(ipefile)
<a name="l00495"></a>00495   endif
<a name="l00496"></a>00496   call MPI_BARRIER( MPI_COMM_WORLD, ierr)  ! Wait for everyone to catch up
<a name="l00497"></a>00497   if (me==0 .and. <a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>) write(*,'(a)') 'LPEPC | ..done'
<a name="l00498"></a>00498   !POMP$ INST END(sort)
<a name="l00499"></a>00499 
<a name="l00500"></a>00500 end subroutine <a class="code" href="tree__domains_8f90.html#e5a33667647f8b6535921f4e1ddeca6c">tree_domains</a>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 23 16:02:50 2007 for PEPC by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7-20060810 </small></address>
</body>
</html>
