<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PEPC: cluster_sa.f90 Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7-20060810 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_75b82e7e4a5feb05200b9ad7adf06257.html">home</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_28272fc65e3d756317163f9acb2ad644.html">gibbon</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e3e416c1e3f7ebc92335d37fb0dd4777.html">pepc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_991097dbe07e9883c0a11fa77543783e.html">pepc-b</a></div>
<h1>cluster_sa.f90</h1><a href="cluster__sa_8f90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 ! ==============================================
<a name="l00002"></a>00002 !
<a name="l00003"></a>00003 !               CLUSTER_SA 
<a name="l00004"></a>00004 !
<a name="l00005"></a>00005 !   $Revision: 1.0
<a name="l00006"></a>00006 !
<a name="l00007"></a>00007 !  Convert uniform sphere to tapered density profile
<a name="l00008"></a>00008 !  according to Sasha Andreev parametric form
<a name="l00009"></a>00009 ! 
<a name="l00010"></a>00010 ! ==============================================
<a name="l00011"></a>00011 
<a name="l00012"></a><a class="code" href="cluster__sa_8f90.html#fa8e27b44d7bcd08f043d898478d3cd0">00012</a> subroutine <a class="code" href="cluster__sa_8f90.html#fa8e27b44d7bcd08f043d898478d3cd0">cluster_sa</a>(i1,<a class="code" href="namelist_8h.html#6c4b21d213fef7eb3c21f8abc98104c6">nip</a>,r0,<a class="code" href="namelist_8h.html#4717f1135bf0b6bb04e6105ceb5a08dd">r_sphere</a>,<a class="code" href="namespacephysvars.html#6bdbc3c85d95127570179f88965c5db3">qi</a>,<a class="code" href="namespacephysvars.html#f496963d8d4a8fe5a5a8ea1fbcd77dae">Qplas</a>,<a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>,miome)
<a name="l00013"></a>00013 
<a name="l00014"></a>00014     use treevars
<a name="l00015"></a>00015     use utils
<a name="l00016"></a>00016 
<a name="l00017"></a>00017     implicit none
<a name="l00018"></a>00018 
<a name="l00019"></a>00019     real, intent(in) :: r0  ! characteristic radius
<a name="l00020"></a>00020     real, intent(in) :: <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(3) !  sphere centre
<a name="l00021"></a>00021     real, intent(in) :: <a class="code" href="namelist_8h.html#4717f1135bf0b6bb04e6105ceb5a08dd">r_sphere</a> ! equivalent sphere radius for <a class="code" href="namespacephysvars.html#6bdbc3c85d95127570179f88965c5db3">qi</a> 
<a name="l00022"></a>00022     real, intent(in) :: <a class="code" href="namespacephysvars.html#6bdbc3c85d95127570179f88965c5db3">qi</a> ! particle <a class="code" href="namespacetreevars.html#c635f0d036ac28a9d50d9a34ce023562">charge</a>
<a name="l00023"></a>00023     real, intent(in) :: <a class="code" href="namespacephysvars.html#f496963d8d4a8fe5a5a8ea1fbcd77dae">Qplas</a> ! total plasma <a class="code" href="namespacetreevars.html#c635f0d036ac28a9d50d9a34ce023562">charge</a>
<a name="l00024"></a>00024     real, intent(in) :: miome ! mass ratio
<a name="l00025"></a>00025 
<a name="l00026"></a>00026     integer, intent(in) :: i1  ! index offset
<a name="l00027"></a>00027     integer, intent(in) :: <a class="code" href="namelist_8h.html#6c4b21d213fef7eb3c21f8abc98104c6">nip</a> ! <span class="preprocessor"># particles to set up</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>    integer              :: i, j, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>
<a name="l00029"></a>00029     integer              :: p, k, nramp, nx, ny
<a name="l00030"></a>00030     real*8 :: rt, xt, yt, zt, <a class="code" href="namespacephysvars.html#b9f2356028909f76dcdbd63c4cfcfee4">pi</a>, xi
<a name="l00031"></a>00031     real*8 :: r_c, Q_c, Q_s, dens, Qnorm, dens0, v_max
<a name="l00032"></a>00032     integer :: nitot, N_c, N_s, npi_c, npi_s, nbin, np_rest, offset
<a name="l00033"></a>00033     real*8 :: zeta_max, zeta, dzeta, t_start, a_const, b_const, Qt
<a name="l00034"></a>00034     real*8 :: SZ, T, ch, sh, sh2, th, ch2, rp, integ, nom, dom
<a name="l00035"></a>00035     
<a name="l00036"></a>00036 ! Andreev cluster:
<a name="l00037"></a>00037 ! uniform up to <a class="code" href="namespacerantest.html#57e18b26d24449e6afe0d206da3394ce">r</a>=0.1125 r0
<a name="l00038"></a>00038 ! tapered from r=0.1125 r0 to 2.5 r0
<a name="l00039"></a>00039     pi = 2.*asin(1.d0)
<a name="l00040"></a>00040     t_start = 0.05  
<a name="l00041"></a>00041     zeta_max = 0.23  ! start point r(0.23)=0.1125
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 ! <span class="preprocessor"># ions in central region</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>    r_c = 0.1125*r0
<a name="l00045"></a>00045     dens0 = 1./3./t_start**2*(sinh(2*zeta_max)/2. + zeta_max)**2/(cosh(zeta_max)**4*(1.-zeta_max*tanh(zeta_max)))
<a name="l00046"></a>00046  
<a name="l00047"></a>00047     v_max = sqrt(2./3.)/sqrt(dens0)/sqrt(miome)*r0
<a name="l00048"></a>00048 
<a name="l00049"></a>00049   ! # ions in central, <span class="keyword">self</span>-sim regions
<a name="l00050"></a>00050     Q_c = 4*pi/3.*dens0*r_c**3  ! Keep density=nmax in centre
<a name="l00051"></a>00051     N_c = Q_c/<a class="code" href="namespacephysvars.html#6bdbc3c85d95127570179f88965c5db3">qi</a>
<a name="l00052"></a>00052     nitot = <a class="code" href="namespacephysvars.html#f496963d8d4a8fe5a5a8ea1fbcd77dae">Qplas</a>/<a class="code" href="namespacephysvars.html#6bdbc3c85d95127570179f88965c5db3">qi</a>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 ! # <a class="code" href="namespacetreevars.html#c635f0d036ac28a9d50d9a34ce023562">charge</a> in outer region
<a name="l00055"></a>00055     Q_s = <a class="code" href="namespacephysvars.html#f496963d8d4a8fe5a5a8ea1fbcd77dae">Qplas</a> - Q_c
<a name="l00056"></a>00056     N_s = Q_s/<a class="code" href="namespacephysvars.html#6bdbc3c85d95127570179f88965c5db3">qi</a>
<a name="l00057"></a>00057     Qnorm = 4.94 ! stretch factor <span class="keywordflow">for</span> <a class="code" href="namespacetreevars.html#c635f0d036ac28a9d50d9a34ce023562">charge</a> integral
<a name="l00058"></a>00058 !    Qnorm = 2.45 ! stretch factor <span class="keywordflow">for</span> <a class="code" href="namespacetreevars.html#c635f0d036ac28a9d50d9a34ce023562">charge</a> integral
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 ! # put remainder central particles on last cpu 
<a name="l00061"></a>00061     <span class="keywordflow">if</span> (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>-1) then
<a name="l00062"></a>00062       np_rest = mod(N_c,<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>)
<a name="l00063"></a>00063     else
<a name="l00064"></a>00064       np_rest = 0
<a name="l00065"></a>00065     endif
<a name="l00066"></a>00066     npi_c = N_c/<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a> + np_rest
<a name="l00067"></a>00067     npi_s = <a class="code" href="namelist_8h.html#6c4b21d213fef7eb3c21f8abc98104c6">nip</a>-npi_c
<a name="l00068"></a>00068     offset = <a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>*(<a class="code" href="namelist_8h.html#6c4b21d213fef7eb3c21f8abc98104c6">nip</a>-N_c/<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>)  ! shell offset same for all
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) then
<a name="l00071"></a>00071       write(*,'(a30,3i12)') "Total ions, in centre/outside:",nitot,N_c,N_s
<a name="l00072"></a>00072       write(*,'(a42,3i12)') "Local ions in centre/outside:",npi_c,npi_s
<a name="l00073"></a>00073       write(*,'(a30,3f12.4)') "Radii r_eff, r_c, r0:", <a class="code" href="namelist_8h.html#4717f1135bf0b6bb04e6105ceb5a08dd">r_sphere</a>, r_c, r0
<a name="l00074"></a>00074       write(*,'(a30,3f12.4)') "Charge Q_tot, Q_c, Q_s",<a class="code" href="namespacephysvars.html#f496963d8d4a8fe5a5a8ea1fbcd77dae">Qplas</a>, Q_c, Q_s
<a name="l00075"></a>00075     endif
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 ! <span class="preprocessor"># rescale radii of inner ions</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>    <span class="keywordflow">do</span> i=1,npi_c
<a name="l00079"></a>00079         p = i + i1-1  ! local index (including offset)
<a name="l00080"></a>00080         j = <a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>*(npi_c-np_rest) + i   ! Unique global particle #
<a name="l00081"></a>00081         xt = <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(p)-<a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(1)
<a name="l00082"></a>00082         yt = <a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(p)-<a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(2)
<a name="l00083"></a>00083         zt = <a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(p)-<a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(3)
<a name="l00084"></a>00084         xi = (1.*j/N_c)**(1./3.) !  inversion for uniform density
<a name="l00085"></a>00085         rt = sqrt(xt**2+yt**2+zt**2)
<a name="l00086"></a>00086         <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(p) = <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(1) + xt/rt*r_c*xi  ! keep direction vector; scale by inner sphere radius 
<a name="l00087"></a>00087         <a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(p) = <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(2) + yt/rt*r_c*xi
<a name="l00088"></a>00088         <a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(p) = <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(3) + zt/rt*r_c*xi
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         write (<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,'(i6,a8,f15.5)') j,'r/r0, ',r_c*xi/r0
<a name="l00091"></a>00091      end do
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 ! <span class="preprocessor"># Integrate outer zone numerically, according to Andreev parametric form</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>! # Each CPU will place particles in different segments of integrated shell
<a name="l00096"></a>00096      nbin = 100*N_s
<a name="l00097"></a>00097 !     nbin = 50*
<a name="l00098"></a>00098      dzeta = -zeta_max/nbin
<a name="l00099"></a>00099      zeta=zeta_max
<a name="l00100"></a>00100      Qt = 0.
<a name="l00101"></a>00101      j = offset + 1  ! Global starting index of ions
<a name="l00102"></a>00102      i = npi_c+i1 ! Local index
<a name="l00103"></a>00103         <span class="keywordflow">if</span>(<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,*) 'zeta_max, dzeta, nbin',zeta_max,dzeta,nbin
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     <span class="keywordflow">do</span> <span class="keywordflow">while</span> (zeta&gt;0.004 .and. j&lt;=offset + npi_s)
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 ! Integrand
<a name="l00108"></a>00108         sh2 = sinh(2*zeta)
<a name="l00109"></a>00109         th = tanh(zeta)
<a name="l00110"></a>00110         ch2 = cosh(2*zeta)
<a name="l00111"></a>00111         ch = cosh(zeta)
<a name="l00112"></a>00112         SZ = sh2/2. + zeta
<a name="l00113"></a>00113         T = 1.-zeta*th
<a name="l00114"></a>00114 
<a name="l00115"></a>00115         dens = 1./3./t_start**2*sz**2/(ch**4*(1.-zeta*th))
<a name="l00116"></a>00116         integ =  (sh2*sz - ch**2*(ch2 + 1)) / (T*sz**2) 
<a name="l00117"></a>00117         Qt = Qt + integ*t_start*dzeta*N_s/Qnorm
<a name="l00118"></a>00118         rp = t_start*ch**2/sz ! Radius associated with zeta
<a name="l00119"></a>00119 !        if(<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,'(8f12.5)') rp,zeta,integ,Qt
<a name="l00120"></a>00120 
<a name="l00121"></a>00121         if (Qt &gt; j) then      
<a name="l00122"></a>00122 ! place particle
<a name="l00123"></a>00123           xt = <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(i)-<a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(1)  ! Get direction vector
<a name="l00124"></a>00124           yt = <a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(i)-<a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(2)
<a name="l00125"></a>00125           zt = <a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(i)-<a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(3)
<a name="l00126"></a>00126           rt = sqrt(xt**2+yt**2+zt**2)
<a name="l00127"></a>00127          write (ipefile,'(i6,a23,4f15.5)') i,'r/r0, zeta, integ, Qt',rp,zeta,integ,Qt
<a name="l00128"></a>00128 !         if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,'(i6,a23,5f15.5)') i,'r/r0, zeta, dens, integ, Qt',rp,zeta,dens,integ,Qt
<a name="l00129"></a>00129 
<a name="l00130"></a>00130           <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(i) = <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(1) + xt/rt*rp*r0  ! scale by sphere radius 
<a name="l00131"></a>00131           <a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(i) = <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(2) + yt/rt*rp*r0
<a name="l00132"></a>00132           <a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(i) = <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(3) + zt/rt*rp*r0
<a name="l00133"></a>00133 ! Scale <a class="code" href="velocities_8f90.html#796291391239757f01e2b4e3b6b27650">velocities</a> according to ss value at radius rp 
<a name="l00134"></a>00134 !          <a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>(i) = v_max*th*xt/rt
<a name="l00135"></a>00135 !          <a class="code" href="namespacetreevars.html#091b9d7991d39847f53ba7abd87ec1d4">uy</a>(i) = v_max*th*yt/rt
<a name="l00136"></a>00136 !          <a class="code" href="namespacetreevars.html#3b14c2f77b072cc356b49d5163e12f36">uz</a>(i) = v_max*th*zt/rt
<a name="l00137"></a>00137           j=j+1
<a name="l00138"></a>00138           i=i+1
<a name="l00139"></a>00139        endif
<a name="l00140"></a>00140        zeta = zeta+dzeta
<a name="l00141"></a>00141     end do
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 end subroutine <a class="code" href="cluster__sa_8f90.html#fa8e27b44d7bcd08f043d898478d3cd0">cluster_sa</a> 
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 23 16:02:49 2007 for PEPC by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7-20060810 </small></address>
</body>
</html>
