<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PEPC: fields_p.f90 Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7-20060810 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_75b82e7e4a5feb05200b9ad7adf06257.html">home</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_28272fc65e3d756317163f9acb2ad644.html">gibbon</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e3e416c1e3f7ebc92335d37fb0dd4777.html">pepc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_445afc100a243ec0eaed19e4a2dc673c.html">lpepcsrc</a></div>
<h1>fields_p.f90</h1><a href="fields__p_8f90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 !  ===================================================================
<a name="l00002"></a>00002 !
<a name="l00003"></a>00003 !                              FIELDS - internal parallel version
<a name="l00004"></a>00004 !
<a name="l00005"></a>00005 !   $Revision: 514 $
<a name="l00006"></a>00006 !
<a name="l00007"></a>00007 !   Calculate fields and potential from INTERNAL coordinates <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>,<a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>,<a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>, <a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>, <a class="code" href="namespacetreevars.html#091b9d7991d39847f53ba7abd87ec1d4">uy</a>, <a class="code" href="namespacetreevars.html#3b14c2f77b072cc356b49d5163e12f36">uz</a> in treevars module:
<a name="l00008"></a>00008 !
<a name="l00009"></a>00009 !
<a name="l00010"></a>00010 !   ** Returns fields <a class="code" href="namespacetreevars.html#965b464677536c91c1aa7d309b77487f">Ex</a>, <a class="code" href="namespacetreevars.html#eb08655fc8ee445e48c5c52cb334a4a3">Ey</a>, <a class="code" href="namespacetreevars.html#5a7f29cfd6e9c687628d324991fecf3a">Ez</a> and potential <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a> excluding external terms **
<a name="l00011"></a>00011 !
<a name="l00012"></a>00012 !
<a name="l00013"></a>00013 !  ===================================================================
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 
<a name="l00016"></a><a class="code" href="fields__p_8f90.html#8345869654c79bbbbcd720e779026912">00016</a> subroutine <a class="code" href="fields__p_8f90.html#8345869654c79bbbbcd720e779026912">pepc_fields_p</a>(<a class="code" href="namespacephysvars.html#f198eb2b475070e5cbc103bdfae9d16a">np_local</a>,<a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>, <a class="code" href="namelist_8h.html#051ba9b635fca70611c05a5b65e92cd1">mac</a>, <a class="code" href="namelist_8h.html#2debd5e81fbe9e3985b18628f622d180">theta</a>, <a class="code" href="namelist_8h.html#686fe22fc41e924ca935210c01f22dcf">ifreeze</a>, <a class="code" href="namelist_8h.html#3d5b0f2d79621403cfab74bce3469eb1">eps</a>, err_f, <a class="code" href="namelist_8h.html#2606f6bb46feacaea3f8c92db8f66a9c">balance</a>, <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a>, <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a>, &amp;
<a name="l00017"></a>00017      delta_t,  <a class="code" href="namelist_8h.html#b8c12579d5380e3cd3777e1c2a43d242">xl</a>, <a class="code" href="namelist_8h.html#920848accbcb0bcb52d1d0d8c31eda24">yl</a>, <a class="code" href="namelist_8h.html#6fd88682b343fc37fa3c1e56f0c3a194">zl</a>, <a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>, &amp;
<a name="l00018"></a>00018      <a class="code" href="namelist_8h.html#6a7aa3e1d13373bb9ff0af7298c58c7d">coulomb</a>, bfield_on, <a class="code" href="namelist_8h.html#9d40dc6c3d4a4647d1d325ae1cff8b13">bonds</a>, <a class="code" href="namelist_8h.html#b04556176d1d031f4d99b6fe86e69bcf">lenjones</a>, &amp;
<a name="l00019"></a>00019      <a class="code" href="namespacepepcb.html#6e8072643a548391a745947bcff8fc06">t_domain</a>,<a class="code" href="namespacepepcb.html#e2a1a43d56fc2268b018881166af99cc">t_build</a>,<a class="code" href="namespacepepcb.html#a1c9458f9c292d84dbd4f7143d7a9485">t_prefetch</a>, <a class="code" href="namespacepepcb.html#32b91af6fa3d998b1e1ff2ce3061f5ef">t_walk</a>, <a class="code" href="namespacepepcb.html#354c316e8d79b5bed2fbad1b75857693">t_walkc</a>, <a class="code" href="namespacepepcb.html#093e44b1de57a8447c7541822b2a62c9">t_force</a>, <a class="code" href="namelist_8h.html#e3f41688c55ecf61f14ee189d036a104">iprot</a>,total_work)
<a name="l00020"></a>00020 
<a name="l00021"></a>00021   use treevars
<a name="l00022"></a>00022   use utils
<a name="l00023"></a>00023   implicit none
<a name="l00024"></a>00024   include 'mpif.h'
<a name="l00025"></a>00025 
<a name="l00026"></a>00026   integer :: <a class="code" href="namespacephysvars.html#f198eb2b475070e5cbc103bdfae9d16a">np_local</a>        ! <span class="preprocessor"># particles on CPU - can be changed in tree_domains</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span>  real, intent(in) :: <a class="code" href="namelist_8h.html#2debd5e81fbe9e3985b18628f622d180">theta</a>       ! multipole opening angle
<a name="l00028"></a>00028   real, intent(in) :: err_f       ! max tolerated force error (rms)
<a name="l00029"></a>00029   real, intent(in) :: delta_t       ! timestep 
<a name="l00030"></a>00030   real, intent(in) :: <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a>, <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a>       ! scaling factors for Coulomb/Len-Jones fields &amp; potential
<a name="l00031"></a>00031   real, intent(in) :: <a class="code" href="namelist_8h.html#3d5b0f2d79621403cfab74bce3469eb1">eps</a>         ! potential softening distance
<a name="l00032"></a>00032   logical, intent(in) :: <a class="code" href="namelist_8h.html#6a7aa3e1d13373bb9ff0af7298c58c7d">coulomb</a>  ! Compute Coulomb fields
<a name="l00033"></a>00033   logical, intent(in) :: bfield_on  ! Switch for including B-fields
<a name="l00034"></a>00034   logical, intent(in) :: <a class="code" href="namelist_8h.html#9d40dc6c3d4a4647d1d325ae1cff8b13">bonds</a>  ! Include bond forces
<a name="l00035"></a>00035   logical, intent(in) :: <a class="code" href="namelist_8h.html#b04556176d1d031f4d99b6fe86e69bcf">lenjones</a> ! Include Lennard-Jones potential
<a name="l00036"></a>00036   real, intent(in) :: <a class="code" href="namelist_8h.html#b8c12579d5380e3cd3777e1c2a43d242">xl</a>, <a class="code" href="namelist_8h.html#920848accbcb0bcb52d1d0d8c31eda24">yl</a>, <a class="code" href="namelist_8h.html#6fd88682b343fc37fa3c1e56f0c3a194">zl</a>         ! box dimensions
<a name="l00037"></a>00037   integer, intent(in) :: <a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>  ! timestep
<a name="l00038"></a>00038   integer, intent(in) :: <a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>  ! choice of tree walk 
<a name="l00039"></a>00039   integer, intent(in) :: <a class="code" href="namelist_8h.html#051ba9b635fca70611c05a5b65e92cd1">mac</a>  ! choice of tree walk 
<a name="l00040"></a>00040   integer, intent(in) :: <a class="code" href="namelist_8h.html#2606f6bb46feacaea3f8c92db8f66a9c">balance</a>  ! balancing
<a name="l00041"></a>00041   integer :: <a class="code" href="namelist_8h.html#686fe22fc41e924ca935210c01f22dcf">ifreeze</a>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 
<a name="l00045"></a>00045   integer, parameter :: npassm=100000 ! Max # passes - will need <a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>/<a class="code" href="namespacetreevars.html#5ae03d212991a18d05e377ced298a766">nshortm</a>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047   integer :: p, i, j, npass, jpass, ip1, nps,  max_npass,nshort_list, ipe
<a name="l00048"></a>00048   real :: <a class="code" href="namespacepepcb.html#6e8072643a548391a745947bcff8fc06">t_domain</a>, <a class="code" href="namespacepepcb.html#e2a1a43d56fc2268b018881166af99cc">t_build</a>(4), <a class="code" href="namespacepepcb.html#a1c9458f9c292d84dbd4f7143d7a9485">t_prefetch</a>, <a class="code" href="namespacepepcb.html#32b91af6fa3d998b1e1ff2ce3061f5ef">t_walk</a>, <a class="code" href="namespacepepcb.html#354c316e8d79b5bed2fbad1b75857693">t_walkc</a>, <a class="code" href="namespacepepcb.html#093e44b1de57a8447c7541822b2a62c9">t_force</a>, ttrav, tfetch, t1, t2, t3  ! timing integrals
<a name="l00049"></a>00049   real :: tb1, tb2, tb3, tb4, td1, td2, tp1, tp2
<a name="l00050"></a>00050   integer :: pshortlist(<a class="code" href="namespacetreevars.html#5ae03d212991a18d05e377ced298a766">nshortm</a>),nshort(npassm),pstart(npassm) ! <a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a> <a class="code" href="namelist_8h.html#2606f6bb46feacaea3f8c92db8f66a9c">balance</a> arrays
<a name="l00051"></a>00051   integer :: hashaddr ! Key <a class="code" href="namespacetreevars.html#3ecc2e98e400f5751ae1758d72035e15">address</a> 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053   integer :: max_local,  timestamp
<a name="l00054"></a>00054   integer :: <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>
<a name="l00055"></a>00055   integer :: <a class="code" href="namelist_8h.html#e3f41688c55ecf61f14ee189d036a104">iprot</a>  ! frequency for load <a class="code" href="namelist_8h.html#2606f6bb46feacaea3f8c92db8f66a9c">balance</a> <a class="code" href="dump_8f90.html#88b597631f796e2b06c577e64bd94fe9">dump</a>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057   real*8 :: fsx, fsy, fsz, phi, phi_coul, ex_coul, ey_coul, ez_coul
<a name="l00058"></a>00058   real*8 :: fljmax
<a name="l00059"></a>00059   real*8 :: ax_ind, ay_ind, az_ind, bx_ind, by_ind, bz_ind
<a name="l00060"></a>00060   real ::  load_average, load_integral, total_work, average_work
<a name="l00061"></a>00061   integer :: total_parts
<a name="l00062"></a>00062   character(30) :: cfile, ccol1, ccol2
<a name="l00063"></a>00063   character(4) :: cme
<a name="l00064"></a>00064   integer :: <a class="code" href="get__address_8f90.html#2809b00e2dcb999b654cac13b2ffb261">key2addr</a>        ! Mapping function to get hash table <a class="code" href="namespacetreevars.html#3ecc2e98e400f5751ae1758d72035e15">address</a> from key
<a name="l00065"></a>00065 
<a name="l00066"></a>00066   !  <a class="code" href="namespacetreevars.html#001505bba4c1517aa171fe7a61bc3c9c">force_debug</a>=.true.
<a name="l00067"></a>00067   !  <a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>=.false.
<a name="l00068"></a>00068   !  <a class="code" href="namespacetreevars.html#af090ee31bd2f8257db663f92e09bce7">build_debug</a>=.false.
<a name="l00069"></a>00069   !  <a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a> = .false.
<a name="l00070"></a>00070   !  <a class="code" href="namespacetreevars.html#c3309cf4ec043d5956cd45aa550ad196">branch_debug</a>=.false.
<a name="l00071"></a>00071   !  <a class="code" href="namespacetreevars.html#951fff9f3a94d5095788ba2d42be9151">prefetch_debug</a>=.false.
<a name="l00072"></a>00072   !  <a class="code" href="namespacetreevars.html#415096877a1abe9a37d0435e96d0f30a">walk_debug</a>=.true.
<a name="l00073"></a>00073   !  <a class="code" href="namespacetreevars.html#af03d6c35b13db23cd43b4522df652a4">walk_summary</a>=.true.
<a name="l00074"></a>00074   !  <a class="code" href="namespacetreevars.html#917587657ac434132020e7adaeb8b1f3">dump_tree</a>=.true.
<a name="l00075"></a>00075   !  <a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a> = <a class="code" href="namespacephysvars.html#f198eb2b475070e5cbc103bdfae9d16a">np_local</a>  ! assumed lists matched for now
<a name="l00076"></a>00076 
<a name="l00077"></a>00077   if (<a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a> /= 3) <a class="code" href="namelist_8h.html#686fe22fc41e924ca935210c01f22dcf">ifreeze</a>=1
<a name="l00078"></a>00078 
<a name="l00079"></a>00079   <a class="code" href="namespacetreevars.html#a09bfc5f3d0322ca9ff874dea4ee4864">load_balance</a>=<a class="code" href="namelist_8h.html#2606f6bb46feacaea3f8c92db8f66a9c">balance</a>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 
<a name="l00082"></a>00082   if (<a class="code" href="namespacetreevars.html#001505bba4c1517aa171fe7a61bc3c9c">force_debug</a>) then
<a name="l00083"></a>00083      if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,*)
<a name="l00084"></a>00084      if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,'(a8,a60/a7,2i5,6f11.2)') 'LPEPC | ','Params <a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>, <a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>, <a class="code" href="namelist_8h.html#2debd5e81fbe9e3985b18628f622d180">theta</a>, <a class="code" href="namelist_8h.html#3d5b0f2d79621403cfab74bce3469eb1">eps</a>, <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a>, <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a>, err, delta_t:', &amp;
<a name="l00085"></a>00085           'LPEPC | ',<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>, <a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>, <a class="code" href="namelist_8h.html#2debd5e81fbe9e3985b18628f622d180">theta</a>, <a class="code" href="namelist_8h.html#3d5b0f2d79621403cfab74bce3469eb1">eps</a>, <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a>, <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a>, err_f, delta_t
<a name="l00086"></a>00086      if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,'(a8,a17,4l4)') 'LPEPC | ','Force switches: ',<a class="code" href="namelist_8h.html#6a7aa3e1d13373bb9ff0af7298c58c7d">coulomb</a>,bfield_on,<a class="code" href="namelist_8h.html#b04556176d1d031f4d99b6fe86e69bcf">lenjones</a>,<a class="code" href="namelist_8h.html#9d40dc6c3d4a4647d1d325ae1cff8b13">bonds</a>
<a name="l00087"></a>00087      write (<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,'(a8,a20/(i16,4f15.3))') 'LPEPC | ','Initial buffers: ',(<a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i), <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(i), <a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(i), <a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(i), <a class="code" href="namespacetreevars.html#b9d8e8e7c77d33688592fb8fc698342f">q</a>(i),i=1,<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>) 
<a name="l00088"></a>00088   endif
<a name="l00089"></a>00089 
<a name="l00090"></a>00090   if (mod(<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>-1,<a class="code" href="namelist_8h.html#686fe22fc41e924ca935210c01f22dcf">ifreeze</a>)==0) then
<a name="l00091"></a>00091      if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,'(a23)') 'LPEPC | REBUILDING TREE'
<a name="l00092"></a>00092  !    stop
<a name="l00093"></a>00093      call cputime(td1)
<a name="l00094"></a>00094      !POMP$ INST BEGIN(domains)
<a name="l00095"></a>00095      call <a class="code" href="tree__domains_8f90.html#e5a33667647f8b6535921f4e1ddeca6c">tree_domains</a>(<a class="code" href="namelist_8h.html#b8c12579d5380e3cd3777e1c2a43d242">xl</a>,<a class="code" href="namelist_8h.html#920848accbcb0bcb52d1d0d8c31eda24">yl</a>,<a class="code" href="namelist_8h.html#6fd88682b343fc37fa3c1e56f0c3a194">zl</a>)    ! Domain decomposition: allocate particle keys to PEs
<a name="l00096"></a>00096      !POMP$ INST END(domains)
<a name="l00097"></a>00097      ! particles now sorted according to keys assigned in <a class="code" href="tree__domains_8f90.html#e5a33667647f8b6535921f4e1ddeca6c">tree_domains</a>.
<a name="l00098"></a>00098 
<a name="l00099"></a>00099      call cputime(tb1)
<a name="l00100"></a>00100 
<a name="l00101"></a>00101      !POMP$ INST BEGIN(build)
<a name="l00102"></a>00102      call <a class="code" href="tree__build_8f90.html#00b4464b1b391043323911a75676c11c">tree_build</a>      ! Build trees from local particle lists
<a name="l00103"></a>00103      call cputime(tb2)
<a name="l00104"></a>00104      call <a class="code" href="tree__branches_8f90.html#600358828426e3ba05e76e278d86f747">tree_branches</a>   ! Determine and concatenate branch nodes
<a name="l00105"></a>00105      call cputime(tb3)
<a name="l00106"></a>00106      call <a class="code" href="tree__fill_8f90.html#c7a68d71e17a9778e6bbee7a72b73ed6">tree_fill</a>       ! Fill in remainder of local tree
<a name="l00107"></a>00107      !POMP$ INST END(build)
<a name="l00108"></a>00108      call cputime(tb4)
<a name="l00109"></a>00109      <a class="code" href="namespacepepcb.html#6e8072643a548391a745947bcff8fc06">t_domain</a> = tb1-td1
<a name="l00110"></a>00110      <a class="code" href="namespacepepcb.html#e2a1a43d56fc2268b018881166af99cc">t_build</a>(1) = tb2-tb1
<a name="l00111"></a>00111      <a class="code" href="namespacepepcb.html#e2a1a43d56fc2268b018881166af99cc">t_build</a>(2) = tb3-tb2
<a name="l00112"></a>00112      <a class="code" href="namespacepepcb.html#e2a1a43d56fc2268b018881166af99cc">t_build</a>(3) = tb4-tb3
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   else 
<a name="l00115"></a>00115      if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,'(a19)') 'LPEPC | FREEZE MODE'
<a name="l00116"></a>00116      <a class="code" href="namespacepepcb.html#6e8072643a548391a745947bcff8fc06">t_domain</a>=0.
<a name="l00117"></a>00117      <a class="code" href="namespacepepcb.html#e2a1a43d56fc2268b018881166af99cc">t_build</a>=0.
<a name="l00118"></a>00118   endif
<a name="l00119"></a>00119 
<a name="l00120"></a>00120      call cputime(tp1)
<a name="l00121"></a>00121   !POMP$ INST BEGIN(properties)
<a name="l00122"></a>00122   call <a class="code" href="tree__properties_8f90.html#b495d74d5abf43b6e431c5e10db38109">tree_properties</a> ! Compute multipole moments for local tree
<a name="l00123"></a>00123   !POMP$ INST END(properties)
<a name="l00124"></a>00124      call cputime(tp2)
<a name="l00125"></a>00125         <a class="code" href="namespacepepcb.html#e2a1a43d56fc2268b018881166af99cc">t_build</a>(4) = tp2-tp1
<a name="l00126"></a>00126 
<a name="l00127"></a>00127   call cputime(tp1)
<a name="l00128"></a>00128   if (<a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>==3) then
<a name="l00129"></a>00129      if (mod(<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>-1,<a class="code" href="namelist_8h.html#686fe22fc41e924ca935210c01f22dcf">ifreeze</a>) /= 0) then
<a name="l00130"></a>00130         ! freeze mode - re-fetch nonlocal multipole info
<a name="l00131"></a>00131         !POMP$ INST BEGIN(update)
<a name="l00132"></a>00132         call <a class="code" href="tree__update_8f90.html#c341cd50192ca7a4e4bd74727a665687">tree_update</a>(<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>)
<a name="l00133"></a>00133         !POMP$ INST END(update)
<a name="l00134"></a>00134 
<a name="l00135"></a>00135      else
<a name="l00136"></a>00136         ! tree just rebuilt so check for missing nodes before re-fetching
<a name="l00137"></a>00137         !POMP$ INST BEGIN(<a class="code" href="namespacetreevars.html#268e054a2a11dd7806061233237fef15">prefetch</a>)
<a name="l00138"></a>00138 !        call <a class="code" href="tree__prefetch_8f90.html#146ca7077d94cbab63efe120b946faa3">tree_prefetch</a>(<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>)
<a name="l00139"></a>00139         !POMP$ INST END(<a class="code" href="namespacetreevars.html#268e054a2a11dd7806061233237fef15">prefetch</a>)
<a name="l00140"></a>00140         <a class="code" href="namespacetreevars.html#57da86873a8ef7e030a571b7ad0263f0">nfetch_total</a>=0     ! Zero key fetch/request counters if fresh tree walk needed
<a name="l00141"></a>00141         <a class="code" href="namespacetreevars.html#c56353fcc7cc41b4f1f42d0a50cc4d64">nreqs_total</a>=0
<a name="l00142"></a>00142         <a class="code" href="namespacetreevars.html#959a7ea5cb1126405dfbdbccfe52579c">sum_fetches</a>=0      ! total current # multipole fetches (per tree update)
<a name="l00143"></a>00143         <a class="code" href="namespacetreevars.html#98a5e67d24ae4f0fe88492d6cf4f77a9">sum_ships</a>=0      ! total current # multipole shipments
<a name="l00144"></a>00144 
<a name="l00145"></a>00145      endif
<a name="l00146"></a>00146 
<a name="l00147"></a>00147   else if (<a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>==2 .and. <a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>&gt;1) then
<a name="l00148"></a>00148      !POMP$ INST BEGIN(<a class="code" href="namespacetreevars.html#268e054a2a11dd7806061233237fef15">prefetch</a>)
<a name="l00149"></a>00149      call <a class="code" href="tree__prefetch_8f90.html#146ca7077d94cbab63efe120b946faa3">tree_prefetch</a>(<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>)
<a name="l00150"></a>00150      !POMP$ INST END(<a class="code" href="namespacetreevars.html#268e054a2a11dd7806061233237fef15">prefetch</a>)
<a name="l00151"></a>00151 
<a name="l00152"></a>00152   else 
<a name="l00153"></a>00153      ! fresh walk in asynch. (<a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>=0)  or collective mode (<a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>=1)
<a name="l00154"></a>00154      <a class="code" href="namespacetreevars.html#57da86873a8ef7e030a571b7ad0263f0">nfetch_total</a>=0     ! Zero key fetch/request counters if fresh tree walk needed
<a name="l00155"></a>00155      <a class="code" href="namespacetreevars.html#c56353fcc7cc41b4f1f42d0a50cc4d64">nreqs_total</a>=0
<a name="l00156"></a>00156      <a class="code" href="namespacetreevars.html#959a7ea5cb1126405dfbdbccfe52579c">sum_fetches</a>=0      ! total current # multipole fetches (per tree update)
<a name="l00157"></a>00157      <a class="code" href="namespacetreevars.html#98a5e67d24ae4f0fe88492d6cf4f77a9">sum_ships</a>=0      ! total current # multipole shipments
<a name="l00158"></a>00158   endif
<a name="l00159"></a>00159 
<a name="l00160"></a>00160   call cputime(tp2)
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 
<a name="l00163"></a>00163   <a class="code" href="namespacepepcb.html#a1c9458f9c292d84dbd4f7143d7a9485">t_prefetch</a> = tp2-tp1
<a name="l00164"></a>00164   <a class="code" href="namespacepepcb.html#32b91af6fa3d998b1e1ff2ce3061f5ef">t_walk</a>=0.
<a name="l00165"></a>00165   <a class="code" href="namespacepepcb.html#354c316e8d79b5bed2fbad1b75857693">t_walkc</a>=0.
<a name="l00166"></a>00166   <a class="code" href="namespacepepcb.html#093e44b1de57a8447c7541822b2a62c9">t_force</a>=0.
<a name="l00167"></a>00167   max_local = 0   ! max length of interaction list
<a name="l00168"></a>00168   <a class="code" href="namespacetreevars.html#eedff4d85b564024fa75dda1a3aceb78">max_list_length</a> = 0
<a name="l00169"></a>00169   <a class="code" href="namespacetreevars.html#6ccbebd32d635e79b3f80fff71840543">work_local</a> = 0  ! total workload
<a name="l00170"></a>00170   <a class="code" href="namespacetreevars.html#66a1faa6be6c372bb5a156d17381b892">maxtraverse</a>=0   ! max # traversals
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 
<a name="l00173"></a>00173   !  # passes needed to process all particles
<a name="l00174"></a>00174   nshort_list =<a class="code" href="namespacetreevars.html#5ae03d212991a18d05e377ced298a766">nshortm</a>/3 
<a name="l00175"></a>00175   npass = max(1,<a class="code" href="namespacetreevars.html#ac21a2dc42e5595e66cba603534873bd">npart</a>/<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>/nshort_list)   ! ave(<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>)/nshort_list   - make nshort_list a power of 2
<a name="l00176"></a>00176   load_average = SUM(<a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a>(1:<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>))/npass   ! Ave. workload per pass: same for all PEs if already load balanced
<a name="l00177"></a>00177   nshort(1:npass+1) = 0
<a name="l00178"></a>00178 
<a name="l00179"></a>00179   load_integral = 0.
<a name="l00180"></a>00180   jpass = 1
<a name="l00181"></a>00181   pstart(jpass) = 1
<a name="l00182"></a>00182   if (<a class="code" href="namespacetreevars.html#49919cda29c851a7464ea9b3d37d7fce">domain_debug</a>) write(*,*) 'PE ',<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>,': <a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>',<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>
<a name="l00183"></a>00183 
<a name="l00184"></a>00184   do i=1,<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>
<a name="l00185"></a>00185      load_integral = load_integral + <a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a>(i)   ! integrate workload
<a name="l00186"></a>00186 
<a name="l00187"></a>00187      if (i-pstart(jpass) + 1 == <a class="code" href="namespacetreevars.html#5ae03d212991a18d05e377ced298a766">nshortm</a>) then ! Need to check that nshort &lt; <a class="code" href="namespacetreevars.html#5ae03d212991a18d05e377ced298a766">nshortm</a>
<a name="l00188"></a>00188         write(*,*) 'Warning from PE: ',<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>,' # parts ',i-pstart(jpass)+1,' on pass ',jpass,' in shortlist exceeds array limit ',<a class="code" href="namespacetreevars.html#5ae03d212991a18d05e377ced298a766">nshortm</a>
<a name="l00189"></a>00189         write(*,*) 'Load=',load_integral
<a name="l00190"></a>00190         write(*,*) '<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>=',<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>
<a name="l00191"></a>00191         write(*,*) 'Putting spill-over into following pass'
<a name="l00192"></a>00192         nshort(jpass) = <a class="code" href="namespacetreevars.html#5ae03d212991a18d05e377ced298a766">nshortm</a>
<a name="l00193"></a>00193         jpass = jpass + 1
<a name="l00194"></a>00194         pstart(jpass) = i+1
<a name="l00195"></a>00195 
<a name="l00196"></a>00196      else if (load_integral &gt;= load_average * jpass .or. i==<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a> ) then
<a name="l00197"></a>00197         nshort(jpass) = i-pstart(jpass) + 1
<a name="l00198"></a>00198         jpass = jpass + 1
<a name="l00199"></a>00199         pstart(jpass) = i+1
<a name="l00200"></a>00200 
<a name="l00201"></a>00201      endif
<a name="l00202"></a>00202   end do
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 
<a name="l00205"></a>00205   if (jpass-1 &gt; npass ) then
<a name="l00206"></a>00206      write(*,*) 'LPEPC | PE',<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>,' missed some:',nshort(npass+1)
<a name="l00207"></a>00207      if (nshort(npass) + nshort(npass+1) &lt;= <a class="code" href="namespacetreevars.html#5ae03d212991a18d05e377ced298a766">nshortm</a>) then
<a name="l00208"></a>00208         nshort(npass) = nshort(npass) + nshort(npass+1)
<a name="l00209"></a>00209      else
<a name="l00210"></a>00210         npass = npass+1
<a name="l00211"></a>00211      endif
<a name="l00212"></a>00212   endif
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   if (<a class="code" href="namespacetreevars.html#001505bba4c1517aa171fe7a61bc3c9c">force_debug</a>)   write (<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,*) 'Shortlists: ',(nshort(j),j=1,npass+1)
<a name="l00215"></a>00215 
<a name="l00216"></a>00216   max_npass = npass
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   ip1 = 1
<a name="l00219"></a>00219   fljmax = 0.
<a name="l00220"></a>00220 
<a name="l00221"></a>00221   do jpass = 1,max_npass
<a name="l00222"></a>00222      !  make short-list
<a name="l00223"></a>00223      nps = nshort(jpass)
<a name="l00224"></a>00224      ip1 = pstart(jpass)
<a name="l00225"></a>00225      pshortlist(1:nps) = (/ (ip1+i-1, i=1,nps) /)
<a name="l00226"></a>00226 
<a name="l00227"></a>00227      if (<a class="code" href="namespacetreevars.html#001505bba4c1517aa171fe7a61bc3c9c">force_debug</a>) then
<a name="l00228"></a>00228         if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write(*,'(a14,i4,a4,i4,a20,i8,a4,i8)') &amp;
<a name="l00229"></a>00229              'LPEPC |  pass ',jpass,' of ',max_npass,': # particles ',ip1,' to ',ip1+nps-1
<a name="l00230"></a>00230         write(<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,*) 'LPEPC |  pass ',jpass,' # particles ',ip1,' to ',ip1+nps-1
<a name="l00231"></a>00231      endif
<a name="l00232"></a>00232 
<a name="l00233"></a>00233      !  build interaction list: 
<a name="l00234"></a>00234      ! tree walk creates <a class="code" href="namespacetreevars.html#f99b61fd87d2273b634f6cb97c1f920c">intlist</a>(1:nps), <a class="code" href="namespacetreevars.html#038c4e890b46de1d1dce97658d24652c">nodelist</a>(1:nps) for particles on short list
<a name="l00235"></a>00235 
<a name="l00236"></a>00236      if (<a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>==2 .or. <a class="code" href="namelist_8h.html#29150380d4e1884ebede6311f0006ab3">walk_scheme</a>==1) then
<a name="l00237"></a>00237    ! collective walk
<a name="l00238"></a>00238         call <a class="code" href="tree__cowalk_8f90.html#a1d1cae3a571b6e49abeb12247dc2eb3">tree_walkc</a>(pshortlist,nps,jpass,<a class="code" href="namelist_8h.html#2debd5e81fbe9e3985b18628f622d180">theta</a>,<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>,<a class="code" href="namelist_8h.html#051ba9b635fca70611c05a5b65e92cd1">mac</a>,ttrav,tfetch)
<a name="l00239"></a>00239     else
<a name="l00240"></a>00240    ! asynchronous walk  (0,3)
<a name="l00241"></a>00241        call <a class="code" href="tree__aswalk_8f90.html#edc62302e0a6458cc8830d1d676dd759">tree_walk</a>(pshortlist,nps,jpass,<a class="code" href="namelist_8h.html#2debd5e81fbe9e3985b18628f622d180">theta</a>,<a class="code" href="namelist_8h.html#3d5b0f2d79621403cfab74bce3469eb1">eps</a>,<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>,<a class="code" href="namelist_8h.html#051ba9b635fca70611c05a5b65e92cd1">mac</a>,ttrav,tfetch)
<a name="l00242"></a>00242     endif
<a name="l00243"></a>00243 
<a name="l00244"></a>00244      <a class="code" href="namespacepepcb.html#32b91af6fa3d998b1e1ff2ce3061f5ef">t_walk</a> = <a class="code" href="namespacepepcb.html#32b91af6fa3d998b1e1ff2ce3061f5ef">t_walk</a> + ttrav  ! traversal time (serial)
<a name="l00245"></a>00245      <a class="code" href="namespacepepcb.html#354c316e8d79b5bed2fbad1b75857693">t_walkc</a> = <a class="code" href="namespacepepcb.html#354c316e8d79b5bed2fbad1b75857693">t_walkc</a> + tfetch  ! multipole swaps
<a name="l00246"></a>00246 
<a name="l00247"></a>00247      !POMP$ INST BEGIN(force)
<a name="l00248"></a>00248      call cputime(t2)   ! timing
<a name="l00249"></a>00249      do i = 1, nps
<a name="l00250"></a>00250 
<a name="l00251"></a>00251         p = pshortlist(i)    ! local particle index
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         ! zero field sums
<a name="l00254"></a>00254         <a class="code" href="namespacetreevars.html#965b464677536c91c1aa7d309b77487f">Ex</a>(p) = 0.
<a name="l00255"></a>00255         <a class="code" href="namespacetreevars.html#eb08655fc8ee445e48c5c52cb334a4a3">Ey</a>(p) = 0.
<a name="l00256"></a>00256         <a class="code" href="namespacetreevars.html#5a7f29cfd6e9c687628d324991fecf3a">Ez</a>(p) = 0.
<a name="l00257"></a>00257         <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>(p) = 0.
<a name="l00258"></a>00258         <a class="code" href="namespacetreevars.html#23ddfaf21eda623491dd23e0b5c6c2ee">Axo</a>(p) = <a class="code" href="namespacetreevars.html#f8fc5bb4d3d3cf05020bdb2d2e095ad8">Ax</a>(p)
<a name="l00259"></a>00259         <a class="code" href="namespacetreevars.html#1cdc5c7c6318f7b25c2429860b80a139">Ayo</a>(p) = <a class="code" href="namespacetreevars.html#f73e774b9f50a0c067fa7f496e7a41b8">Ay</a>(p)
<a name="l00260"></a>00260         <a class="code" href="namespacetreevars.html#4bdc671a5212a433823a458430605d7a">Azo</a>(p) = <a class="code" href="namespacetreevars.html#171e408a911b6cd414ecccb4d15e3f6c">Az</a>(p)
<a name="l00261"></a>00261         <a class="code" href="namespacetreevars.html#f8fc5bb4d3d3cf05020bdb2d2e095ad8">Ax</a>(p) = 0.
<a name="l00262"></a>00262         <a class="code" href="namespacetreevars.html#f73e774b9f50a0c067fa7f496e7a41b8">Ay</a>(p) = 0.
<a name="l00263"></a>00263         <a class="code" href="namespacetreevars.html#171e408a911b6cd414ecccb4d15e3f6c">Az</a>(p) = 0.
<a name="l00264"></a>00264         <a class="code" href="namespacetreevars.html#e97659a717b3512a29ee1233e020d171">Bx</a>(p) = 0.
<a name="l00265"></a>00265         <a class="code" href="namespacetreevars.html#79119f2404cff6869a7d60fe52fff85e">By</a>(p) = 0.
<a name="l00266"></a>00266         <a class="code" href="namespacetreevars.html#9f10ba6e593eb3c9bd1a9988b4e11943">Bz</a>(p) = 0.
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         if (<a class="code" href="namelist_8h.html#6a7aa3e1d13373bb9ff0af7298c58c7d">coulomb</a>) then
<a name="l00269"></a>00269            !  compute Coulomb fields and potential of particle p from its interaction list
<a name="l00270"></a>00270            call <a class="code" href="sum__force_8f90.html#e63caebbd96a0eb2def083dfd8a1b5f3">sum_force</a>(p, <a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i), <a class="code" href="namespacetreevars.html#038c4e890b46de1d1dce97658d24652c">nodelist</a>( 1:<a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i),i), <a class="code" href="namelist_8h.html#3d5b0f2d79621403cfab74bce3469eb1">eps</a>, ex_coul, ey_coul, ez_coul, phi_coul, <a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a>(p))
<a name="l00271"></a>00271 !           call <a class="code" href="sum__force__split_8f90.html#73a104430e455f12f303692a54dacd7b">sum_force_split</a>(p, <a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i), <a class="code" href="namespacetreevars.html#038c4e890b46de1d1dce97658d24652c">nodelist</a>( 1:<a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i),i), <a class="code" href="namelist_8h.html#3d5b0f2d79621403cfab74bce3469eb1">eps</a>, ex_coul, ey_coul, ez_coul, phi_coul, <a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a>(p))
<a name="l00272"></a>00272 
<a name="l00273"></a>00273            <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>(p) = <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>(p) + <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * phi_coul
<a name="l00274"></a>00274            <a class="code" href="namespacetreevars.html#965b464677536c91c1aa7d309b77487f">Ex</a>(p) = <a class="code" href="namespacetreevars.html#965b464677536c91c1aa7d309b77487f">Ex</a>(p) + <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * ex_coul
<a name="l00275"></a>00275            <a class="code" href="namespacetreevars.html#eb08655fc8ee445e48c5c52cb334a4a3">Ey</a>(p) = <a class="code" href="namespacetreevars.html#eb08655fc8ee445e48c5c52cb334a4a3">Ey</a>(p) + <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * ey_coul
<a name="l00276"></a>00276            <a class="code" href="namespacetreevars.html#5a7f29cfd6e9c687628d324991fecf3a">Ez</a>(p) = <a class="code" href="namespacetreevars.html#5a7f29cfd6e9c687628d324991fecf3a">Ez</a>(p) + <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * ez_coul
<a name="l00277"></a>00277         endif
<a name="l00278"></a>00278 
<a name="l00279"></a>00279         if (bfield_on) then
<a name="l00280"></a>00280            !  compute magnetic fields and vector potential 
<a name="l00281"></a>00281            call <a class="code" href="sum__bfield_8f90.html#f7ca88a41624d6ee9c347969fef62811">sum_bfield</a>(p, <a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i), <a class="code" href="namespacetreevars.html#038c4e890b46de1d1dce97658d24652c">nodelist</a>( 1:<a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i),i), <a class="code" href="namelist_8h.html#3d5b0f2d79621403cfab74bce3469eb1">eps</a>, bx_ind, by_ind, bz_ind, ax_ind, ay_ind, az_ind )
<a name="l00282"></a>00282 
<a name="l00283"></a>00283            <a class="code" href="namespacetreevars.html#f8fc5bb4d3d3cf05020bdb2d2e095ad8">Ax</a>(p) =  <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * ax_ind
<a name="l00284"></a>00284            <a class="code" href="namespacetreevars.html#f73e774b9f50a0c067fa7f496e7a41b8">Ay</a>(p) =  <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * ay_ind
<a name="l00285"></a>00285            <a class="code" href="namespacetreevars.html#171e408a911b6cd414ecccb4d15e3f6c">Az</a>(p) =  <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * az_ind
<a name="l00286"></a>00286            <a class="code" href="namespacetreevars.html#e97659a717b3512a29ee1233e020d171">Bx</a>(p) =  <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * bx_ind
<a name="l00287"></a>00287            <a class="code" href="namespacetreevars.html#79119f2404cff6869a7d60fe52fff85e">By</a>(p) =  <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * by_ind
<a name="l00288"></a>00288            <a class="code" href="namespacetreevars.html#9f10ba6e593eb3c9bd1a9988b4e11943">Bz</a>(p) =  <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a> * bz_ind
<a name="l00289"></a>00289         endif
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         if (<a class="code" href="namelist_8h.html#6a7aa3e1d13373bb9ff0af7298c58c7d">coulomb</a> .and. bfield_on) then
<a name="l00292"></a>00292            ! Adjust E-field with inductive term if ES fields on
<a name="l00293"></a>00293            <a class="code" href="namespacetreevars.html#965b464677536c91c1aa7d309b77487f">Ex</a>(p) = <a class="code" href="namespacetreevars.html#965b464677536c91c1aa7d309b77487f">Ex</a>(p) - (<a class="code" href="namespacetreevars.html#f8fc5bb4d3d3cf05020bdb2d2e095ad8">Ax</a>(p)-<a class="code" href="namespacetreevars.html#23ddfaf21eda623491dd23e0b5c6c2ee">Axo</a>(p))/delta_t
<a name="l00294"></a>00294            <a class="code" href="namespacetreevars.html#eb08655fc8ee445e48c5c52cb334a4a3">Ey</a>(p) = <a class="code" href="namespacetreevars.html#eb08655fc8ee445e48c5c52cb334a4a3">Ey</a>(p) - (<a class="code" href="namespacetreevars.html#f73e774b9f50a0c067fa7f496e7a41b8">Ay</a>(p)-<a class="code" href="namespacetreevars.html#1cdc5c7c6318f7b25c2429860b80a139">Ayo</a>(p))/delta_t
<a name="l00295"></a>00295            <a class="code" href="namespacetreevars.html#5a7f29cfd6e9c687628d324991fecf3a">Ez</a>(p) = <a class="code" href="namespacetreevars.html#5a7f29cfd6e9c687628d324991fecf3a">Ez</a>(p) - (<a class="code" href="namespacetreevars.html#171e408a911b6cd414ecccb4d15e3f6c">Az</a>(p)-<a class="code" href="namespacetreevars.html#4bdc671a5212a433823a458430605d7a">Azo</a>(p))/delta_t
<a name="l00296"></a>00296         endif
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         if (<a class="code" href="namelist_8h.html#9d40dc6c3d4a4647d1d325ae1cff8b13">bonds</a>) then
<a name="l00299"></a>00299            !  compute short-range forces and potential of particle p from its interaction list
<a name="l00300"></a>00300            !          call <a class="code" href="sum__bond_8f90.html#d833c92ad5091e6a352a4939230960b4">sum_bond</a>(p, <a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i), <a class="code" href="namespacetreevars.html#038c4e890b46de1d1dce97658d24652c">nodelist</a>( 1:<a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i),i ), fsx, fsy, fsz, phi )
<a name="l00301"></a>00301 
<a name="l00302"></a>00302            !          <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>(p) = <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>(p) + <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a> * phi
<a name="l00303"></a>00303            !          fx(p) = fx(p) + <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a> * fsx
<a name="l00304"></a>00304            !          fy(p) = fy(p) + <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a> * fsy
<a name="l00305"></a>00305            !          fz(p) = fz(p) + <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a> * fsz
<a name="l00306"></a>00306         endif
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         if (<a class="code" href="namelist_8h.html#b04556176d1d031f4d99b6fe86e69bcf">lenjones</a>) then
<a name="l00309"></a>00309            !  compute short-range Lennard-Jones forces and potential of particle p from its interaction list
<a name="l00310"></a>00310            call <a class="code" href="sum__lennardjones_8f90.html#facc0b6a55bc8983258fa50b29a38183">sum_lennardjones</a>(p, <a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i), <a class="code" href="namespacetreevars.html#038c4e890b46de1d1dce97658d24652c">nodelist</a>( 1:<a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i),i ), <a class="code" href="namelist_8h.html#3d5b0f2d79621403cfab74bce3469eb1">eps</a>, fsx, fsy, fsz, phi )
<a name="l00311"></a>00311            fljmax=max(fljmax,sqrt(fsx**2+fsy**2+fsz**2))
<a name="l00312"></a>00312            <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>(p) = <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>(p) + <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a> * phi
<a name="l00313"></a>00313            <a class="code" href="namespacetreevars.html#965b464677536c91c1aa7d309b77487f">Ex</a>(p) = <a class="code" href="namespacetreevars.html#965b464677536c91c1aa7d309b77487f">Ex</a>(p) + <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a> * fsx
<a name="l00314"></a>00314            <a class="code" href="namespacetreevars.html#eb08655fc8ee445e48c5c52cb334a4a3">Ey</a>(p) = <a class="code" href="namespacetreevars.html#eb08655fc8ee445e48c5c52cb334a4a3">Ey</a>(p) + <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a> * fsy
<a name="l00315"></a>00315            <a class="code" href="namespacetreevars.html#5a7f29cfd6e9c687628d324991fecf3a">Ez</a>(p) = <a class="code" href="namespacetreevars.html#5a7f29cfd6e9c687628d324991fecf3a">Ez</a>(p) + <a class="code" href="namelist_8h.html#3f444f68368f046dc73b987aaeb74aef">bond_const</a> * fsz
<a name="l00316"></a>00316         endif
<a name="l00317"></a>00317         
<a name="l00318"></a>00318         <a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a>(p) = <a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i)        ! Should really compute this in <a class="code" href="sum__force_8f90.html#e63caebbd96a0eb2def083dfd8a1b5f3">sum_force</a> to allow for leaf/twig terms
<a name="l00319"></a>00319         <a class="code" href="namespacetreevars.html#6ccbebd32d635e79b3f80fff71840543">work_local</a> = <a class="code" href="namespacetreevars.html#6ccbebd32d635e79b3f80fff71840543">work_local</a>+<a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(i)
<a name="l00320"></a>00320      end do
<a name="l00321"></a>00321 
<a name="l00322"></a>00322      call cputime(t3)   ! timing
<a name="l00323"></a>00323      !POMP$ INST END(force)
<a name="l00324"></a>00324 
<a name="l00325"></a>00325      <a class="code" href="namespacepepcb.html#093e44b1de57a8447c7541822b2a62c9">t_force</a> = <a class="code" href="namespacepepcb.html#093e44b1de57a8447c7541822b2a62c9">t_force</a> + t3-t2
<a name="l00326"></a>00326 
<a name="l00327"></a>00327      max_local = max( max_local,maxval(<a class="code" href="namespacetreevars.html#0c00c9ba3fcb9b5b155b47f4a1df1011">nterm</a>(1:nps)) )  ! Max length of interaction list
<a name="l00328"></a>00328 
<a name="l00329"></a>00329   end do
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 
<a name="l00332"></a>00332   !  timestamp = <a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a> + <a class="code" href="namespacephysvars.html#35b069b237be060c93579f29eb66a91d">itime_start</a>
<a name="l00333"></a>00333   timestamp = <a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>
<a name="l00334"></a>00334   if (mod(<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>,<a class="code" href="namelist_8h.html#e3f41688c55ecf61f14ee189d036a104">iprot</a>)==0) then
<a name="l00335"></a>00335      call MPI_ALLREDUCE(max_local, <a class="code" href="namespacetreevars.html#eedff4d85b564024fa75dda1a3aceb78">max_list_length</a>, 1, MPI_INTEGER, MPI_MAX,  MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a> )
<a name="l00336"></a>00336      call MPI_GATHER(<a class="code" href="namespacetreevars.html#6ccbebd32d635e79b3f80fff71840543">work_local</a>, 1, MPI_REAL, <a class="code" href="namespacetreevars.html#8966cacd9f750c25bb4d0a8980f4c63c">work_loads</a>, 1, MPI_REAL, 0,  MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a> )  ! Gather <a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a> integrals
<a name="l00337"></a>00337      call MPI_GATHER(<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>, 1, MPI_INTEGER, <a class="code" href="namespacetreevars.html#b1cd8806a298cde8bb9f8197ae7eb23c">npps</a>, 1, MPI_INTEGER, 0,  MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a> )  ! Gather particle distn
<a name="l00338"></a>00338      <a class="code" href="namespacetreevars.html#037f0ca40826a460afc88f31014fde6d">part_imbal_max</a> = MAXVAL(<a class="code" href="namespacetreevars.html#b1cd8806a298cde8bb9f8197ae7eb23c">npps</a>) 
<a name="l00339"></a>00339      <a class="code" href="namespacetreevars.html#a5ac7398debd6e725cb5c598634c9847">part_imbal_min</a> = MINVAL(<a class="code" href="namespacetreevars.html#b1cd8806a298cde8bb9f8197ae7eb23c">npps</a>)
<a name="l00340"></a>00340      <a class="code" href="namespacetreevars.html#1c6f6ce6c7237fbdefef8c4744d82536">part_imbal</a> = (<a class="code" href="namespacetreevars.html#037f0ca40826a460afc88f31014fde6d">part_imbal_max</a>-<a class="code" href="namespacetreevars.html#a5ac7398debd6e725cb5c598634c9847">part_imbal_min</a>)/1.0/<a class="code" href="namespacetreevars.html#ac21a2dc42e5595e66cba603534873bd">npart</a>*<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>      
<a name="l00341"></a>00341      total_work = SUM(<a class="code" href="namespacetreevars.html#8966cacd9f750c25bb4d0a8980f4c63c">work_loads</a>)
<a name="l00342"></a>00342      average_work = total_work/<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>
<a name="l00343"></a>00343      <a class="code" href="namespacetreevars.html#5e9d6d6bc5fa5b4ba685e8d09ddfdb21">work_imbal_max</a> = MAXVAL(<a class="code" href="namespacetreevars.html#8966cacd9f750c25bb4d0a8980f4c63c">work_loads</a>)/average_work
<a name="l00344"></a>00344      <a class="code" href="namespacetreevars.html#d77dd3f319d1220bdae713de6ee6e9a9">work_imbal_min</a> = MINVAL(<a class="code" href="namespacetreevars.html#8966cacd9f750c25bb4d0a8980f4c63c">work_loads</a>)/average_work
<a name="l00345"></a>00345      <a class="code" href="namespacetreevars.html#5254afbd41f37f9199feb0ef874da549">work_imbal</a> = 0.
<a name="l00346"></a>00346      do i=1,<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>
<a name="l00347"></a>00347         <a class="code" href="namespacetreevars.html#5254afbd41f37f9199feb0ef874da549">work_imbal</a> = <a class="code" href="namespacetreevars.html#5254afbd41f37f9199feb0ef874da549">work_imbal</a> + abs(<a class="code" href="namespacetreevars.html#8966cacd9f750c25bb4d0a8980f4c63c">work_loads</a>(i) - average_work)/average_work/<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>
<a name="l00348"></a>00348      end do
<a name="l00349"></a>00349      if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a> ==0 ) then
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         cme = achar(timestamp/1000+48) <span class="comment">// achar(mod(timestamp/100,10)+48) &amp;</span>
<a name="l00352"></a>00352              <span class="comment">// achar(mod(timestamp/10,10)+48) // achar(mod(timestamp,10)+48) </span>
<a name="l00353"></a>00353         cfile=<span class="stringliteral">"log/load_"</span><span class="comment">//cme//".dat"</span>
<a name="l00354"></a>00354         total_parts=SUM(<a class="code" href="namespacetreevars.html#b1cd8806a298cde8bb9f8197ae7eb23c">npps</a>)
<a name="l00355"></a>00355         open(60, file=cfile)
<a name="l00356"></a>00356         write(60,'(a/a,i8,2(a,1pe15.6))')  '! Full balancing','Parts: ',total_parts,' Work: ',total_work, &amp;
<a name="l00357"></a>00357              ' Ave. <a class="code" href="namespacetreevars.html#d1a1c1c00c2c454aaa4f00071b9f5d63">work</a>:',average_work        
<a name="l00358"></a>00358         write(60,'(2i8,f12.3)')  (i-1,<a class="code" href="namespacetreevars.html#b1cd8806a298cde8bb9f8197ae7eb23c">npps</a>(i),<a class="code" href="namespacetreevars.html#8966cacd9f750c25bb4d0a8980f4c63c">work_loads</a>(i)/average_work,i=1,<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>)
<a name="l00359"></a>00359         close(60)
<a name="l00360"></a>00360      endif
<a name="l00361"></a>00361   endif
<a name="l00362"></a>00362 
<a name="l00363"></a>00363   if (<a class="code" href="namelist_8h.html#b04556176d1d031f4d99b6fe86e69bcf">lenjones</a>) then
<a name="l00364"></a>00364         write(*,*) 'Max force: ',fljmax
<a name="l00365"></a>00365   endif
<a name="l00366"></a>00366   if (<a class="code" href="namespacetreevars.html#001505bba4c1517aa171fe7a61bc3c9c">force_debug</a>) then
<a name="l00367"></a>00367 !     if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,101) <a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a>
<a name="l00368"></a>00368      write (<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,101) 'LPEPC | Tree forces:','   p    <a class="code" href="namespacetreevars.html#b9d8e8e7c77d33688592fb8fc698342f">q</a>   <a class="code" href="namespacetreevars.html#6c12d2901c45a88c6f838e61074b3577">m</a>   <a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>   <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>  ',<a class="code" href="namelist_8h.html#59437d0609d7fe3a3500ed3e7ec47eb6">force_const</a>
<a name="l00369"></a>00369 
<a name="l00370"></a>00370      do i=1,<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>
<a name="l00371"></a>00371         write (<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,102) <a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i), &amp; 
<a name="l00372"></a>00372              <a class="code" href="namespacetreevars.html#b9d8e8e7c77d33688592fb8fc698342f">q</a>(i), <a class="code" href="namespacetreevars.html#6c12d2901c45a88c6f838e61074b3577">m</a>(i), <a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>(i), <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>(i), ex(i)
<a name="l00373"></a>00373         !        if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write (*,102) <a class="code" href="namespacetreevars.html#745c67b70193cf25d51284647d7731d6">pelabel</a>(i), <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(i), &amp; 
<a name="l00374"></a>00374         !             <a class="code" href="namespacetreevars.html#b9d8e8e7c77d33688592fb8fc698342f">q</a>(i), <a class="code" href="namespacetreevars.html#6c12d2901c45a88c6f838e61074b3577">m</a>(i), <a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>(i), <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>(i)
<a name="l00375"></a>00375      end do
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 101  format(a/a,f8.2)
<a name="l00378"></a>00378 102  format(1<a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>,i7,5(1pe14.5))
<a name="l00379"></a>00379 
<a name="l00380"></a>00380   endif
<a name="l00381"></a>00381 
<a name="l00382"></a>00382   <a class="code" href="namespacephysvars.html#f198eb2b475070e5cbc103bdfae9d16a">np_local</a> = <a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>   ! reset local # particles for calling routine
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 end subroutine <a class="code" href="fields__p_8f90.html#8345869654c79bbbbcd720e779026912">pepc_fields_p</a>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 23 16:02:49 2007 for PEPC by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7-20060810 </small></address>
</body>
</html>
