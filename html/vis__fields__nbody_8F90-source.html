<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PEPC: vis_fields_nbody.F90 Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7-20060810 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_75b82e7e4a5feb05200b9ad7adf06257.html">home</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_28272fc65e3d756317163f9acb2ad644.html">gibbon</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e3e416c1e3f7ebc92335d37fb0dd4777.html">pepc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_991097dbe07e9883c0a11fa77543783e.html">pepc-b</a></div>
<h1>vis_fields_nbody.F90</h1><a href="vis__fields__nbody_8F90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 ! ======================
<a name="l00002"></a>00002 !
<a name="l00003"></a>00003 !   VIS_FIELDS
<a name="l00004"></a>00004 !
<a name="l00005"></a>00005 !   Send field data to VISIT <span class="keywordflow">for</span> visualisation of scalar volumetric data
<a name="l00006"></a>00006 !
<a name="l00007"></a>00007 !
<a name="l00008"></a>00008 ! ======================
<a name="l00009"></a>00009 
<a name="l00010"></a><a class="code" href="vis__fields__nbody_8F90.html#b47dc6f9ae95f330275c117627b0b4fd">00010</a> subroutine <a class="code" href="vis__fields__nbody_8F90.html#b47dc6f9ae95f330275c117627b0b4fd">vis_fields_nbody</a>(timestamp)
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 
<a name="l00013"></a>00013   use physvars
<a name="l00014"></a>00014   use treevars
<a name="l00015"></a>00015   implicit none   
<a name="l00016"></a>00016   include 'mpif.h'
<a name="l00017"></a>00017 
<a name="l00018"></a>00018   real*4, dimension(<a class="code" href="namelist_8h.html#273d3bff8b18ec89e78a20f7428c0d91">ngx</a>*<a class="code" href="namelist_8h.html#8882200f4d32762fb9a07ef67dcc9507">ngy</a>*<a class="code" href="namelist_8h.html#25424c1a15fb43612baeb74b653c7f58">ngz</a>) :: field1, field2, field3, field4
<a name="l00019"></a>00019   real*4, dimension(<a class="code" href="namelist_8h.html#273d3bff8b18ec89e78a20f7428c0d91">ngx</a>,<a class="code" href="namelist_8h.html#8882200f4d32762fb9a07ef67dcc9507">ngy</a>,<a class="code" href="namelist_8h.html#25424c1a15fb43612baeb74b653c7f58">ngz</a>) :: bzg, rhoeg, rhoig, Telec, Tion, ggelec,ggion
<a name="l00020"></a>00020   real, dimension(0:ngx+1) :: te_slice 
<a name="l00021"></a>00021   real :: s, simtime, dummy, xd,yd,zd, dx, dz, dy, epond_max
<a name="l00022"></a>00022   real :: box_max, az_em, ez_em, by_em, bx_em, bz_em, ex_em, ey_em, phipond
<a name="l00023"></a>00023   real :: epon_x, epon_y, epon_z, tpon, amp_las, field_laser
<a name="l00024"></a>00024   integer, parameter :: ngmax=100
<a name="l00025"></a>00025   integer :: i, j, k, ioffset,ixd, iyd, izd, ilev, lcount, iskip,itlas
<a name="l00026"></a>00026   integer, intent(in) :: timestamp
<a name="l00027"></a>00027   integer :: <a class="code" href="namespacepepcb.html#d94b9000718e7d94a84804d2856bb7b6">lvisit_active</a>, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a> 
<a name="l00028"></a>00028   integer :: npx, npy, npz, ng, jfoc, kfoc, nave
<a name="l00029"></a>00029   real :: norm
<a name="l00030"></a>00030   integer :: iskip_x, iskip_y, iskip_z
<a name="l00031"></a>00031   integer :: fselect1=0,fselect2=0,fselect3=0,fselect4=0
<a name="l00032"></a>00032   integer :: <a class="code" href="namespacepepcb.html#92852f7d9b66e2e12b69b68bd62c1b1f">incdf</a>
<a name="l00033"></a>00033   real*4 :: grid_pars(24)  ! origins and mesh sizes of vis fields
<a name="l00034"></a>00034   character(30) :: cfile
<a name="l00035"></a>00035   character(5) :: cme
<a name="l00036"></a>00036   character(6) :: cdump, cvis
<a name="l00037"></a>00037 
<a name="l00038"></a>00038   simtime = <a class="code" href="namelist_8h.html#a3753cec73bb5fd57684e7692a606f05">dt</a>*(<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>+<a class="code" href="namespacephysvars.html#35b069b237be060c93579f29eb66a91d">itime_start</a>)
<a name="l00039"></a>00039   amp_las = <a class="code" href="namelist_8h.html#0d0a3b5745c1c49963b9113d6a59b86a">vosc</a>*min(1.,simtime/<a class="code" href="namelist_8h.html#bfa2c98ab379465701e70b7c1493368e">tpulse</a>)
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#ifdef VISIT_NBODY</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0)   call flvisit_nbody2_check_connection(lvisit_active)
<a name="l00043"></a>00043   call MPI_BCAST( lvisit_active, 1, MPI_INTEGER, 0, MPI_COMM_WORLD,<a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)
<a name="l00044"></a>00044 <span class="preprocessor">#endif</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046   <span class="keywordflow">if</span> (lvisit_active==0 )then
<a name="l00047"></a>00047      <span class="keywordflow">if</span> (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) write(*,*) 'VIS_NBODY | No connection to visualization'
<a name="l00048"></a>00048   endif
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 ! Connected to vis, so proceed with field select &amp; gather
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#ifdef VISIT_NBODY</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>! Fetch user-selected config from vis
<a name="l00054"></a>00054   <span class="keywordflow">if</span> (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0 .and. lvisit_active.ne.0) then
<a name="l00055"></a>00055         call flvisit_nbody2_selectfields_recv(fselect1,fselect2,fselect3,fselect4)
<a name="l00056"></a>00056         write(*,*) 'Selection:',fselect1,fselect2,fselect3,fselect4
<a name="l00057"></a>00057 ! Override selection 
<a name="l00058"></a>00058 !       fselect1=1
<a name="l00059"></a>00059 !       fselect2=4
<a name="l00060"></a>00060 !       fselect3=5
<a name="l00061"></a>00061 !       fselect4=0
<a name="l00062"></a>00062 
<a name="l00063"></a>00063   endif
<a name="l00064"></a>00064 <span class="preprocessor">#endif</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066   ! get filename suffix from <a class="code" href="dump_8f90.html#88b597631f796e2b06c577e64bd94fe9">dump</a> counter
<a name="l00067"></a>00067   <span class="keywordflow">do</span> i=0,4
<a name="l00068"></a>00068      cdump(6-i:6-i) =  achar(mod(timestamp/10**i,10) + 48)  
<a name="l00069"></a>00069   end do
<a name="l00070"></a>00070   cdump(1:1) = achar(timestamp/10**5 + 48)
<a name="l00071"></a>00071 
<a name="l00072"></a>00072   ng = ngx*ngy*<a class="code" href="namelist_8h.html#25424c1a15fb43612baeb74b653c7f58">ngz</a>                         ! total <span class="preprocessor"># gridpoints</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>  ! Merge sums <span class="keywordflow">for</span> gridded fields 
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 !  call MPI_ALLREDUCE(<a class="code" href="namespacephysvars.html#89b6b00973c2f1d2e2848ff550945686">bz_loc</a>(1:ngx,1:ngy,1:<a class="code" href="namelist_8h.html#25424c1a15fb43612baeb74b653c7f58">ngz</a>), bzg, ng, MPI_REAL, MPI_SUM, MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)
<a name="l00076"></a>00076   call MPI_ALLREDUCE(<a class="code" href="namespacephysvars.html#ae4aa37acdf89c9a125d3f49378ad1a7">rhoe_loc</a>(1:ngx,1:ngy,1:<a class="code" href="namelist_8h.html#25424c1a15fb43612baeb74b653c7f58">ngz</a>), rhoeg, ng, MPI_REAL, MPI_SUM, MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)
<a name="l00077"></a>00077   call MPI_ALLREDUCE(<a class="code" href="namespacephysvars.html#5c6d6671f234daf211e86960d22511ec">rhoi_loc</a>(1:ngx,1:ngy,1:ngz), rhoig, ng, MPI_REAL, MPI_SUM, MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)
<a name="l00078"></a>00078   call MPI_ALLREDUCE(<a class="code" href="namespacephysvars.html#a70d74e55eaabb298c7b170e694e7575">Te_loc</a>(1:ngx,1:ngy,1:ngz), Telec, ng, MPI_REAL, MPI_SUM, MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)
<a name="l00079"></a>00079   call MPI_ALLREDUCE(<a class="code" href="namespacephysvars.html#7d4354b5c0426fcbe5bc1500e0da45b2">Ti_loc</a>(1:ngx,1:ngy,1:ngz), Tion, ng, MPI_REAL, MPI_SUM, MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)
<a name="l00080"></a>00080   call MPI_ALLREDUCE(<a class="code" href="namespacephysvars.html#e1d7acbcbc2f76563f55de6fc2e20712">g_ele</a>(1:ngx,1:ngy,1:ngz), ggelec, ng, MPI_REAL, MPI_SUM, MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)
<a name="l00081"></a>00081   call MPI_ALLREDUCE(<a class="code" href="namespacephysvars.html#18510feefd5a32366d2a872a9d9849d7">g_ion</a>(1:ngx,1:ngy,1:ngz), ggion, ng, MPI_REAL, MPI_SUM, MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 ! Normalise temperatures &amp; convert to keV
<a name="l00084"></a>00084   Telec = 2./3.*Telec/ggelec
<a name="l00085"></a>00085 !  Tion = 2./3.*Tion/ggion
<a name="l00086"></a>00086 
<a name="l00087"></a>00087   if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0 ) then
<a name="l00088"></a>00088 
<a name="l00089"></a>00089      box_max = <a class="code" href="namelist_8h.html#b8c12579d5380e3cd3777e1c2a43d242">xl</a>/25.
<a name="l00090"></a>00090      epond_max = sqrt(1.+<a class="code" href="namelist_8h.html#0d0a3b5745c1c49963b9113d6a59b86a">vosc</a>**2/2.)/2.
<a name="l00091"></a>00091      lcount=0
<a name="l00092"></a>00092 
<a name="l00093"></a>00093      ! limit size of field data to 100^3
<a name="l00094"></a>00094      !     iskip_x = ngx/ngmax + 1
<a name="l00095"></a>00095      !     iskip_y = ngy/ngmax + 1
<a name="l00096"></a>00096      !     iskip_z = ngz/ngmax + 1
<a name="l00097"></a>00097      iskip_x = 1
<a name="l00098"></a>00098      iskip_y = 1
<a name="l00099"></a>00099      iskip_z = 1
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 
<a name="l00102"></a>00102      !     npx = ngx/iskip_x + mod(ngx,2)
<a name="l00103"></a>00103      !     npy = ngy/iskip_y + mod(ngy,2)
<a name="l00104"></a>00104      !     npz = ngz/iskip_z + mod(ngz,2)
<a name="l00105"></a>00105      npx = ngx
<a name="l00106"></a>00106      npy = ngy
<a name="l00107"></a>00107      npz = ngz
<a name="l00108"></a>00108 
<a name="l00109"></a>00109   !   xl_laser = <a class="code" href="namelist_8h.html#a729632262bf53dac77d4fbe3047cb44">focus</a>(1) + <a class="code" href="namelist_8h.html#12ab60c2ad9358d336db6643fd3460ba">x_plasma</a>/2. ! Reduced box size for <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a>
<a name="l00110"></a>00110      dx = <a class="code" href="namelist_8h.html#b8c12579d5380e3cd3777e1c2a43d242">xl</a>/ngx
<a name="l00111"></a>00111      dz = <a class="code" href="namelist_8h.html#6fd88682b343fc37fa3c1e56f0c3a194">zl</a>/ngz
<a name="l00112"></a>00112      dy = <a class="code" href="namelist_8h.html#920848accbcb0bcb52d1d0d8c31eda24">yl</a>/ngy
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   if (<a class="code" href="namespacephysvars.html#c125a4e0d163ae9c82706249ee8ddee4">itime</a>&gt;0 .and. <a class="code" href="namespacephysvars.html#1ff60eac6a083e1ac61c674793e352cc">beam_config</a>==4) <a class="code" href="namelist_8h.html#a729632262bf53dac77d4fbe3047cb44">focus</a>(1) = <a class="code" href="namespacephysvars.html#7886d53aa63c7c662c0f79e0be6b848a">x_crit</a>  ! <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a> tracks n_c
<a name="l00115"></a>00115      do k=1,ngz,iskip_z
<a name="l00116"></a>00116         do j=1,ngy,iskip_y
<a name="l00117"></a>00117            do i=1,ngx,iskip_x
<a name="l00118"></a>00118               lcount=lcount+1
<a name="l00119"></a>00119               xd = (i-0.5)*dx - <a class="code" href="namelist_8h.html#a729632262bf53dac77d4fbe3047cb44">focus</a>(1) ! position relative to <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a> <a class="code" href="namelist_8h.html#a729632262bf53dac77d4fbe3047cb44">focus</a>
<a name="l00120"></a>00120               yd = (j-0.5)*dy - <a class="code" href="namelist_8h.html#a729632262bf53dac77d4fbe3047cb44">focus</a>(2)
<a name="l00121"></a>00121               zd = (k-0.5)*dz - <a class="code" href="namelist_8h.html#a729632262bf53dac77d4fbe3047cb44">focus</a>(3)
<a name="l00122"></a>00122 !              xd = (i-0.5)*dx - 50.
<a name="l00123"></a>00123 
<a name="l00124"></a>00124               <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a>: select case(<a class="code" href="namelist_8h.html#9cd066e24ff6c31a0773858ce2a93967">beam_config_in</a>)
<a name="l00125"></a>00125 
<a name="l00126"></a>00126               case(4)
<a name="l00127"></a>00127                  call <a class="code" href="fpond_8f90.html#a80cd37d1a499a771ba9d1e6582b1332">fpond</a>( 1.57/<a class="code" href="namelist_8h.html#630bc314dbc10cc6306033525170d456">omega</a>, <a class="code" href="namelist_8h.html#bfa2c98ab379465701e70b7c1493368e">tpulse</a>,<a class="code" href="namelist_8h.html#9b4649da6f2640c94a4a055ce84a75ac">sigma</a>,<a class="code" href="namelist_8h.html#0d0a3b5745c1c49963b9113d6a59b86a">vosc</a>,omega, <a class="code" href="namespacephysvars.html#5c81c11b7c1e32c9646c0ad37c7fdb41">rho_upper</a>, &amp;
<a name="l00128"></a>00128                       xd,yd,zd,epon_x,epon_y,epon_z,phipond)
<a name="l00129"></a>00129                  <a class="code" href="namespacepepcb.html#d349f1131564bc1f8eb6e508d182636a">Tpon</a> = min(1.,<a class="code" href="namespacephysvars.html#ce7ee718a38bd3f477f9ac537f245cdc">tlaser</a>/tpulse) * (sin(omega*<a class="code" href="namespacephysvars.html#ce7ee718a38bd3f477f9ac537f245cdc">tlaser</a>))**2
<a name="l00130"></a>00130                  !                 mvis(lcount) = epon_x/omega ! Pond field, EM norm
<a name="l00131"></a>00131                  field_laser = phipond ! Pond potential
<a name="l00132"></a>00132 
<a name="l00133"></a>00133               case(14)  ! linear build-up
<a name="l00134"></a>00134                  call <a class="code" href="fpond__lin_8f90.html#8a210aafecc7fd6c01472e57e13c3721">fpond_lin</a>( <a class="code" href="namespacephysvars.html#ce7ee718a38bd3f477f9ac537f245cdc">tlaser</a>, tpulse,sigma,vosc,omega, rho_upper, &amp;
<a name="l00135"></a>00135                       xd,yd,zd,epon_x,epon_y,epon_z,phipond)
<a name="l00136"></a>00136 !                 <a class="code" href="namespacepepcb.html#d349f1131564bc1f8eb6e508d182636a">Tpon</a> = min(1.,tlaser/tpulse) * (sin(omega*tlaser))**2
<a name="l00137"></a>00137                  <a class="code" href="namespacepepcb.html#d349f1131564bc1f8eb6e508d182636a">Tpon</a> = min(1.,tlaser/tpulse) * sin(omega*tlaser-omega*xd)
<a name="l00138"></a>00138                  field_laser = phipond*<a class="code" href="namespacepepcb.html#d349f1131564bc1f8eb6e508d182636a">Tpon</a> ! Pond potential
<a name="l00139"></a>00139 
<a name="l00140"></a>00140               case(94)  ! standing wave <a class="code" href="fpond_8f90.html#a80cd37d1a499a771ba9d1e6582b1332">fpond</a> with transverse fields artificially reduced
<a name="l00141"></a>00141                  call <a class="code" href="fpond_8f90.html#a80cd37d1a499a771ba9d1e6582b1332">fpond</a>( tlaser, tpulse,sigma,vosc,omega,rho_upper, &amp;
<a name="l00142"></a>00142                  xd,yd,zd,epon_x,epon_y,epon_z,phipond)
<a name="l00143"></a>00143                  <a class="code" href="namespacepepcb.html#d349f1131564bc1f8eb6e508d182636a">Tpon</a> = min(1.,tlaser/tpulse) * (sin(omega*tlaser))**2
<a name="l00144"></a>00144                  field_laser = phipond*<a class="code" href="namespacepepcb.html#d349f1131564bc1f8eb6e508d182636a">Tpon</a> ! Pond potential
<a name="l00145"></a>00145 
<a name="l00146"></a>00146               case(5)  ! propagating <a class="code" href="fpond_8f90.html#a80cd37d1a499a771ba9d1e6582b1332">fpond</a>
<a name="l00147"></a>00147                  call <a class="code" href="laser__bullet_8f90.html#870eba9cb38baf8e898a0531823e1d7d">laser_bullet</a>( tlaser, <a class="code" href="namelist_8h.html#a729632262bf53dac77d4fbe3047cb44">focus</a>(1), tpulse,sigma,vosc,omega, &amp;
<a name="l00148"></a>00148                       xd,yd,zd,epon_x,epon_y,epon_z,phipond)
<a name="l00149"></a>00149                  field_laser = phipond ! Pond potential
<a name="l00150"></a>00150 
<a name="l00151"></a>00151               case(24) ! Oblique incidence <a class="code" href="fpond_8f90.html#a80cd37d1a499a771ba9d1e6582b1332">fpond</a>, s-pol
<a name="l00152"></a>00152                  call <a class="code" href="emoblique_8f90.html#5c186d7289349be438e7a7579f52e3df">emobliq</a>(tlaser,tpulse,sigma,vosc,omega,<a class="code" href="namelist_8h.html#17a2c7e0225d20f086d24e3325833387">theta_beam</a>, rho_upper, &amp;
<a name="l00153"></a>00153                       xd,yd,zd,epon_x,epon_y,epon_z,phipond,ez_em,bx_em,by_em)
<a name="l00154"></a>00154                  field_laser = ez_em**2
<a name="l00155"></a>00155 
<a name="l00156"></a>00156               case(6) ! Plane wave
<a name="l00157"></a>00157                  call <a class="code" href="emplane_8f90.html#0f830f0ddc8a8ffb23d5f1cf0c894240">emplane</a>(tlaser,tpulse,sigma,vosc,omega,xd,yd,zd,ez_em,by_em,bx_em,az_em,phipond)
<a name="l00158"></a>00158                  field_laser = by_em 
<a name="l00159"></a>00159 
<a name="l00160"></a>00160               case(16) ! plane wave with Gaussian spot, linear rise-time
<a name="l00161"></a>00161                  call <a class="code" href="emplane__lin_8f90.html#97bcae6a87d1aa6e554e2e58f126f61a">emplane_lin</a>(tlaser,tpulse,sigma,vosc,omega,xd,yd,zd,Epon_z,By_em,Bx_em,az_em,phipond)
<a name="l00162"></a>00162                  Epon_x=0.
<a name="l00163"></a>00163                  Epon_y=0.
<a name="l00164"></a>00164                  field_laser = by_em
<a name="l00165"></a>00165 
<a name="l00166"></a>00166               case default ! No <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a>
<a name="l00167"></a>00167                  phipond = 0  
<a name="l00168"></a>00168                  field_laser = 0.
<a name="l00169"></a>00169               end select <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a>
<a name="l00170"></a>00170 
<a name="l00171"></a>00171  ! Vis field selection
<a name="l00172"></a>00172               f1: select case(fselect1)
<a name="l00173"></a>00173               case(1)  ! ion density / nc 
<a name="l00174"></a>00174                 field1(lcount) = rhoig(i,j,k)/omega**2   
<a name="l00175"></a>00175               case(2)  ! electron density / nc 
<a name="l00176"></a>00176                 field1(lcount) = rhoeg(i,j,k)/omega**2 
<a name="l00177"></a>00177               case(3)  ! Ion temperature  / MeV 
<a name="l00178"></a>00178                 field1(lcount) = Tion(i,j,k) 
<a name="l00179"></a>00179               case(4)  ! Electron temperature  / MeV 
<a name="l00180"></a>00180                 field1(lcount) = Telec(i,j,k) 
<a name="l00181"></a>00181               case(5)  ! <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a> 
<a name="l00182"></a>00182                 field1(lcount) = field_laser 
<a name="l00183"></a>00183               case(0) 
<a name="l00184"></a>00184                 field1(lcount) = 0
<a name="l00185"></a>00185               end select f1
<a name="l00186"></a>00186 
<a name="l00187"></a>00187               f2: select case(fselect2)
<a name="l00188"></a>00188               case(1)  ! ion density / nc 
<a name="l00189"></a>00189                 field2(lcount) = rhoig(i,j,k)/omega**2   
<a name="l00190"></a>00190               case(2)  ! electron density / nc 
<a name="l00191"></a>00191                 field2(lcount) = rhoeg(i,j,k)/omega**2 
<a name="l00192"></a>00192               case(3)  ! Ion temperature  / MeV 
<a name="l00193"></a>00193                 field2(lcount) = Tion(i,j,k) 
<a name="l00194"></a>00194               case(4)  ! Electron temperature  / MeV 
<a name="l00195"></a>00195                 field2(lcount) = Telec(i,j,k) 
<a name="l00196"></a>00196               case(5)  ! <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a> 
<a name="l00197"></a>00197                 field2(lcount) = field_laser 
<a name="l00198"></a>00198               case(0)
<a name="l00199"></a>00199                 field2(lcount) = 0
<a name="l00200"></a>00200               end select f2
<a name="l00201"></a>00201 
<a name="l00202"></a>00202               f3: select case(fselect3)
<a name="l00203"></a>00203               case(1)  ! ion density / nc 
<a name="l00204"></a>00204                 field3(lcount) = rhoig(i,j,k)/omega**2   
<a name="l00205"></a>00205               case(2)  ! electron density / nc 
<a name="l00206"></a>00206                 field3(lcount) = rhoeg(i,j,k)/omega**2 
<a name="l00207"></a>00207               case(3)  ! Ion temperature  / MeV 
<a name="l00208"></a>00208                 field3(lcount) = Tion(i,j,k) 
<a name="l00209"></a>00209               case(4)  ! Electron temperature  / MeV 
<a name="l00210"></a>00210                 field3(lcount) = Telec(i,j,k) 
<a name="l00211"></a>00211               case(5)  ! <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a> 
<a name="l00212"></a>00212                 field3(lcount) = field_laser 
<a name="l00213"></a>00213               case(0)
<a name="l00214"></a>00214                 field3(lcount) = 0
<a name="l00215"></a>00215               end select f3
<a name="l00216"></a>00216 
<a name="l00217"></a>00217               f4: select case(fselect4)
<a name="l00218"></a>00218               case(1)  ! ion density / nc 
<a name="l00219"></a>00219                 field4(lcount) = rhoig(i,j,k)/omega**2   
<a name="l00220"></a>00220               case(2)  ! electron density / nc 
<a name="l00221"></a>00221                 field4(lcount) = rhoeg(i,j,k)/omega**2 
<a name="l00222"></a>00222               case(3)  ! Ion temperature  / MeV 
<a name="l00223"></a>00223                 field4(lcount) = Tion(i,j,k) 
<a name="l00224"></a>00224               case(4)  ! Electron temperature  / MeV 
<a name="l00225"></a>00225                 field4(lcount) = Telec(i,j,k) 
<a name="l00226"></a>00226               case(5)  ! <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a> 
<a name="l00227"></a>00227                 field4(lcount) = field_laser 
<a name="l00228"></a>00228               case(0)
<a name="l00229"></a>00229                 field4(lcount) = 0
<a name="l00230"></a>00230               end select f4
<a name="l00231"></a>00231            if (field1(lcount)&lt;0) then
<a name="l00232"></a>00232             write(*,*) 'field -ve ',field1(lcount),' at i=',i,' j=',j,' k=',k
<a name="l00233"></a>00233            endif
<a name="l00234"></a>00234            end do
<a name="l00235"></a>00235         end do
<a name="l00236"></a>00236      end do
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="preprocessor">#ifdef VISIT_NBODY</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span>        write(*,*) 'VIS  confirm field select'
<a name="l00241"></a>00241       call flvisit_nbody2_check_connection(lvisit_active)
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 ! Tell vis which fields are coming
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="keywordflow">if</span> (lvisit_active.ne.0) then
<a name="l00246"></a>00246          call flvisit_nbody2_selectedfields_send(fselect1,fselect2,fselect3,fselect4)
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="preprocessor">#ifdef NETCDFLIB</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span>! Netcdf write
<a name="l00250"></a>00250         write(*,*) 'VIS  confirm field select - <a class="code" href="namelist_8h.html#71ebc23cbdc8093503a82c51c71692ec">netcdf</a>'
<a name="l00251"></a>00251          <span class="keywordflow">if</span> (<a class="code" href="namelist_8h.html#71ebc23cbdc8093503a82c51c71692ec">netcdf</a>) call <a class="code" href="ncnbody_8c.html#1171eff6b07d9e6abf087f6b657df191">ncnbody_putselfield</a>( <a class="code" href="namespacephysvars.html#8aee7ef824e0b5887384003bfd4f65fc">ncid</a>, simtime, fselect1, fselect2, fselect3, fselect4, <a class="code" href="namespacepepcb.html#92852f7d9b66e2e12b69b68bd62c1b1f">incdf</a> )
<a name="l00252"></a>00252 <span class="preprocessor">#endif</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>
<a name="l00254"></a>00254 !  Set up vis field grid
<a name="l00255"></a>00255    <span class="keywordflow">do</span> i=0,3
<a name="l00256"></a>00256      grid_pars(6*i+1:6*i+3) = 0.
<a name="l00257"></a>00257      grid_pars(6*i+4) = dx
<a name="l00258"></a>00258      grid_pars(6*i+5) = dy
<a name="l00259"></a>00259      grid_pars(6*i+6) = dz
<a name="l00260"></a>00260    end <span class="keywordflow">do</span>
<a name="l00261"></a>00261 
<a name="l00262"></a>00262    call flvisit_nbody2_fielddesc_send(grid_pars,4,6)
<a name="l00263"></a>00263 <span class="preprocessor">#ifdef NETCDFLIB</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span>        write(*,*) 'VIS  grid-pars - <a class="code" href="namelist_8h.html#71ebc23cbdc8093503a82c51c71692ec">netcdf</a>'
<a name="l00265"></a>00265    <span class="keywordflow">if</span> (<a class="code" href="namelist_8h.html#71ebc23cbdc8093503a82c51c71692ec">netcdf</a>) call <a class="code" href="ncnbody_8c.html#d3283d4994cd46d48a19a17aa18d75b4">ncnbody_putfielddesc</a>( ncid, simtime, grid_pars, <a class="code" href="namespacepepcb.html#92852f7d9b66e2e12b69b68bd62c1b1f">incdf</a> )
<a name="l00266"></a>00266 <span class="preprocessor">#endif</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span>
<a name="l00268"></a>00268 !   write(*,*) 'Grids: ',grid_pars
<a name="l00269"></a>00269       <span class="keywordflow">if</span> (fselect1&gt;0) then
<a name="l00270"></a>00270          write (*,*) <span class="stringliteral">"VIS_NBODY | Shipping field 1: min/max ="</span>, &amp;
<a name="l00271"></a>00271         minval(field1),maxval(field1)
<a name="l00272"></a>00272          call flvisit_nbody2_field1_send(field1,npx,npy,npz)   
<a name="l00273"></a>00273 <span class="preprocessor">#ifdef NETCDFLIB</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span>         write (*,*) <span class="stringliteral">"VIS_NBODY | Writing field 1 to netcdf"</span>
<a name="l00275"></a>00275          <span class="keywordflow">if</span> (<a class="code" href="namelist_8h.html#71ebc23cbdc8093503a82c51c71692ec">netcdf</a>) call <a class="code" href="ncnbody_8c.html#e64321dfe68e9d84db2ed26c7dfccb13">ncnbody_putfield</a>( ncid, simtime, 1, npx, npy, npz, field1, <a class="code" href="namespacepepcb.html#92852f7d9b66e2e12b69b68bd62c1b1f">incdf</a> )
<a name="l00276"></a>00276 <span class="preprocessor">#endif</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span>      endif
<a name="l00278"></a>00278       <span class="keywordflow">if</span> (fselect2&gt;0) then
<a name="l00279"></a>00279          write (*,*) <span class="stringliteral">"VIS_NBODY | Shipping field 2"</span>
<a name="l00280"></a>00280          call flvisit_nbody2_field2_send(field2,npx,npy,npz)   
<a name="l00281"></a>00281 <span class="preprocessor">#ifdef NETCDFLIB</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span>         write (*,*) <span class="stringliteral">"VIS_NBODY | Writing field 2 to netcdf"</span>
<a name="l00283"></a>00283          <span class="keywordflow">if</span> (<a class="code" href="namelist_8h.html#71ebc23cbdc8093503a82c51c71692ec">netcdf</a>) call <a class="code" href="ncnbody_8c.html#e64321dfe68e9d84db2ed26c7dfccb13">ncnbody_putfield</a>( ncid, simtime, 2, npx, npy, npz, field2, <a class="code" href="namespacepepcb.html#92852f7d9b66e2e12b69b68bd62c1b1f">incdf</a> )
<a name="l00284"></a>00284 <span class="preprocessor">#endif</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span>      endif
<a name="l00286"></a>00286       <span class="keywordflow">if</span> (fselect3&gt;0) then
<a name="l00287"></a>00287          write (*,*) <span class="stringliteral">"VIS_NBODY | Shipping field 3"</span>
<a name="l00288"></a>00288          call flvisit_nbody2_field3_send(field3,npx,npy,npz)  
<a name="l00289"></a>00289 <span class="preprocessor">#ifdef NETCDFLIB</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span>         write (*,*) <span class="stringliteral">"VIS_NBODY | Writing field 3 to netcdf"</span>
<a name="l00291"></a>00291          <span class="keywordflow">if</span> (<a class="code" href="namelist_8h.html#71ebc23cbdc8093503a82c51c71692ec">netcdf</a>) call <a class="code" href="ncnbody_8c.html#e64321dfe68e9d84db2ed26c7dfccb13">ncnbody_putfield</a>( ncid, simtime,3, npx, npy, npz, field3, <a class="code" href="namespacepepcb.html#92852f7d9b66e2e12b69b68bd62c1b1f">incdf</a> )
<a name="l00292"></a>00292 <span class="preprocessor">#endif</span>
<a name="l00293"></a>00293 <span class="preprocessor"></span>      endif
<a name="l00294"></a>00294       <span class="keywordflow">if</span> (fselect4&gt;0) then
<a name="l00295"></a>00295          write (*,*) <span class="stringliteral">"VIS_NBODY | Shipping field 4"</span>
<a name="l00296"></a>00296          call flvisit_nbody2_field4_send(field4,npx,npy,npz)
<a name="l00297"></a>00297 <span class="preprocessor">#ifdef NETCDFLIB</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span>         write (*,*) <span class="stringliteral">"VIS_NBODY | Writing field 4 to netcdf"</span>
<a name="l00299"></a>00299          <span class="keywordflow">if</span> (<a class="code" href="namelist_8h.html#71ebc23cbdc8093503a82c51c71692ec">netcdf</a>) call <a class="code" href="ncnbody_8c.html#e64321dfe68e9d84db2ed26c7dfccb13">ncnbody_putfield</a>( ncid, simtime, 4, npx, npy, npz, field4, <a class="code" href="namespacepepcb.html#92852f7d9b66e2e12b69b68bd62c1b1f">incdf</a> )
<a name="l00300"></a>00300 <span class="preprocessor">#endif</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>      endif
<a name="l00302"></a>00302 endif
<a name="l00303"></a>00303 <span class="preprocessor">#endif</span>
<a name="l00304"></a>00304 <span class="preprocessor"></span>
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 
<a name="l00307"></a>00307      cfile = <span class="stringliteral">"fields/tslice."</span><span class="comment">//cdump</span>
<a name="l00308"></a>00308      open (62,file=cfile)
<a name="l00309"></a>00309 
<a name="l00310"></a>00310      ! <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>-<a class="code" href="slices_8f90.html#a6c694b901ed3b7438fa56850729cc61">slices</a> along <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a> axis
<a name="l00311"></a>00311      jfoc = <a class="code" href="namelist_8h.html#a729632262bf53dac77d4fbe3047cb44">focus</a>(2)/dy
<a name="l00312"></a>00312      kfoc = <a class="code" href="namelist_8h.html#a729632262bf53dac77d4fbe3047cb44">focus</a>(3)/dz
<a name="l00313"></a>00313 
<a name="l00314"></a>00314      ! temperature average line-out along <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a> axis: nave*nave average, converted to n/nc
<a name="l00315"></a>00315 
<a name="l00316"></a>00316      te_slice = 0.
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 
<a name="l00319"></a>00319      <span class="keywordflow">if</span> (ngz&lt;=5) then
<a name="l00320"></a>00320         nave=0
<a name="l00321"></a>00321      <span class="keywordflow">else</span>
<a name="l00322"></a>00322         nave = ngz/3
<a name="l00323"></a>00323      endif
<a name="l00324"></a>00324 
<a name="l00325"></a>00325      norm = (2*nave+1)**2  ! convert Temp to keV
<a name="l00326"></a>00326 
<a name="l00327"></a>00327      <span class="keywordflow">do</span> k=kfoc-nave,kfoc+nave
<a name="l00328"></a>00328         <span class="keywordflow">do</span> j=jfoc-nave,jfoc+nave
<a name="l00329"></a>00329 
<a name="l00330"></a>00330            te_slice(1:ngx) = te_slice(1:ngx)+telec(1:ngx,j,k)/norm  ! slice along <a class="code" href="laser_8f90.html#fb1137d97b183a5dd650ce11de600d8b">laser</a> axis: 5x5 average
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         end <span class="keywordflow">do</span>
<a name="l00333"></a>00333      end <span class="keywordflow">do</span>
<a name="l00334"></a>00334      write(62,'((2(1pe12.4)))') &amp;
<a name="l00335"></a>00335           (i*dx+<a class="code" href="namelist_8h.html#491dc1def2e8c0c73a94027d0fb55365">x_offset</a>,te_slice(i),i=1,ngx)
<a name="l00336"></a>00336      close(62)
<a name="l00337"></a>00337   endif
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 end subroutine <a class="code" href="vis__fields__nbody_8F90.html#b47dc6f9ae95f330275c117627b0b4fd">vis_fields_nbody</a>
<a name="l00341"></a>00341 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 23 16:02:50 2007 for PEPC by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7-20060810 </small></address>
</body>
</html>
