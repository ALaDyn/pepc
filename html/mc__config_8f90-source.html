<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PEPC: mc_config.f90 Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7-20060810 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_75b82e7e4a5feb05200b9ad7adf06257.html">home</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_28272fc65e3d756317163f9acb2ad644.html">gibbon</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e3e416c1e3f7ebc92335d37fb0dd4777.html">pepc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_991097dbe07e9883c0a11fa77543783e.html">pepc-b</a></div>
<h1>mc_config.f90</h1><a href="mc__config_8f90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 ! ==============================================
<a name="l00002"></a>00002 !
<a name="l00003"></a>00003 !                MC_CONFIG
<a name="l00004"></a>00004 !
<a name="l00005"></a>00005 !  Perform Monte-Carlo minimisation of PE by adjusting particle positions
<a name="l00006"></a>00006 !  according to constraints given by system geometry
<a name="l00007"></a>00007 !
<a name="l00008"></a>00008 ! ==============================================
<a name="l00009"></a>00009 
<a name="l00010"></a><a class="code" href="mc__config_8f90.html#e5b632eda26b5da33f2d3f66eca959d8">00010</a> subroutine <a class="code" href="mc__config_8f90.html#e5b632eda26b5da33f2d3f66eca959d8">mc_config</a>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012   use physvars
<a name="l00013"></a>00013   use treevars
<a name="l00014"></a>00014   use utils
<a name="l00015"></a>00015   implicit none
<a name="l00016"></a>00016   include 'mpif.h'
<a name="l00017"></a>00017 
<a name="l00018"></a>00018   integer :: nmove,i, ipar, j, pe_move, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>, <a class="code" href="namespacepepcb.html#983db3cf9f618b2f0150d9907a4bc743">ifile</a>
<a name="l00019"></a>00019   integer :: iseed0, i_count, i_rate, i_max, mc_dump
<a name="l00020"></a>00020   real :: epot, etrial, delta_E, prob1, epold, <a class="code" href="namespacerantest.html#57e18b26d24449e6afe0d206da3394ce">r</a> 
<a name="l00021"></a>00021   real :: xold, yold, zold, xt, yt, zt, xs, ys, zs
<a name="l00022"></a>00022   real :: Tplas
<a name="l00023"></a>00023   real :: r_limit, x_limit, y_limit
<a name="l00024"></a>00024   logical :: constrained
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 
<a name="l00027"></a>00027   !  <a class="code" href="namelist_8h.html#ec85c3dcd7fbe98f6846756ca7f020d1">idump</a> = max(1,<a class="code" href="namelist_8h.html#235bab43c650353dffe09255dad91d2a">mc_steps</a>/100)
<a name="l00028"></a>00028   mc_dump = 10
<a name="l00029"></a>00029   !  epot is p.e. of current configuration
<a name="l00030"></a>00030   !  etrial is p.e. of new trial config
<a name="l00031"></a>00031 
<a name="l00032"></a>00032   call <a class="code" href="tree__domains_8f90.html#e5a33667647f8b6535921f4e1ddeca6c">tree_domains</a>    ! Domain decomposition: allocate particle keys to PEs
<a name="l00033"></a>00033   call <a class="code" href="tree__build_8f90.html#00b4464b1b391043323911a75676c11c">tree_build</a>      ! Build trees from local particle lists
<a name="l00034"></a>00034   call <a class="code" href="tree__branches_8f90.html#600358828426e3ba05e76e278d86f747">tree_branches</a>   ! Determine and concatenate branch nodes
<a name="l00035"></a>00035   call <a class="code" href="tree__fill_8f90.html#c7a68d71e17a9778e6bbee7a72b73ed6">tree_fill</a>       ! Fill in remainder of local tree
<a name="l00036"></a>00036   call <a class="code" href="tree__properties_8f90.html#b495d74d5abf43b6e431c5e10db38109">tree_properties</a> ! Compute multipole moments for local tree
<a name="l00037"></a>00037   call <a class="code" href="potenergy_8f90.html#cc1a85830a01f57ac357fd3f85836f06">potenergy</a>(epot) ! Compute potential energy
<a name="l00038"></a>00038 !  call <a class="code" href="vis__parts_8f90.html#e2a23f44bbc93be4f1f88a28c93fabc1">vis_parts</a>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 
<a name="l00041"></a>00041   if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) then
<a name="l00042"></a>00042      do i=6,15,9
<a name="l00043"></a>00043         write (i,*) 'Configuring particle positions with MC routine ...'
<a name="l00044"></a>00044         write (i,*) 'Initial p.e.=',epot
<a name="l00045"></a>00045      end do
<a name="l00046"></a>00046      open(76,file='energy_mc.dat')
<a name="l00047"></a>00047      write(76,'(i6,1pe14.5)') 0,epot   ! Initial PE
<a name="l00048"></a>00048   endif
<a name="l00049"></a>00049 
<a name="l00050"></a>00050      Tplas = <a class="code" href="namelist_8h.html#429f260c120e70994f1e7a588e8b776e">Te_keV</a>/511.*<a class="code" href="namespacephysvars.html#f496963d8d4a8fe5a5a8ea1fbcd77dae">Qplas</a>  ! convert temperature to code units
<a name="l00051"></a>00051 
<a name="l00052"></a>00052   call system_clock(i_count,i_rate,i_max)
<a name="l00053"></a>00053   iseed0= -i_count/10 + 100*<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>  ! random number seed
<a name="l00054"></a>00054 
<a name="l00055"></a>00055   !  maximum step size as fraction of inter-particle spacing
<a name="l00056"></a>00056   !      delta_l=0.5*min(aii,aee)
<a name="l00057"></a>00057   if (<a class="code" href="namelist_8h.html#79d8c3e2761fc8654683dc3f97e58e25">debug_level</a>&gt;0) write(<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,*) 'MC step length ',<a class="code" href="namelist_8h.html#712155c80795c0d81c2164d3b568637a">delta_mc</a>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a>00060   do j=1, <a class="code" href="namelist_8h.html#235bab43c650353dffe09255dad91d2a">mc_steps</a>
<a name="l00061"></a>00061 !     call MPI_BARRIER( MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)  ! Wait for active PE to catch up
<a name="l00062"></a>00062 
<a name="l00063"></a>00063      epold=epot
<a name="l00064"></a>00064      if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0) then 
<a name="l00065"></a>00065         ! root picks PE for move
<a name="l00066"></a>00066         pe_move = <a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>*<a class="code" href="namespaceutils.html#e35fe01ab5373722db624fcc320415e4">rano</a>(iseed0)
<a name="l00067"></a>00067         pe_move = max(0,min(<a class="code" href="namespacetreevars.html#694640a77e3d8236c59add8bfa3c133b">num_pe</a>,pe_move))
<a name="l00068"></a>00068      endif
<a name="l00069"></a>00069 
<a name="l00070"></a>00070      call MPI_BCAST(pe_move, 1, MPI_INTEGER, 0,MPI_COMM_WORLD,<a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)  ! Pass result to other PEs
<a name="l00071"></a>00071 
<a name="l00072"></a>00072      if (pe_move == <a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>) then
<a name="l00073"></a>00073         i = <a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>*<a class="code" href="namespaceutils.html#e35fe01ab5373722db624fcc320415e4">rano</a>(iseed0)+1  ! select particle
<a name="l00074"></a>00074         i = max(1,min(<a class="code" href="namespacetreevars.html#46a9849e874a74f8747a37e0c76910c7">npp</a>,i))
<a name="l00075"></a>00075         !  keep old position
<a name="l00076"></a>00076         xold=<a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(i)
<a name="l00077"></a>00077         yold=<a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(i)
<a name="l00078"></a>00078         zold=<a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(i)
<a name="l00079"></a>00079         !  shift particle to new position
<a name="l00080"></a>00080         constrained = .false.
<a name="l00081"></a>00081         do while (.not. constrained) 
<a name="l00082"></a>00082            xs = (<a class="code" href="namespaceutils.html#e35fe01ab5373722db624fcc320415e4">rano</a>(iseed0)*2.-1.)*<a class="code" href="namelist_8h.html#712155c80795c0d81c2164d3b568637a">delta_mc</a>
<a name="l00083"></a>00083            ys = (<a class="code" href="namespaceutils.html#e35fe01ab5373722db624fcc320415e4">rano</a>(iseed0)*2.-1.)*<a class="code" href="namelist_8h.html#712155c80795c0d81c2164d3b568637a">delta_mc</a>
<a name="l00084"></a>00084            zs = (<a class="code" href="namespaceutils.html#e35fe01ab5373722db624fcc320415e4">rano</a>(iseed0)*2.-1.)*<a class="code" href="namelist_8h.html#712155c80795c0d81c2164d3b568637a">delta_mc</a>
<a name="l00085"></a>00085 
<a name="l00086"></a>00086            <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(i) = xold + xs
<a name="l00087"></a>00087            <a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(i) = yold + ys
<a name="l00088"></a>00088            <a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(i) = zold + zs
<a name="l00089"></a>00089            xt = <a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>(i) - <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(1)
<a name="l00090"></a>00090            yt = <a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>(i) - <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(2)
<a name="l00091"></a>00091            zt = <a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>(i) - <a class="code" href="namespacephysvars.html#571dce92e015cd998aa38c8dee7c36ac">plasma_centre</a>(3)
<a name="l00092"></a>00092            if (<a class="code" href="namespacetreevars.html#b9d8e8e7c77d33688592fb8fc698342f">q</a>(i) &lt;0) then 
<a name="l00093"></a>00093               r_limit = <a class="code" href="namelist_8h.html#4717f1135bf0b6bb04e6105ceb5a08dd">r_sphere</a> +10*<a class="code" href="namespacephysvars.html#7e110eb52a1176259c1c383a7f05a791">vte</a>   ! allow for Debye sheath
<a name="l00094"></a>00094               x_limit = <a class="code" href="namelist_8h.html#12ab60c2ad9358d336db6643fd3460ba">x_plasma</a>/2. + 10*<a class="code" href="namespacephysvars.html#7e110eb52a1176259c1c383a7f05a791">vte</a>
<a name="l00095"></a>00095               y_limit = <a class="code" href="namelist_8h.html#63c6deb40f1bc4b6f0fe258bb0961de3">y_plasma</a>/2. + 10*<a class="code" href="namespacephysvars.html#7e110eb52a1176259c1c383a7f05a791">vte</a>
<a name="l00096"></a>00096            else
<a name="l00097"></a>00097               r_limit = <a class="code" href="namelist_8h.html#4717f1135bf0b6bb04e6105ceb5a08dd">r_sphere</a>
<a name="l00098"></a>00098               x_limit = <a class="code" href="namelist_8h.html#12ab60c2ad9358d336db6643fd3460ba">x_plasma</a>/2.
<a name="l00099"></a>00099               y_limit = <a class="code" href="namelist_8h.html#63c6deb40f1bc4b6f0fe258bb0961de3">y_plasma</a>/2.
<a name="l00100"></a>00100            endif
<a name="l00101"></a>00101 
<a name="l00102"></a>00102            if (<a class="code" href="namelist_8h.html#65b106175d5c7acd554c1bce2595f2a8">target_geometry</a>==1) then
<a name="l00103"></a>00103               ! sphere
<a name="l00104"></a>00104               constrained = (xt**2 + yt**2 + zt**2 &lt;= r_limit**2) 
<a name="l00105"></a>00105            else if (<a class="code" href="namelist_8h.html#65b106175d5c7acd554c1bce2595f2a8">target_geometry</a>==2) then
<a name="l00106"></a>00106               ! disc
<a name="l00107"></a>00107               constrained = (xt &gt;= -x_limit .and. xt&lt;= x_limit .and. yt**2 + zt**2 &lt;= r_limit**2) 
<a name="l00108"></a>00108            else if (<a class="code" href="namelist_8h.html#65b106175d5c7acd554c1bce2595f2a8">target_geometry</a>==3) then
<a name="l00109"></a>00109               ! wire
<a name="l00110"></a>00110               constrained = (zt &gt;= -x_limit .and. zt&lt;= x_limit .and. yt**2 + xt**2 &lt;= r_limit**2)   
<a name="l00111"></a>00111            else
<a name="l00112"></a>00112               ! slab
<a name="l00113"></a>00113               constrained = (     xt &gt;= -x_limit .and. xt &lt;= x_limit &amp;
<a name="l00114"></a>00114                    .and. yt &gt;= -y_limit .and. yt &lt;= y_limit &amp;
<a name="l00115"></a>00115                    .and. zt &gt;= -y_limit .and. zt &lt;= y_limit )
<a name="l00116"></a>00116            endif
<a name="l00117"></a>00117         end do
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 
<a name="l00120"></a>00120         !  check for wrapping
<a name="l00121"></a>00121         !   call boundry(i,i,<a class="code" href="namespacetreevars.html#466130ce7b2fb1b56c99a0524b270b70">x</a>,<a class="code" href="namespacetreevars.html#5ca0fa6d04b09531b6c4c55c545bde27">y</a>,<a class="code" href="namespacetreevars.html#a73b1827f715edeb1801dbd9ea9bd930">z</a>,<a class="code" href="namespacetreevars.html#4b80abeb37dca0426ceec7dd7e914454">ux</a>,<a class="code" href="namespacetreevars.html#091b9d7991d39847f53ba7abd87ec1d4">uy</a>,<a class="code" href="namespacetreevars.html#3b14c2f77b072cc356b49d5163e12f36">uz</a>)
<a name="l00122"></a>00122      else
<a name="l00123"></a>00123         ! do nothing
<a name="l00124"></a>00124      endif
<a name="l00125"></a>00125      call MPI_BARRIER( MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)  ! Wait for active PE to catch up
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 
<a name="l00128"></a>00128      call <a class="code" href="tree__properties_8f90.html#b495d74d5abf43b6e431c5e10db38109">tree_properties</a>   ! rebuild multipole moments with same tree
<a name="l00129"></a>00129      call <a class="code" href="potenergy_8f90.html#cc1a85830a01f57ac357fd3f85836f06">potenergy</a>(etrial) ! Estimate new potential energy
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 
<a name="l00132"></a>00132      delta_E = etrial - epold
<a name="l00133"></a>00133 
<a name="l00134"></a>00134      prob1=exp(-amin1(delta_E/Tplas, 30.))
<a name="l00135"></a>00135      <a class="code" href="namespacerantest.html#57e18b26d24449e6afe0d206da3394ce">r</a> = <a class="code" href="namespaceutils.html#e35fe01ab5373722db624fcc320415e4">rano</a>(iseed0)
<a name="l00136"></a>00136      call MPI_BCAST(<a class="code" href="namespacerantest.html#57e18b26d24449e6afe0d206da3394ce">r</a>,1,MPI_REAL,0,MPI_COMM_WORLD,<a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)  ! Pass random no. to other PEs
<a name="l00137"></a>00137 
<a name="l00138"></a>00138      if (<a class="code" href="namelist_8h.html#429f260c120e70994f1e7a588e8b776e">Te_keV</a> == 0.) prob1=0.
<a name="l00139"></a>00139 
<a name="l00140"></a>00140      if ( delta_E &lt; 0 .or.  r &lt; prob1 ) then
<a name="l00141"></a>00141         ! accept move either i) if it decreases <a class="code" href="namespacetreevars.html#7854e9096568a9ed5efc8ce23a9d463f">pot</a>. energy 
<a name="l00142"></a>00142         !               or   ii) if it increases with random prob exp(-delta_E/kT)
<a name="l00143"></a>00143         call <a class="code" href="tree__domains_8f90.html#e5a33667647f8b6535921f4e1ddeca6c">tree_domains</a>    ! rebuild tree from scratch
<a name="l00144"></a>00144         call <a class="code" href="tree__build_8f90.html#00b4464b1b391043323911a75676c11c">tree_build</a>     
<a name="l00145"></a>00145         call <a class="code" href="tree__branches_8f90.html#600358828426e3ba05e76e278d86f747">tree_branches</a>   
<a name="l00146"></a>00146         call <a class="code" href="tree__fill_8f90.html#c7a68d71e17a9778e6bbee7a72b73ed6">tree_fill</a>  
<a name="l00147"></a>00147 !       call <a class="code" href="tree__properties_8f90.html#b495d74d5abf43b6e431c5e10db38109">tree_properties</a>   ! rebuild multipole moments 
<a name="l00148"></a>00148 !       call <a class="code" href="potenergy_8f90.html#cc1a85830a01f57ac357fd3f85836f06">potenergy</a>(epot) ! Compute new (accurate) potential energy
<a name="l00149"></a>00149         epot = etrial
<a name="l00150"></a>00150 
<a name="l00151"></a>00151      else
<a name="l00152"></a>00152         !             epot unchanged
<a name="l00153"></a>00153         ! restore particle to old position - tree unchanged
<a name="l00154"></a>00154         if (pe_move == <a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>) then
<a name="l00155"></a>00155            x(i)=xold
<a name="l00156"></a>00156            y(i)=yold
<a name="l00157"></a>00157            z(i)=zold
<a name="l00158"></a>00158         endif
<a name="l00159"></a>00159 
<a name="l00160"></a>00160         epot = epold   ! Keep old tree and P.E. value
<a name="l00161"></a>00161      endif
<a name="l00162"></a>00162 
<a name="l00163"></a>00163      !  distributions
<a name="l00164"></a>00164      if (mod(j,mc_dump).eq.0 .and. <a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==pe_move) then
<a name="l00165"></a>00165         do <a class="code" href="namespacepepcb.html#983db3cf9f618b2f0150d9907a4bc743">ifile</a>=6,15,9
<a name="l00166"></a>00166            write(ifile,'(a5,i5,a,i4,3(a8,1pe12.3))') &amp;
<a name="l00167"></a>00167                 'Step ',j,' particle ',i, &amp;
<a name="l00168"></a>00168                 ' P.E.=',epot/<a class="code" href="namespacephysvars.html#f496963d8d4a8fe5a5a8ea1fbcd77dae">Qplas</a>*511.,' dE ', delta_E/Qplas*511.,' prob ',prob1      
<a name="l00169"></a>00169         enddo
<a name="l00170"></a>00170      endif
<a name="l00171"></a>00171 !     if (<a class="code" href="namelist_8h.html#b5f956c45a8c46f5cc04782bfe292bfb">vis_on</a> .and. mod(j,<a class="code" href="namelist_8h.html#235bab43c650353dffe09255dad91d2a">mc_steps</a>/10) == 0 )  call <a class="code" href="vis__parts_8f90.html#e2a23f44bbc93be4f1f88a28c93fabc1">vis_parts</a>
<a name="l00172"></a>00172 
<a name="l00173"></a>00173      if (mod(j,mc_dump)==0) then
<a name="l00174"></a>00174         call system_clock(i_count,i_rate,i_max)
<a name="l00175"></a>00175         iseed0= -i_count/10 + 100*<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>  ! generate new sequence
<a name="l00176"></a>00176      endif
<a name="l00177"></a>00177 
<a name="l00178"></a>00178      write(76,'(i6,1pe14.5)') j,epot
<a name="l00179"></a>00179   end do
<a name="l00180"></a>00180 
<a name="l00181"></a>00181   close(76) 
<a name="l00182"></a>00182 
<a name="l00183"></a>00183   call <a class="code" href="dump_8f90.html#88b597631f796e2b06c577e64bd94fe9">dump</a>(<a class="code" href="namelist_8h.html#235bab43c650353dffe09255dad91d2a">mc_steps</a>)
<a name="l00184"></a>00184 end subroutine <a class="code" href="mc__config_8f90.html#e5b632eda26b5da33f2d3f66eca959d8">mc_config</a>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 23 16:02:49 2007 for PEPC by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7-20060810 </small></address>
</body>
</html>
