<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PEPC: tree_fill.f90 Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7-20060810 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_75b82e7e4a5feb05200b9ad7adf06257.html">home</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_28272fc65e3d756317163f9acb2ad644.html">gibbon</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_e3e416c1e3f7ebc92335d37fb0dd4777.html">pepc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_445afc100a243ec0eaed19e4a2dc673c.html">lpepcsrc</a></div>
<h1>tree_fill.f90</h1><a href="tree__fill_8f90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 !
<a name="l00002"></a>00002 ! ===========================================
<a name="l00003"></a>00003 !
<a name="l00004"></a>00004 !           TREE_FILL
<a name="l00005"></a>00005 !
<a name="l00006"></a>00006 !   Fill in coarsest levels of tree to complete local data structure 
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 !   
<a name="l00009"></a>00009 !
<a name="l00010"></a>00010 ! ===========================================
<a name="l00011"></a>00011 
<a name="l00012"></a><a class="code" href="tree__fill_8f90.html#c7a68d71e17a9778e6bbee7a72b73ed6">00012</a> subroutine <a class="code" href="tree__fill_8f90.html#c7a68d71e17a9778e6bbee7a72b73ed6">tree_fill</a>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014   use treevars
<a name="l00015"></a>00015   use tree_utils
<a name="l00016"></a>00016 
<a name="l00017"></a>00017   implicit none
<a name="l00018"></a>00018   include 'mpif.h'
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 !  integer, parameter :: size_t=1000
<a name="l00021"></a>00021 
<a name="l00022"></a>00022  integer*8, dimension(<a class="code" href="namespacetreevars.html#88ddb99cee17ffd203ed6e3adbdebaa5">maxaddress</a>) :: sub_key, parent_key
<a name="l00023"></a>00023  integer*8, dimension(8) :: child_key, child_sub
<a name="l00024"></a>00024 
<a name="l00025"></a>00025   integer, dimension(<a class="code" href="namespacetreevars.html#2ab032311413ab109ee55aa6ee9a83ab">nbranch_max</a>) :: branch_level
<a name="l00026"></a>00026   integer, dimension(<a class="code" href="namespacetreevars.html#88ddb99cee17ffd203ed6e3adbdebaa5">maxaddress</a>) :: twig_addr, twig_code,  cell_addr, tree_node, parent_addr
<a name="l00027"></a>00027   integer, dimension(8) :: child_addr !  children nodes
<a name="l00028"></a>00028   logical :: duplicate(<a class="code" href="namespacetreevars.html#88ddb99cee17ffd203ed6e3adbdebaa5">maxaddress</a>), resolved, keymatch(8)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030   integer*8 :: node_key, search_key, parent,  child_top
<a name="l00031"></a>00031   integer :: maxlevel, ilevel, nsub,i,j,k, nparent, nuniq, child_byte, child_bit, nchild, link_addr, hashaddr
<a name="l00032"></a>00032   integer :: nleaf_check, ntwig_check
<a name="l00033"></a>00033   integer ::  node_addr, jmatch(1),  parent_node, parent_level, nodtwig
<a name="l00034"></a>00034   integer :: <a class="code" href="get__address_8f90.html#2809b00e2dcb999b654cac13b2ffb261">key2addr</a>        ! Mapping function to get hash table <a class="code" href="namespacetreevars.html#3ecc2e98e400f5751ae1758d72035e15">address</a> from key
<a name="l00035"></a>00035   integer*8 :: <a class="code" href="get__next__node_8f90.html#a175a80527b401074396161119b2d63f">next_node</a>   ! Function to get next node key for local tree walk
<a name="l00036"></a>00036   integer :: <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 !  <a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>=.true.
<a name="l00039"></a>00039   if (<a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>) write(<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,'(/a)') 'TREE FILL'
<a name="l00040"></a>00040   if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==0 .and. <a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>) write(*,'(a)') 'LPEPC | FILL'
<a name="l00041"></a>00041 
<a name="l00042"></a>00042   if (<a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>) call <a class="code" href="check__table_8f90.html#a194a3895e4fa041b81142380e1139d5">check_table</a>('after make_branches ')
<a name="l00043"></a>00043 
<a name="l00044"></a>00044   ! get levels of branch nodes
<a name="l00045"></a>00045   maxlevel=0
<a name="l00046"></a>00046   do i=1,<a class="code" href="namespacetreevars.html#47708bdfab837f3fc4ea54b8c8f99a50">nbranch_sum</a>
<a name="l00047"></a>00047      branch_level(i) = log( 1.*<a class="code" href="namespacetreevars.html#6b92639d5afb11b693bf39ddade2db42">branch_key</a>(i) )/log(8.)
<a name="l00048"></a>00048      maxlevel = max( maxlevel, branch_level(i) )        ! Find maximum level
<a name="l00049"></a>00049   end do
<a name="l00050"></a>00050 
<a name="l00051"></a>00051   nparent = 0
<a name="l00052"></a>00052   parent_key(1) = 0
<a name="l00053"></a>00053 !  if (<a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>.and.<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>&gt;250) then
<a name="l00054"></a>00054 !     write (*,'(/a,i5/(i5,o16,i3))') 'Global branch list on ',<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>,&amp;
<a name="l00055"></a>00055 !          (i,<a class="code" href="namespacetreevars.html#6b92639d5afb11b693bf39ddade2db42">branch_key</a>(i), branch_level(i),i=1,<a class="code" href="namespacetreevars.html#47708bdfab837f3fc4ea54b8c8f99a50">nbranch_sum</a>)
<a name="l00056"></a>00056 !  endif
<a name="l00057"></a>00057 
<a name="l00058"></a>00058   do ilevel = maxlevel,1,-1                                            ! Start at finest branch level
<a name="l00059"></a>00059      nsub = count( mask=branch_level(1:<a class="code" href="namespacetreevars.html#47708bdfab837f3fc4ea54b8c8f99a50">nbranch_sum</a>) == ilevel )                       ! Count # branches at this level
<a name="l00060"></a>00060 !     if (<a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>.and.<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>&gt;250) then
<a name="l00061"></a>00061 !        write(*,*) 'proc ',<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>,' level= ',ilevel,' nsub= ',nsub,' <a class="code" href="namespacetreevars.html#3570b96c236051793cf00a6eadcf9bd5">nbranches</a>=',<a class="code" href="namespacetreevars.html#47708bdfab837f3fc4ea54b8c8f99a50">nbranch_sum</a>
<a name="l00062"></a>00062 !     endif
<a name="l00063"></a>00063      sub_key(1:nsub) =  pack(<a class="code" href="namespacetreevars.html#6b92639d5afb11b693bf39ddade2db42">branch_key</a>(1:<a class="code" href="namespacetreevars.html#47708bdfab837f3fc4ea54b8c8f99a50">nbranch_sum</a>), mask = branch_level(1:<a class="code" href="namespacetreevars.html#47708bdfab837f3fc4ea54b8c8f99a50">nbranch_sum</a>) == ilevel)        ! Pick out branches at current level
<a name="l00064"></a>00064 
<a name="l00065"></a>00065      sub_key(nsub+1:nsub+nparent) = parent_key(1:nparent)              ! Augment list with parent keys checked at previous level
<a name="l00066"></a>00066      nsub = nsub + nparent
<a name="l00067"></a>00067      call sort(sub_key(1:nsub))                                        ! Sort keys
<a name="l00068"></a>00068 
<a name="l00069"></a>00069      sub_key(nsub+1) = 0
<a name="l00070"></a>00070      duplicate(1:nsub) = (/ (sub_key(i) /= sub_key(i+1), i=1,nsub) /)  ! Identify unique keys     
<a name="l00071"></a>00071      nuniq= count(mask = duplicate(1:nsub))                            ! Count them
<a name="l00072"></a>00072      sub_key(1:nuniq) = pack( sub_key(1:nsub), mask = duplicate(1:nsub) )        ! Compress list
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 
<a name="l00075"></a>00075      do i=1,nuniq
<a name="l00076"></a>00076 
<a name="l00077"></a>00077         parent_key(i) = ISHFT( sub_key(i),-3 )             ! Parent key
<a name="l00078"></a>00078 
<a name="l00079"></a>00079         child_bit = IAND( sub_key(i), <a class="code" href="namespacetreevars.html#a3ccc4bce493257f711cee0d5bfa95ef">hashchild</a>)                    ! extract child bit from key: which child is it?
<a name="l00080"></a>00080         child_byte = 0
<a name="l00081"></a>00081         child_byte = IBSET(child_byte, child_bit)    ! convert child bit to byte code
<a name="l00082"></a>00082         nodtwig = -<a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a> -1     ! predicted twig # 
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         call <a class="code" href="make__hashentry_8f90.html#bb03176f8cee39b6a08e96622d3f9017">make_hashentry</a>( parent_key(i), nodtwig, 0, child_byte, <a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>, hashaddr, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a> )
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         if ( <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a> == 1 ) then     
<a name="l00087"></a>00087            ! keys match, so node already exists locally
<a name="l00088"></a>00088            ! Set child-bit in existing parent byte-code
<a name="l00089"></a>00089            hashaddr = <a class="code" href="get__address_8f90.html#2809b00e2dcb999b654cac13b2ffb261">key2addr</a>( parent_key(i),'FILL: sweep1'  )
<a name="l00090"></a>00090            <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( hashaddr )%childcode = IBSET( <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( hashaddr )%childcode, child_bit )
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         else if (<a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a> == 0 ) then
<a name="l00093"></a>00093            <a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a> = <a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a> + 1
<a name="l00094"></a>00094            <a class="code" href="namespacetreevars.html#7e3153d8a8b22c2802f4b3c054e10fd2">ntwig_me</a> = <a class="code" href="namespacetreevars.html#7e3153d8a8b22c2802f4b3c054e10fd2">ntwig_me</a>+1               ! # local twigs
<a name="l00095"></a>00095            <a class="code" href="namespacetreevars.html#48335e63d98923c0c5d0722b98a29813">twig_key</a>(<a class="code" href="namespacetreevars.html#7e3153d8a8b22c2802f4b3c054e10fd2">ntwig_me</a>) = <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( hashaddr)%key  ! add to list of local twigs
<a name="l00096"></a>00096 
<a name="l00097"></a>00097         else
<a name="l00098"></a>00098            write (<a class="code" href="namespacetreevars.html#0d5a9df9963aed1fb9d6ac000ba861f1">ipefile</a>,*) 'Key number ',i,' not resolved'
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         endif
<a name="l00101"></a>00101 
<a name="l00102"></a>00102      end do
<a name="l00103"></a>00103      nparent = nuniq
<a name="l00104"></a>00104   end do
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 
<a name="l00107"></a>00107   if (<a class="code" href="namespacetreevars.html#3db87213360b7b79fc7bc0b62c93ff30">tree_debug</a>) call <a class="code" href="check__table_8f90.html#a194a3895e4fa041b81142380e1139d5">check_table</a>('End of tree-fill    ')
<a name="l00108"></a>00108 
<a name="l00109"></a>00109   !  Go through twig nodes and fix # leaves in #table to include non-local branch nodes
<a name="l00110"></a>00110   !  - put this stuff in <a class="code" href="tree__properties_8f90.html#b495d74d5abf43b6e431c5e10db38109">tree_properties</a> for correct array sizes
<a name="l00111"></a>00111 
<a name="l00112"></a>00112   <a class="code" href="namespacetreevars.html#a1eb75b89eb026fdd25ce002fc580fc9">nnodes</a> = <a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a> + <a class="code" href="namespacetreevars.html#fb6610fee5c52c51b8f7cc46ce975c16">nleaf</a>
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   <a class="code" href="namespacetreevars.html#f4e6903e8f5e2f99688d7c45256c012a">nnodes_pw</a> = <a class="code" href="namespacetreevars.html#a1eb75b89eb026fdd25ce002fc580fc9">nnodes</a>   ! Store # nodes prior to tree-walk
<a name="l00115"></a>00115   <a class="code" href="namespacetreevars.html#62eac775dcb0b46af78b95fc81d4c8d4">ntwig_pw</a> = <a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a>     ! - need for re-calculating moments using same tree-structure
<a name="l00116"></a>00116   <a class="code" href="namespacetreevars.html#fbfbca89466cde5cbb0ea05f5bdda449">nleaf_pw</a> = <a class="code" href="namespacetreevars.html#fb6610fee5c52c51b8f7cc46ce975c16">nleaf</a>
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 
<a name="l00120"></a>00120   do i=1,<a class="code" href="namespacetreevars.html#7e3153d8a8b22c2802f4b3c054e10fd2">ntwig_me</a>
<a name="l00121"></a>00121     hashaddr = <a class="code" href="get__address_8f90.html#2809b00e2dcb999b654cac13b2ffb261">key2addr</a>( <a class="code" href="namespacetreevars.html#48335e63d98923c0c5d0722b98a29813">twig_key</a>(i),'FILL: twigs' )                         !  Table <a class="code" href="namespacetreevars.html#3ecc2e98e400f5751ae1758d72035e15">address</a>
<a name="l00122"></a>00122     <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( hashaddr )%leaves = 0                                                ! Reset # leaves to zero for recount including non-local branches
<a name="l00123"></a>00123     <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( hashaddr )%childcode =  IBSET( <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( hashaddr )%childcode,9 ) ! Set children_HERE flag for all local twig nodes
<a name="l00124"></a>00124   end do
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 
<a name="l00127"></a>00127   <a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(1:<a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a>) = pack(<a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>%key,mask = <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>%node &lt; 0)                                ! list of all twig keys excluding root
<a name="l00128"></a>00128 !  if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==1756) then 
<a name="l00129"></a>00129 !     do i=1,<a class="code" href="namespacetreevars.html#a1eb75b89eb026fdd25ce002fc580fc9">nnodes</a>
<a name="l00130"></a>00130 !       write(*,'(i8,o20)') i,<a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(i)
<a name="l00131"></a>00131 !    end do
<a name="l00132"></a>00132 !  endif
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   call sort(<a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(1:<a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a>))                                                               ! Sort keys
<a name="l00135"></a>00135   <a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(<a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a>+1:<a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a>+<a class="code" href="namespacetreevars.html#fb6610fee5c52c51b8f7cc46ce975c16">nleaf</a>) = pack(<a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>%key,mask = <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>%node &gt; 0)                    ! add list of leaf keys
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 !  if (<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>==1756) then 
<a name="l00138"></a>00138 !       write(*,*) 'After sort'
<a name="l00139"></a>00139 !     do i=1,<a class="code" href="namespacetreevars.html#a1eb75b89eb026fdd25ce002fc580fc9">nnodes</a>
<a name="l00140"></a>00140 !       write(*,'(i8,o20)') i,<a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(i)
<a name="l00141"></a>00141 !    end do
<a name="l00142"></a>00142 !  endif
<a name="l00143"></a>00143 !call MPI_FINALIZE(<a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)
<a name="l00144"></a>00144 !  stop
<a name="l00145"></a>00145 
<a name="l00146"></a>00146   tree_node(1) = -1  ! root node #
<a name="l00147"></a>00147   cell_addr(1) = <a class="code" href="get__address_8f90.html#2809b00e2dcb999b654cac13b2ffb261">key2addr</a>(1_8,'FILL: root')
<a name="l00148"></a>00148  
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   do i=2,<a class="code" href="namespacetreevars.html#a1eb75b89eb026fdd25ce002fc580fc9">nnodes</a>
<a name="l00151"></a>00151     hashaddr = <a class="code" href="get__address_8f90.html#2809b00e2dcb999b654cac13b2ffb261">key2addr</a>( <a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(i),'FILL: nodes' )
<a name="l00152"></a>00152     cell_addr(i) = hashaddr 
<a name="l00153"></a>00153     tree_node(i) =  <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( hashaddr )%node                     ! node property pointers
<a name="l00154"></a>00154     parent_key(i) = ishft(<a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(i),-3 )                    ! Parent keys, skipping root
<a name="l00155"></a>00155     parent_addr(i) =  <a class="code" href="get__address_8f90.html#2809b00e2dcb999b654cac13b2ffb261">key2addr</a>( parent_key(i),'FILL: node par' )                 ! parents' #table addresses
<a name="l00156"></a>00156   end do
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 !  Sweep back up, and augment leaf count of parent nodes
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   do i=<a class="code" href="namespacetreevars.html#a1eb75b89eb026fdd25ce002fc580fc9">nnodes</a>,2,-1
<a name="l00162"></a>00162      if (<a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( parent_addr(i) )%owner == <a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a> ) then
<a name="l00163"></a>00163         <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( parent_addr(i) )%leaves = <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( parent_addr(i) )%leaves + <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>(cell_addr(i) )%leaves 
<a name="l00164"></a>00164      endif
<a name="l00165"></a>00165   end do
<a name="l00166"></a>00166 
<a name="l00167"></a>00167   <a class="code" href="namespacetreevars.html#4806e1728d085ba63091689ed4e089a2">node_level</a>( tree_node(1:<a class="code" href="namespacetreevars.html#a1eb75b89eb026fdd25ce002fc580fc9">nnodes</a>) ) = log(1.*<a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(1:<a class="code" href="namespacetreevars.html#a1eb75b89eb026fdd25ce002fc580fc9">nnodes</a>))/log(8.)  ! get levels from keys and prestore as node property
<a name="l00168"></a>00168   <a class="code" href="namespacetreevars.html#4806e1728d085ba63091689ed4e089a2">node_level</a>(0) = 0
<a name="l00169"></a>00169 
<a name="l00170"></a>00170   ! Check tree integrity: Root node should now contain all particles!
<a name="l00171"></a>00171   if (<a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>(1)%leaves /= <a class="code" href="namespacetreevars.html#ac21a2dc42e5595e66cba603534873bd">npart</a>) then
<a name="l00172"></a>00172      write(*,*) 'Problem with tree on PE ',<a class="code" href="namespacetreevars.html#f0c1ebe7c983f1b1061d88e367afc933">me</a>
<a name="l00173"></a>00173      write(*,*) 'Leaf checksum (',<a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>(1)%leaves,')  does not match # particles (',<a class="code" href="namespacetreevars.html#ac21a2dc42e5595e66cba603534873bd">npart</a>,')'
<a name="l00174"></a>00174         call <a class="code" href="diagnose__tree_8f90.html#0ebc533aa04abc5a0548c36ec62b2cff">diagnose_tree</a>
<a name="l00175"></a>00175   endif
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   !  Determine '<a class="code" href="get__next__node_8f90.html#a175a80527b401074396161119b2d63f">next_node</a>' pointers for tree walk &amp; store in hash table.
<a name="l00179"></a>00179   !  Preprocess child info and store as node properties
<a name="l00180"></a>00180   !  - already have (approx) sorted key list for twig nodes from leaf count above.
<a name="l00181"></a>00181 
<a name="l00182"></a>00182   do i = <a class="code" href="namespacetreevars.html#a1eb75b89eb026fdd25ce002fc580fc9">nnodes</a>,2,-1
<a name="l00183"></a>00183      search_key = <a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(i)                   
<a name="l00184"></a>00184      node_addr = cell_addr(i)
<a name="l00185"></a>00185      <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( node_addr )%next = <a class="code" href="get__next__node_8f90.html#a175a80527b401074396161119b2d63f">next_node</a>(search_key)  !   Get next sibling, uncle, great-uncle in local tree
<a name="l00186"></a>00186   end do
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 
<a name="l00189"></a>00189   ! Fill in 1st child, # children in twig properties
<a name="l00190"></a>00190   do i = 1,<a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a>
<a name="l00191"></a>00191      child_byte = <a class="code" href="namespacetreevars.html#f3784041f7cce271ebb213e4e88fb0a0">htable</a>( cell_addr(i) )%childcode                           !  Children byte-code
<a name="l00192"></a>00192      nchild = SUM( (/ (ibits(child_byte,j,1),j=0,7) /) )                   ! # children = sum of bits in byte-code
<a name="l00193"></a>00193      child_sub(1:nchild) = pack( <a class="code" href="namespacetreevars.html#e81ec702e5854eb659b60ed694d2f732">bitarr</a>, mask=(/ (btest(child_byte,j),j=0,7) /) )  ! Extract child sub-keys from byte code
<a name="l00194"></a>00194     child_top = ishft(<a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(i),3) 
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     do j=1,nchild
<a name="l00197"></a>00197        child_key(j) = IOR( child_top, child_sub(j) )         ! Construct keys of children
<a name="l00198"></a>00198     end do
<a name="l00199"></a>00199 
<a name="l00200"></a>00200      <a class="code" href="namespacetreevars.html#368a06dc09d689328cc73ddf69490a3f">first_child</a>( tree_node(i) ) = child_key(1)   ! Store 1st child as twig-node property - used in <a class="code" href="tree__aswalk_8f90.html#edc62302e0a6458cc8830d1d676dd759">tree_walk</a>
<a name="l00201"></a>00201      <a class="code" href="namespacetreevars.html#273d43aa2e27f0f2d74fa02458d54d2d">n_children</a>( tree_node(i) ) = nchild             ! Store # children   <span class="stringliteral">"    "</span>
<a name="l00202"></a>00202   end do
<a name="l00203"></a>00203 
<a name="l00204"></a>00204   !  Dummy values for leaves
<a name="l00205"></a>00205   <a class="code" href="namespacetreevars.html#368a06dc09d689328cc73ddf69490a3f">first_child</a>(1:<a class="code" href="namespacetreevars.html#fb6610fee5c52c51b8f7cc46ce975c16">nleaf</a>) = <a class="code" href="namespacetreevars.html#bfc0b2d44f95a2cfc7ac172c49fcc100">treekey</a>(<a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a>+1:<a class="code" href="namespacetreevars.html#863a5294e9f064d8de564660bd1cf82d">ntwig</a>+<a class="code" href="namespacetreevars.html#fb6610fee5c52c51b8f7cc46ce975c16">nleaf</a>) 
<a name="l00206"></a>00206   <a class="code" href="namespacetreevars.html#273d43aa2e27f0f2d74fa02458d54d2d">n_children</a>(1:<a class="code" href="namespacetreevars.html#fb6610fee5c52c51b8f7cc46ce975c16">nleaf</a>) = 0
<a name="l00207"></a>00207 
<a name="l00208"></a>00208   call MPI_BARRIER( MPI_COMM_WORLD, <a class="code" href="namespacepepcb.html#a0d18ab20b16a2f6f7ea2d6b62caab43">ierr</a>)  ! Synchronize
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 end subroutine <a class="code" href="tree__fill_8f90.html#c7a68d71e17a9778e6bbee7a72b73ed6">tree_fill</a>
<a name="l00213"></a>00213 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 23 16:02:50 2007 for PEPC by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7-20060810 </small></address>
</body>
</html>
