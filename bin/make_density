#!/bin/sh

# Shell script to concatenate graphical and text output from 
# arbitrary number of PEs sharing a series of timestamps
if [ $# = 0 -o "$1" = "-h" -o "$1" = "-help" -o "$1" = "-?" ]; then
    echo "Call parameters:  runpp/nopp timestamp"
    exit
fi
MYDIR=`pwd`
echo $MYDIR
# Slice postprocessor
PP=~/pepc/bin/slicer
RUNPP=$1
DATADIR=$MYDIR
TIMESTAMP=$2
ARROW=0.05c/0.2c/0.05cn0.25i  ## width/headlength/headwidth
rm -f $(DATADIR)/*.ps 


if [ ! -f dumps/parts_dump.$TIMESTAMP ]; then
     ../merge1_dump . $TIMESTAMP ## Merge particle data from PE directories
fi

if [ ! -d $TIMESTAMP ]; then
    echo "Making snapshot directory $TIMESTAMP"
    mkdir $TIMESTAMP

else
    echo "$TIMESTAMP exists"
fi

# Run slicer
if [ $RUNPP = "runpp" ]; then
   echo $TIMESTAMP | $PP
fi

 rm -f gmt.env

# First draw network and label the nodes
# -K omits trailer, -O omits header
      gmtset GRID_PEN 0.25pta LABEL_FONT_SIZE 16p
      cat grid_defs.gmt | while read VAR VAL
      do 
        VAL2=`echo $VAL |  sed -e 's/ //g' -e 's/"//g' ` 
	echo "$VAR=$VAL2" >> gmt.env
      done 
     eval `cat gmt.env  | awk '{ printf "%s\n",$0 }' ` 

  echo "PA=${PA}"
  echo "DR=${DR}"
  echo "MESH=${MESH}"
  echo "AXES=${AXES}"
  echo "PACONV=${PACONV}"
  echo "ZPACONV=${ZPACONV}"

      ILLU=-Idata1_int.grd
      SCALE=4.5i/2i/4i/0.2i
      ZSCALE=1.3i/${ZSHIFT}i/.5i/0.05ih
      PSCALE=.5i/${PSHIFT}i/.5i/0.05ih

      DPI=100  ## postscript resolution
      SSJI=2
      SSJE=5
      SSE=50
     SSRHO=1
# Make colour maps

#      makecpt -Crelief -T${RHOMAP} > dens.cpt
#  makecpt -Crainbow -T-2.2/1.2/.1 > dens1.cpt
  cd $TIMESTAMP

      \rm -f .gmtcommands *.grd *.cpt *.ps
# -K omits trailer, -O omits header
      gmtset GRID_PEN 0.3pta
      gmtset LABEL_FONT_SIZE 20p
      gmtset ANOT_FONT_SIZE 20p
      gmtset FRAME_PEN 2p

#      gmtset ANOT_OFFSET -0.5i
      PLOT=../idens_$TIMESTAMP.ps
      BOX=X4i/4i
      PASHIFT=0.000/170.000/0.000/170.000
#      BOX2=X3.5i/2.5i
#  PACONV=-4/8/-6.6/8

# ion density
      XYDATA=xy_slice_iden
      gmtset PAGE_ORIENTATION portrait

      xyz2grd $XYDATA -Gdata1.grd -R${DR} -I${MESH} 
      grdinfo data1.grd
      grdgradient data1.grd -A30 -Nt -Gdata1_int.grd
      grdimage data1.grd -J${BOX} -E$DPI  -R${DR} -T  -K -C../dens.cpt -X1i -Y1i > $PLOT
      psbasemap -R${PASHIFT} -J${BOX} -B50:"@~w@~@-p@-x/c":/50:"@~w@~@-p@-y/c":WnSe -P -O -K  -X0 -Y0 >> $PLOT 
      gmtset ANOT_FONT_SIZE 16p LABEL_FONT_SIZE 18p
      psscale -C../dens.cpt -D$SCALE -O -K -B1/:"log@-10@-(n@-i@- /n@-c@-)":  >> $PLOT
      cat << EOF | pstext -R${DR} -J$BOX -O -N -X0 -Y0 >> $PLOT
120. 150. 20 0.0 1 2 a)
EOF

cd $MYDIR
echo "... done"


