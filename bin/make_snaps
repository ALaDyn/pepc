#!/bin/sh

# Shell script to concatenate graphical and text output from 
# arbitrary number of PEs sharing a series of timestamps
if [ $# = 0 -o "$1" = "-h" -o "$1" = "-help" -o "$1" = "-?" ]; then
    echo "Call parameters: run# runpp/nopp plot/noplot"
    exit
fi
MYDIR=`pwd`
DATADIR=$MYDIR
echo $MYDIR 
RUN=$1
RUNPP=$2
DOPLOT=$3
PEPC=~/pepc
# Slice postprocessor
PP=$PEPC/bin/slicer

# Find timestamp list


if [ ! -d plots ]; then
   echo "Making plot directory in $DATADIR"
   mkdir plots

else
   echo "Plot directory for $DATADIR already exists"
    rm plots/*.ps
fi

if [ ! -f timestamps ]; then
    echo "Making plots for timestep ";cat runstamp
	cd data/pe0000
    ls parts_dump.* |  sed -e 's/parts_dump.//g' > ../../timestamps
	cd ../..
#    cat runstamp > timestamps
fi
    echo "Checking current timestamp list:"
    cat timestamps | while read TIMESTAMP
    do
	if [ ! -f dumps/parts_dump.$TIMESTAMP ]; then
	    merge1_dump  $TIMESTAMP ## Merge particle data from PE directories
	else
	    echo "Data for $TIMESTAMP OK"
	fi
    done

#cat timestamps
echo
#TIMESTAMP=000500

cat timestamps | while read TIMESTAMP
do
	if [ ! -d $TIMESTAMP ]; then
	    echo "Making snapshot directory $TIMESTAMP"
	    mkdir $TIMESTAMP

	else
	    echo "$DATADIR/$TIMESTAMP exists"
	fi

	# Run slicer
	if [ $RUNPP = "runpp" ]; then
	    echo $TIMESTAMP | $PP
	    cat $TIMESTAMP/pp.log
	fi
done

if [ $DOPLOT = "noplot" ]; then
  exit
fi

gmtset GRID_PEN 0.15pt
gmtset  ANOT_FONT_SIZE 12p
gmtset  ANOT_OFFSET  0.05i
gmtset  LABEL_FONT_SIZE 14p
gmtset  TICK_LENGTH 0.1c

#  Read in common grid parameters
rm -f gmt.env
cat grid_defs.gmt | while read VAR VAL
  do
  VAL2=`echo $VAL |  sed -e 's/ //g' -e 's/"//g' `
  echo "$VAR=$VAL2" >> gmt.env
done

#  Convert to local variables
eval `cat gmt.env  | awk '{ printf "%s\n",$0 }' `

  echo "PA=${PA}"
  echo "DR=${DR}"
  echo "MESH=${MESH}"
  echo "AXES=${AXES}"
  echo "BOX=${BOX}"
  echo "ZPA=${ZPA}"
  echo "ZDR=${ZDR}"
  echo "ZMESH=${ZMESH}"
  echo "ZAXES=${ZAXES}"
  echo "ZBOX=${ZBOX}"
  echo "RHOMAP=${RHOMAP}"
  echo "JEMAP=${JEMAP}"
  echo "JIMAP=${JIMAP}"
  echo "EMAP=${EMAP}"
  echo "JEVEC=${JEVEC}"
  echo "JIVEC=${JIVEC}"
  echo "EVEC=${EVEC}"
  echo "FPMAP=${FPMAP}"
  echo "TEMAP=${TEMAP}"
  echo "TERANGE=${TERANGE}"
  echo "TIMAP=${TIMAP}"
  echo "TIRANGE=${TIRANGE}"
  echo "UPA=${UPA}"
  echo "UDR=${UDR}"
  echo "UMESH=${UMESH}"
  echo "UAXES=${UAXES}"
  echo "UBOX=${UBOX}"
  echo "UIPA=${UIPA}"
  echo "UIDR=${UIDR}"
  echo "UIMESH=${UIMESH}"
  echo "UIAXES=${UIAXES}"
  echo "UIBOX=${UIBOX}"
  echo "SSRHO=${SSRHO}"
  echo "SSTE=${SSTE}"
  echo "SSTI=${SSTI}"
  echo "SSFP=${SSFP}"
  echo "YSHIFT=${YSHIFT}"


#  eval `echo ${ZBOX} |  awk '{ t = $1 + 0.3; printf  "ZSHIFT=%s",t}'`
#  eval `echo ${UBOX} |  awk '{ t = $1 + 0.2; printf  "PSHIFT=%s",t}'`

  echo "PSHIFT=${PSHIFT}"
  echo "ZSHIFT=${ZSHIFT}"
   echo "TCOLD=${TCOLD}"




      ARROW=0.05c/0.2c/0.05cn0.25i  ## width/headlength/headwidth
      ILLU=-Idata1_int.grd
      SCALE=.5i/${YSHIFT}i/.5i/0.05ih
      ZSCALE=2.1i/${ZSHIFT}i/.5i/0.05i
      PSCALE=.5i/${PSHIFT}i/.5i/0.05ih

      DPI=400  ## postscript resolution
      SSJI=2
      SSJE=5
      SSE=50
      SSRHO=10
      UANGMAX=4
# Make colour maps
#    makecpt -Chaxby -T-.5/15/.1 -I > dens.cpt
#      makecpt -Cseis -I -Z -T${RHOMAP} > dens.cpt
#      makecpt -Crainbow -Z -T${RHOMAP} > dens.cpt
      makecpt -Ccopper -T${JEMAP} -I > je.cpt
      makecpt -Crainbow -T${JIMAP}  > ji.cpt
      makecpt -Cseis -T${EMAP} -I > e.cpt
      makecpt -Cseis -I  -T${FPMAP} > f.cpt
# angular ion distn
      makecpt -Cseis -I -T1/50/1 > alpha.cpt
# energy distn
      makecpt -Cjet  -T-1/$UANGMAX/.1   > ualpha.cpt

# potential - polar
      makecpt -Cred2green -T-3/3/.02 -I > pot.cpt

      cat << EOF > potlevels
0.1     C
1	C
2       C
EOF




#TIMESTAMP=000500
cat timestamps | while read TIMESTAMP
do

  if [ -d $TIMESTAMP ]; then
      echo "Making plots from directory $TIMESTAMP"
      
      cd $TIMESTAMP

#  Read in parameters for this snapshot
rm -f snap.env
cat snap_defs.gmt | while read VAR VAL
  do
  VAL2=`echo $VAL |  sed -e 's/ //g' -e 's/"//g' `
  echo "$VAR=$VAL2" >> snap.env
done

#  Convert to local variables
eval `cat snap.env  | awk '{ printf "%s\n",$0 }' `

      echo "TRUN=$TRUN"
      echo "TLASER=$TLASER"
      PLOT=../plots/xy_slice_${TIMESTAMP}.ps
      rm -f $PLOT

echo "ion density in xy"
      XYDATA=xy_slice_iden
      psbasemap -R${PA} -J${BOX} -B${AXES}WSne -P -K  -X.5i -Y7i > $PLOT 
      xyz2grd $XYDATA -Gdata1.grd -R${DR} -I${MESH} 
      grdinfo data1.grd
      grdgradient data1.grd -A30 -Nt -Gdata1_int.grd
# plot image
      grdimage data1.grd -J${BOX} -E$DPI  -R${DR} -T -O -K -C../dens.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$SCALE -O -K -B${SSRHO}/:n@-i@-/n@-c@-:  >> $PLOT


      \rm *.grd .gmtcommands

echo  "ion current in xy"
      JX=xy_slice_jxi
      JY=xy_slice_jyi

      psbasemap -R${PA} -J${BOX} -B${AXES}wSne -P -K -O -X2.5i -Y0 >> $PLOT
      xyz2grd $JX -Gjx.grd -R${DR} -I${MESH} 
      xyz2grd $JY -Gjy.grd -R${DR} -I${MESH}
      grdinfo jx.grd
      grdvector jx.grd jy.grd -JX -O -K -Q$ARROW -C../ji.cpt -G0 -S${JIVEC}i >> $PLOT
      psscale -C../ji.cpt -D$SCALE -O -K -B${SSJI}/:J@-i@-:  >> $PLOT
      \rm *.grd .gmtcommands

echo "ion temperature (K.E.) in xy"
      TI=xy_slice_ti

      psbasemap -R${PA} -J${BOX} -B${AXES}wnSE -P -K -O -X2.5i -Y0 >> $PLOT 
# Convert xyz data to grid file
      xyz2grd $TI -Gdata1.grd -R${DR} -I${MESH} 
      grdinfo data1.grd
# Make colour map
#      makecpt  -Cseis -I  -L${TIRANGE}   -S${TIMAP} > ti.cpt

      grd2cpt  data1.grd  -Cseis -I  -L${TIRANGE}   -S${TIMAP} > ti.cpt
      grdimage data1.grd  -J${BOX} -E$DPI -R${DR} -T -O -K -Cti.cpt -X0 -Y0 >> $PLOT
      psscale -Cti.cpt -D$SCALE -O -K -B${SSTI}/:T@_i@-:  >> $PLOT


# -----------------------------
echo "electron density in xy"
      XYDATA=xy_slice_eden
      XY2=xy_slice_nhot
      psbasemap -R${PA} -J${BOX} -B${AXES}WSne -P -K -O -X-5i -Y-3i >> $PLOT 
      xyz2grd $XYDATA -Gdata1.grd -R${DR} -I${MESH} 
      xyz2grd $XY2 -Gdata2.grd -R${DR} -I${MESH} 
      grdmath data1.grd data2.grd ADD = data3.grd
      grdinfo data2.grd
      grdgradient data1.grd -A30 -Nt -Gdata1_int.grd
# plot image
      grdimage data1.grd -JX -E$DPI -R${DR} -T -O -K -C../dens.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$SCALE -O -K -B${SSRHO}/:n@-e@-/n@-c@-:  >> $PLOT

      \rm *.grd .gmtcommands

echo "electron current in xy"
      JX=xy_slice_jxe
      JY=xy_slice_jye

      psbasemap -R${PA} -J${BOX} -B${AXES}wnSe -P -K -O -X2.5i -Y0 >> $PLOT 
      xyz2grd $JX -Gjx.grd -R${DR} -I${MESH} 
      xyz2grd $JY -Gjy.grd -R${DR} -I${MESH}
      grdinfo jx.grd
      grdvector jx.grd jy.grd -JX -O -K -Q$ARROW -C../je.cpt -G0 -S${JEVEC}i >> $PLOT
       psscale -C../je.cpt -D$SCALE -O -K -B${SSJE}/:J@-e@-:  >> $PLOT
     \rm *.grd .gmtcommands

echo "electron temperature (K.E.) in xy"
      TE=xy_slice_te

      psbasemap -R${PA} -J${BOX} -B${AXES}wnSE -P -K -O -X2.5i -Y0 >> $PLOT
# Convert xyz data to grid file
      xyz2grd $TE -Gdata1.grd -R${DR} -I${MESH}
      grdinfo data1.grd
# Make colour map
      grd2cpt  data1.grd  -Cseis -I  -L${TERANGE}   -S${TEMAP} > te.cpt
      grdimage data1.grd  -J${BOX} -E$DPI -R${DR} -T -O -K -Cte.cpt -X0 -Y0 >> $PLOT
      psscale -Cte.cpt -D$SCALE -O -K -B${SSTE}/:T@-e@-: >> $PLOT

# ------------------------

echo "hot electron density in xy"
      XYDATA=xy_slice_nhot
      XY2=xy_slice_nhot
      psbasemap -R${PA} -J${BOX} -B${AXES}WnSe -P -K -O -X-5i -Y-3i >> $PLOT 
      xyz2grd $XYDATA -Gdata1.grd -R${DR} -I${MESH} 
#      grdmath data1.grd data2.grd ADD = data3.grd
      grdinfo data1.grd
      grdgradient data1.grd -A30 -Nt -Gdata1_int.grd
      grdimage data1.grd -JX -E$DPI -R${DR} -T -O -K -C../dens.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$SCALE -O -K -B${SSRHO}/:n@-hot@-/n@-c@-:  >> $PLOT

echo "hot electron current in xy"
      JX=xy_slice_jxhot
      JY=xy_slice_jyhot

      psbasemap -R${PA} -J${BOX} -B${AXES}wnSe -P -K -O -X2.5i -Y0 >> $PLOT 
      xyz2grd $JX -Gjx.grd -R${DR} -I${MESH} 
      xyz2grd $JY -Gjy.grd -R${DR} -I${MESH}
      grdinfo jx.grd
      grdvector jx.grd jy.grd -JX -O -K -Q$ARROW -C../je.cpt -G0 -S${JEVEC}i >> $PLOT
       psscale -C../je.cpt -D$SCALE -O -K -B${SSJE}/:J@-e@-: -U"xy-slices of $RUN at ${TRUN} ($TIMESTAMP)" >> $PLOT

echo "Electric field in xy"
      EX=xy_slice_ex
      EY=xy_slice_ey

      psbasemap -R${PA} -J${BOX} -B${AXES}wnSe -P -K -O -X2.5i -Y0 >> $PLOT 
      xyz2grd $EX -Gex.grd -R${DR} -I${MESH} 
      xyz2grd $EY -Gey.grd -R${DR} -I${MESH}
      grdinfo ex.grd
      grdvector ex.grd ey.grd  -JX -O -K -Q$ARROW -C../e.cpt -G0 -S${EVEC}i >> $PLOT
      psscale -C../e.cpt -D$SCALE -O -B${SSE}/:E:  >> $PLOT
      \rm *.grd .gmtcommands

# Potential
#      TE=xy_slice_phi

#      psbasemap -R${PA} -J${BOX} -B${AXES}wSnE -P -K -O -X2.5i -Y0 >> $PLOT
# Convert xyz data to grid file
#      xyz2grd $TE -Gdata1.grd -R${DR} -I${MESH}
#      grdinfo data1.grd
# Make colour map
#      grd2cpt  data1.grd  -Cseis -I  -L${TERANGE}   -S${TEMAP} > te.cpt
#      grdimage data1.grd  -J${BOX} -E$DPI -R${DR} -O -K -Cte.cpt -X0 -Y0 >> $PLOT
#    grdcontour data1.grd  -E180 -J${BOX} -R${DR} -O  -C../potlevels -X0 -Y0 \
# -U"xy-slices of $RUN at $TIMESTAMP" >> $PLOT

#      psscale  -C../potlevels -D$SCALE -O  -B1:Phi: -U"xy-slices of $RUN at $TIMESTAMP" >> $PLOT



 #    gzip $PLOT



###  Plots in xz plane   #####

      PLOT=../plots/xz_slice_${TIMESTAMP}.ps
      TEXTPOS="-15.0 30.0"
      rm -f $PLOT

echo  "ion density in xz"
      XYDATA=xz_slice_iden
      psbasemap -R${ZPA} -J${ZBOX} -B${ZAXES}WSne -P -K  -X.6i -Y8i > $PLOT 
      xyz2grd $XYDATA -Gdata1.grd -R${ZDR} -I${ZMESH} 
      grdinfo data1.grd
      grdgradient data1.grd -A30 -Nt -Gdata1_int.grd
# plot image
      grdimage data1.grd -J${ZBOX} -E$DPI  -R${ZDR} -T -O -K -C../dens.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$ZSCALE -O -K -B${SSRHO}/:n@-i@-/n@-c@-: >> $PLOT

      \rm *.grd .gmtcommands

echo "ion current in xz"
      JX=xz_slice_jxi
      JY=xz_slice_jzi

      psbasemap -R${ZPA} -J${ZBOX} -B${ZAXES}wSne -P -K -O -X2.5i -Y0 >> $PLOT
      xyz2grd $JX -Gjx.grd -R${ZDR} -I${ZMESH} 
      xyz2grd $JY -Gjy.grd -R${ZDR} -I${ZMESH}
      grdinfo jx.grd
      grdvector jx.grd jy.grd -JX -O -K -Q$ARROW -C../ji.cpt -G0 -S${JIVEC}i >> $PLOT
       psscale -C../je.cpt -D$ZSCALE -O -K -B${SSJI}/:J@-i@-: >> $PLOT
      \rm *.grd .gmtcommands

echo "ion temperature (K.E.) in xz"
      TI=xz_slice_ti

      psbasemap -R${ZPA} -J${ZBOX} -B${ZAXES}wSnE -P -K -O -X2.5i -Y0 >> $PLOT 
# Convert xyz data to grid file
      xyz2grd $TI -Gdata1.grd -R${ZDR} -I${ZMESH} 
      grdinfo data1.grd
# Make colour map
#      makecpt  -Cseis -I  -L${TIRANGE}   -S${TIMAP} > ti.cpt

      grd2cpt  data1.grd  -Cseis -I  -L${TIRANGE}   -S${TIMAP} > ti.cpt
      grdimage data1.grd  -J${ZBOX} -E$DPI -R${ZDR} -T -O -K -Cti.cpt -X0 -Y0 >> $PLOT
      psscale -Cti.cpt -D$ZSCALE -O -K -B${SSTI}/:T@-i@-:  >> $PLOT

echo "electron density in xz"
      XYDATA=xz_slice_eden
      psbasemap -R${ZPA} -J${ZBOX} -B${ZAXES}WSne -P -K -O -X-5i -Y-3.5i >> $PLOT 
      xyz2grd $XYDATA -Gdata1.grd -R${ZDR} -I${ZMESH} 
      grdinfo data1.grd
      grdgradient data1.grd -A30 -Nt -Gdata1_int.grd
# plot image
      grdimage data1.grd -JX -E$DPI -R${ZDR} -T -O -K -C../dens.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$ZSCALE -O -K -B${SSRHO}/:n@-e@-:  >> $PLOT


      \rm *.grd .gmtcommands

echo "cold electron current in xz"
      JX=xz_slice_jxe
      JY=xz_slice_jze

      psbasemap -R${ZPA} -J${ZBOX} -B${ZAXES}wSne -P -K -O -X2.5i -Y0 >> $PLOT 
      xyz2grd $JX -Gjx.grd -R${ZDR} -I${ZMESH} 
      xyz2grd $JY -Gjy.grd -R${ZDR} -I${ZMESH}
      grdinfo jx.grd
      grdvector jx.grd jy.grd -JX -O -K -Q$ARROW -C../je.cpt -G0 -S${JEVEC}i >> $PLOT
       psscale -C../je.cpt -D$ZSCALE -O -K -B${SSJE}/:J@-e@-: >> $PLOT

      \rm *.grd .gmtcommands

echo "electron temperature (K.E.) in xz"
      TE=xz_slice_te

      psbasemap -R${ZPA} -J${ZBOX} -B${ZAXES}wSnE -P -K -O -X2.5i -Y0 >> $PLOT
# Convert xyz data to grid file
      xyz2grd $TE -Gdata1.grd -R${ZDR} -I${ZMESH}
      grdinfo data1.grd
# Make colour map
      grd2cpt  data1.grd  -Cseis -I  -L${TERANGE}   -S${TEMAP} > te.cpt
      grdimage data1.grd  -J${ZBOX} -E$DPI -R${ZDR} -T -O -K -Cte.cpt -X0 -Y0 >> $PLOT
      psscale -Cte.cpt -D$ZSCALE -O -K -B${SSTE}/:T@-e@-: >> $PLOT


echo "hot electron density in xz"
      XYDATA=xz_slice_nhot
      XY2=xz_slice_nhot
      psbasemap -R${ZPA} -J${ZBOX} -B${ZAXES}WSne -P -K -O -X-5i -Y-3.5i >> $PLOT 
      xyz2grd $XYDATA -Gdata1.grd -R${ZDR} -I${ZMESH} 
#      grdmath data1.grd data2.grd ADD = data3.grd
      grdinfo data1.grd
      grdgradient data1.grd -A30 -Nt -Gdata1_int.grd
      grdimage data1.grd -JX -E$DPI -R${ZDR} -T -O -K -C../dens.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$ZSCALE -O -K -B${SSRHO}/:n@-hot@-/n@-c@-:  >> $PLOT

echo "hot electron current in xz"
      JX=xz_slice_jxhot
      JY=xz_slice_jzhot

      psbasemap -R${ZPA} -J${ZBOX} -B${ZAXES}wnSe -P -K -O -X2.5i -Y0 >> $PLOT 
      xyz2grd $JX -Gjx.grd -R${ZDR} -I${ZMESH} 
      xyz2grd $JY -Gjy.grd -R${ZDR} -I${ZMESH}
      grdinfo jx.grd
      grdvector jx.grd jy.grd -JX -O -K -Q$ARROW -C../je.cpt -G0 -S${JEVEC}i >> $PLOT
       psscale -C../je.cpt -D$ZSCALE -O -K -B${SSJE}/:J@-e@-: -U"xz-slices of $RUN at ${TRUN} ($TIMESTAMP)" >> $PLOT



#echo "Electric field in xz"
#      EX=xz_slice_ex
#      EY=xz_slice_ez

#      psbasemap -R${ZPA} -J${ZBOX} -B${ZAXES}wSne -P -K -O -X2.5i -Y0 >> $PLOT 
#      xyz2grd $EX -Gex.grd -R${ZDR} -I${ZMESH} 
#      xyz2grd $EY -Gey.grd -R${ZDR} -I${ZMESH}
#      grdinfo ex.grd
#      grdvector ex.grd ey.grd -I1,1 -JX -O  -K -Q$ARROW -C../e.cpt -G0 -S${EVEC}i >> $PLOT
#      psscale -C../e.cpt -D$ZSCALE -O -B${SSE}/:E:  >> $PLOT

      \rm *.grd .gmtcommands

echo "Potential in xz"
  echo "PHIZPA=${PHIPA}"
  echo "PHIZDR=${PHIDR}"
  echo "PHIMESH=${PHIMESH}"
  echo "PHIAXES=${PHIAXES}"
  echo "PACONV=${PACONV}"
  echo "ZPACONV=${ZPACONV}"

  cat <<EOF > potlevels
-0.1 A
-0.01 A
0.01 	A
0.1 C
0.5 A
1    C
2 A
3 C
4       A
5	C
10       A
20	C
50       C
60       C
EOF
 


# xz-slice
      XYDATA=xz_slice_phiw

# Convert xyz data to grid file
      xyz2grd $XYDATA -Gdata1.grd -R${PHIZDR} -I${PHIZMESH}
    grdinfo data1.grd
      psbasemap -R${PHIZPA} -J$ZBOX -B${PHIAXES}wSnE -X2.5i -Y0 -P -K -O >> $PLOT
     grdimage data1.grd  -J$ZBOX -E100 -R${PHIZDR} -T -O -K -C../pot.cpt -X0 -Y0 >> $PLOT
    grdcontour data1.grd  -Q10 -J$ZBOX -R${PHIZDR} -O -K -Cpotlevels -X0 -Y0 >> $PLOT
    psscale -C../pot.cpt -D1.i/2.5i/.8i/0.1ih -O  -B1/:" Potential (MV)": >> $PLOT





 #    gzip $PLOT





     PLOT=../plots/phase_$TIMESTAMP.ps


echo "electron pxpy"
# -------------

      XYDATA=fpxpy_ele
      psbasemap -R${UPA} -J${UBOX} -B${UAXES}SWne -P -K  -X1i -Y7i > $PLOT
      xyz2grd $XYDATA -Gdata1.grd -R${UDR} -I${UMESH} 
      grdinfo data1.grd
      grdimage data1.grd -J${UBOX} -E$DPI  -R${UDR} -T -O -K -C../f.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$PSCALE -O -K -B${SSFP}/:p@-y@--p@-x@-: >> $PLOT
      \rm *.grd .gmtcommands
      
echo "electron px-x"
      XYDATA=fpxx_ele
      psbasemap -R${UXPA} -J${UBOX} -B${UXAXES}SEwn -P  -K -O -X3.0i -Y0 >> $PLOT 
      xyz2grd $XYDATA -Gdata1.grd -R${UXDR} -I${UXMESH} 
      grdinfo data1.grd
      grdimage data1.grd -J${UBOX} -E$DPI  -R${UXDR} -T -O -K -C../f.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$PSCALE -O -K -B${SSFP}/:p@-x@--x: >> $PLOT
      \rm *.grd .gmtcommands

echo "ion px-py"
      XYDATA=fpxpy_ion
      psbasemap -R${UIPA} -J${UIBOX} -B${UIAXES}SWne -P -K -O -X-3i -Y-3i >> $PLOT
      xyz2grd $XYDATA -Gdata1.grd -R${UIDR} -I${UIMESH}
      grdinfo data1.grd
      grdimage data1.grd -J${UIBOX} -E$DPI  -R${UIDR} -T -O -K -C../f.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$PSCALE -O -K -B${SSIFP}/:pyi-pxi: >> $PLOT

echo "ion px-pz"
      XYDATA=fpxpz_ion
      psbasemap -R${UIPA} -J${UIBOX} -B${UIAXES}SWne -P -K -O -X3i -Y0 >> $PLOT
      xyz2grd $XYDATA -Gdata1.grd -R${UIDR} -I${UIMESH}
      grdinfo data1.grd
      grdimage data1.grd -J${UIBOX} -E$DPI  -R${UIDR} -T -O -K -C../f.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$PSCALE -O -K -B${SSIFP}/:pzi-pxi: >> $PLOT

echo "ion px-x"
      XYDATA=fpxx_ion
      psbasemap -R${UXIPA} -J${UIBOX} -B${UXIAXES}SWne -P -K -O -X-3i -Y-3i >> $PLOT
      xyz2grd $XYDATA -Gdata1.grd -R${UXIDR} -I${UXIMESH}
      grdinfo data1.grd
      grdimage data1.grd -J${UIBOX} -E$DPI  -R${UXIDR} -T -O -K -C../f.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$PSCALE -O -K -B${SSIFP}/:p@-xi@--x: -U"xy-slices of $RUN at $TRUN ($TIMESTAMP)" >> $PLOT

echo "ion py-x"
      XYDATA=fpzx_ion
      psbasemap -R${UZIPA} -J${UIBOX} -B${UZIAXES}SWne -P -K -O -X3i -Y0 >> $PLOT
      xyz2grd $XYDATA -Gdata1.grd -R${UZIDR} -I${UZIMESH}
      grdinfo data1.grd
      grdimage data1.grd -J${UIBOX} -E$DPI  -R${UZIDR} -T -O -K -C../f.cpt -X0 -Y0 >> $PLOT
      psscale -C../dens.cpt -D$PSCALE -O -B${SSIFP}/:p@-yi@--x:  >> $PLOT

 #     gzip $PLOT


#  -------------------------
#  Hot electron/ion spectra
#  -------------------------

     PLOT=../plots/fhot_$TIMESTAMP.ps
     rm $PLOT
     echo "Energy spectra"
echo $UMEVMAX 
echo $UIMEVMAX 
  eval `echo $UMEVMAX |  awk '{ t = $1/5.0; printf  "UTICK=%s",t}'`
  eval `echo $UIMEVMAX |  awk '{ t = $1/5.0; printf  "UITICK=%s",t}'`

#plotr = `cat $XYDATA | minmax -I100/25 -C`
#echo $plotr
# Uses log10 scale y-axis

echo "hot electron spectrum"
    XYDATA=fhot_ele 
    psxy   -R0/${UMEVMAX}/1/1000000 -JX3i/2il -X2i -Y6i -K -W1.5p $XYDATA -Ba${UTICK}:"Energy (MeV)":/a1f2:"fhot":WSne > $PLOT
    psxy -R -JX -O -K -Sp0.03i $XYDATA >> $PLOT

echo "forward directed ions"
    XYDATA=fhot_ion_forw 
    psxy  -R0/${UIMEVMAX}/1/1000000 -JX3i/2il -X0i -Y-3i -O -K -W1.5p $XYDATA -Ba${UITICK}:"Energy (MeV)":/a1f2:"fhoti (forward)":WSne  >> $PLOT
    psxy -R -JX -O -K -Sp0.03i $XYDATA >> $PLOT

echo "backward directed ions"
    XYDATA=fhot_ion_back  
    psxy   -U/-2.5i/-1.25i/"Hot electron & ion spectra of $RUN at $TRUN ($TIMESTAMP)"  -R0/${UIMEVMAX}/1/1000000 -JX3i/2il -X5i -Y0i -O -K -W1.5p $XYDATA  -Ba${UITICK}:"Energy (MeV)":/a1f2:"fhoti (back)":WSne  >> $PLOT
    psxy -R -JX -O  -Sp0.03i $XYDATA  >> $PLOT

    echo " .. done"
#  -------------------------
#  Angular far-field ion distribution
#  -------------------------

 echo "Far field distributions"
     PLOT=../plots/fang_$TIMESTAMP.ps
  echo "ALPHAPA=${AIPA}"
  echo "ALPHADR=${AIDR}"
  echo "ALPHAMESH=${AIMESH}"
  echo "ALPHAAXES=${AIAXES}"
  echo "UIMEV1=${UIMEV1}"
  echo "UIMEV2=${UIMEV2}"

  ABOX=X2.5i/2.5i
  AAX=-B15/15f15WSne
      XYDATA=fang_ion
#      CAPTION="-B50/:" U < ":"
      psbasemap -R${AIPA} -J$ABOX $AAX -P -K  -X1i -Y7i > $PLOT 
      xyz2grd $XYDATA -Gdata2.grd -R${AIDR} -I${AIMESH} 
      grdinfo data2.grd

      grdimage data2.grd  -J$ABOX -E$DPI -R${AIDR} -T -O -K -C../ualpha.cpt -X0 -Y0 >> $PLOT
      psscale -C../ualpha.cpt -D.5i/3i/1i/0.1ih -O -K -B$UANGMAX/:" Ui/MeV": >> $PLOT
      cat << EOF | pstext -R${AIDR} -JX -O -K -N -X0 -Y0i >> $PLOT
-30. -80. 14 0.0 1 2 $XYDATA
EOF

      XYDATA=fang_ion1
      CAPTION=" ${UIMEV1} < U < ${UIMEV2}"
      psbasemap -R${AIPA} -J$ABOX $AAX -P -K -O -X4i -Y0 >> $PLOT 
      xyz2grd $XYDATA -Gdata2.grd -R${AIDR} -I${AIMESH} 
      grdinfo data2.grd
      grdimage data2.grd  -J$ABOX -E$DPI -R${AIDR} -T -O -K -C../alpha.cpt -X0 -Y0 >> $PLOT
      psscale -C../alpha.cpt -D.5i/3i/1i/0.1ih -O -K -B50/:"U1 < U < U2": >> $PLOT
      cat << EOF | pstext -R${AIDR} -JX -O -K -N -X0 -Y0i >> $PLOT
-30. -80. 14 0.0 1 2 $XYDATA
EOF
      XYDATA=fang_ion2
#      CAPTION="   U > ${UIMEV2}"
      psbasemap -R${AIPA} -J$ABOX $AAX -P -K -O -X-4i -Y-5i >> $PLOT 
      xyz2grd $XYDATA -Gdata2.grd -R${AIDR} -I${AIMESH} 
      grdinfo data2.grd
      grdimage data2.grd  -J$ABOX -E$DPI -R${AIDR} -T -O -K -C../alpha.cpt -X0 -Y0 >> $PLOT
      psscale -C../alpha.cpt -D.5i/3i/1i/0.1ih -O -K -B50/:" U > U2": >> $PLOT
      cat << EOF | pstext -R${AIDR} -JX -O -K -N -X0 -Y0i >> $PLOT
-30. -80. 14 0.0 1 2 $XYDATA
EOF
      XYDATA=fang_back
#      CAPTION="   U > ${UIMEV1} backward"
      psbasemap -R${AIPA} -J$ABOX $AAX -P -K -O -X4i -Y0 >> $PLOT 
      xyz2grd $XYDATA -Gdata2.grd -R${AIDR} -I${AIMESH} 
      grdinfo data2.grd
      grdimage data2.grd  -J$ABOX -E$DPI -R${AIDR} -T -O -K -C../alpha.cpt -X0 -Y0 >> $PLOT
      psscale -C../alpha.cpt -D.5i/3i/1i/0.1ih -O -K -B50/:" U > U1, backward": -U/-2.5i/-1.25i/"Far-field ion emission of $RUN at $TRUN ($TIMESTAMP)"  >> $PLOT
      cat << EOF | pstext -R${AIDR} -JX -O -N -X0 -Y0i >> $PLOT
-30. -80. 14 0.0 1 2 $XYDATA
EOF
      cd ..
  fi

done
cd plots
tar cvf images.tar *.ps
rm -f images.tar.gz
gzip images.tar
cd $MYDIR
echo "... done"
