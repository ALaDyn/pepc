HELP = "\
\# Makefile for gcc 4.9 (self-compiled)\n\
"

MACH     = linux_gcc-4.9

DEBUG    = 1
OMP      = 1
GPERFTOOLS = 0

RANLIB   = ranlib

MAKE     = make

AR       = ar
ARFLAGS  = -rs

CPP      = mpicc
CPPFLAGS = -E -x c -P -C -ffreestanding
                       # ^----- this prevents errors due to nasty automatic pre-inclusion of stdc-predefs.h when using cpp for fortran code

INLINING = -fkeep-inline-functions -findirect-inlining -mstringop-strategy=unrolled_loop -flto-partition=none -finline-limit=120000 --param large-function-insns=120000 --param large-unit-insns=120000 --param large-function-growth=1000 --param inline-unit-growth=1000 --param max-inline-insns-recursive-auto=120000 --param max-inline-recursive-depth-auto=500 -fipa-matrix-reorg -flto -ffat-lto-objects -fuse-linker-plugin

FWARNINGS = -Wall -Wconversion -Warray-temporaries -Wcharacter-truncation -Wline-truncation -Wno-unused-parameter -Wintrinsic-shadow -Wfunction-elimination -Wrealloc-lhs-all
FFEATURES = -frecursive -fimplicit-none -ffree-line-length-none -fcoarray=none

ifeq ($(DEBUG), 1)
  FFLAGS   = -Og -g -gdwarf-3 -gstrict-dwarf \
    -fcheck=all -frange-check -fbacktrace -fvar-tracking -fstack-protector-all \
    $(FFEATURES) \
    $(FWARNINGS)
  CFLAGS   = -Og -g -gdwarf-3 -gstrict-dwarf -pthread -Wall -fstack-protector-all
  LDFLAGS  = -Og -g -gdwarf-3 -gstrict-dwarf -pthread
else
  FFLAGS   = -O3 \
    -fsign-zero -fno-protect-parens -faggressive-function-elimination \
    $(INLINING) \
    $(FFEATURES) \
    $(FWARNINGS)
  CFLAGS   = -O3 -pthread -Wall
  LDFLAGS  = -O3 -pthread $(INLINING)
  CPPFLAGS += -DNDEBUG
endif

# solve the following issue with lto:
#`walk_worker_thread' referenced in section `.text' of /tmp/ccB14zE9.lto.o: defined in discarded section `.text' of module_walk_pthreads.o (symbol from plugin)
#`walk_worker_thread' referenced in section `.rodata' of /tmp/ccB14zE9.lto.o: defined in discarded section `.text' of module_walk_pthreads.o (symbol from plugin)
#`run_communication_loop' referenced in section `.rodata' of /tmp/ccB14zE9.lto.o: defined in discarded section `.text' of module_tree_communicator.o (symbol from plugin)
LDFLAGS += -u walk_worker_thread -u run_communication_loop

ifeq ($(OMP), 1)
  FFLAGS   += -fopenmp
  LDFLAGS  += -fopenmp
endif

FCPRE    =
FC       = mpif90

CCPRE    =
CC       = mpicc

LDPRE    =
LD       = mpif90
LDLIBS   =

RM       = rm -rf

COMPILER = $(shell $(FC) --version | head -n 1)

ifeq ($(GPERFTOOLS), 1)
  # download and installation: http://code.google.com/p/gperftools/
  # for usage see http://code.google.com/p/gperftools/wiki/GooglePerformanceTools
  LDFLAGS+=-L${HOME}/programs/lib64
  LDLIBS += -ltcmalloc -lprofiler
endif
