module math
  implicit none

    real*8, parameter :: pi = 3.14159265358979323846_8
    
    integer, parameter :: MAXN = 16
    integer, parameter :: MAXL = 12
    
    ! from besselstuff.nb Mathematica-Worksheet
    real*8, parameter :: SphericalBesselJZero(0:MAXL, 1:MAXN) = reshape([ &
      3.14159265359_8, 4.49340945791_8, 5.76345919689_8, 6.98793200050_8, 8.18256145259_8, 9.35581211105_8, 10.5128354081_8, 11.6570321925_8, 12.7907817121_8, 13.9158226104_8, 15.0334693039_8, 16.1447429423_8, 17.2504547841_8, &
      6.28318530718_8, 7.72525183694_8, 9.09501133064_8, 10.4171185475_8, 11.7049071546_8, 12.9665301728_8, 14.2073924588_8, 15.4312892103_8, 16.6410028815_8, 17.8386431992_8, 19.0258535361_8, 20.2039426328_8, 21.3739721812_8, &
      9.42477796077_8, 10.9041216594_8, 12.3229409706_8, 13.6980231532_8, 15.0396647076_8, 16.3547096394_8, 17.6479748702_8, 18.9229991985_8, 20.1824707649_8, 21.4284869721_8, 22.6627206581_8, 23.8865307560_8, 25.1010385210_8, &
      12.5663706144_8, 14.0661939128_8, 15.5146030109_8, 16.9236212852_8, 18.3012559595_8, 19.6531521018_8, 20.9834630689_8, 22.2953480191_8, 23.5912748180_8, 24.8732139239_8, 26.1427676434_8, 27.4012592589_8, 28.6497962617_8, &
      15.7079632679_8, 17.2207552719_8, 18.6890363554_8, 20.1218061745_8, 21.5254177334_8, 22.9045506479_8, 24.2627680424_8, 25.6028559538_8, 26.9270407788_8, 28.2371343600_8, 29.5346341078_8, 30.8207940865_8, 32.0966767254_8, &
      18.8495559215_8, 20.3713029593_8, 21.8538742227_8, 23.3042469889_8, 24.7275655478_8, 26.1277501372_8, 27.5078683649_8, 28.8703733470_8, 30.2172627094_8, 31.5501883818_8, 32.8705345977_8, 34.1794746665_8, 35.4780131752_8, &
      21.9911485751_8, 23.5194524987_8, 25.0128032023_8, 26.4767636645_8, 27.9155761994_8, 29.3325625786_8, 30.7303807316_8, 32.1111962397_8, 33.4768008195_8, 34.8286965377_8, 36.1681571359_8, 37.4962736358_8, 38.8139888812_8, &
      25.1327412287_8, 26.6660542588_8, 28.1678297080_8, 29.6426045403_8, 31.0939332141_8, 32.5246612886_8, 33.9371083026_8, 35.3331941827_8, 36.7145291272_8, 38.0824790873_8, 39.4382144800_8, 40.7827470981_8, 42.1169585325_8, &
      28.2743338823_8, 29.8115987909_8, 31.3201417074_8, 32.8037323852_8, 34.2653900861_8, 35.7075769531_8, 37.1323317249_8, 38.5413648517_8, 39.9361278109_8, 41.3178646902_8, 42.6876512847_8, 44.0464252109_8, 45.3950094399_8, &
      31.4159265359_8, 32.9563890398_8, 34.4704883313_8, 35.9614058047_8, 37.4317367682_8, 38.8836309555_8, 40.3188925092_8, 41.7390528671_8, 43.1454250176_8, 44.5391446334_8, 45.9212017638_8, 47.2924656053_8, 48.6537041118_8, &
      34.5575191895_8, 36.1006222444_8, 37.6193657536_8, 39.1164701903_8, 40.5941896534_8, 42.0544164128_8, 43.4987571413_8, 44.9285896767_8, 46.3451060653_8, 47.7493457344_8, 49.1422214247_8, 50.5245397256_8, 51.8970175245_8, &
      37.6991118431_8, 39.2444323612_8, 40.7671158214_8, 42.2695149778_8, 43.7536054311_8, 45.2210650159_8, 46.6733329250_8, 48.1116545550_8, 49.5371160745_8, 50.9506714535_8, 52.3531638708_8, 53.7453428658_8, 55.1278782244_8, &
      40.8407044967_8, 42.3879135681_8, 43.9139818114_8, 45.4209639723_8, 46.9106054901_8, 48.3844038606_8, 49.8436551888_8, 51.2894900803_8, 52.7229017097_8, 54.1447680563_8, 55.5558697207_8, 56.9569043527_8, 58.3484984443_8, &
      43.9822971503_8, 45.5311340140_8, 47.0601416128_8, 48.5711298516_8, 50.0656518347_8, 51.5450520426_8, 53.0105034817_8, 54.4630367429_8, 55.9035630242_8, 57.3328925814_8, 58.7517496714_8, 60.1607847680_8, 61.5605846363_8, &
      47.1238898038_8, 48.6741442320_8, 50.2057283367_8, 51.7202484304_8, 53.2190952897_8, 54.7034825077_8, 56.1744764965_8, 57.6330202625_8, 59.0799524622_8, 60.5160228380_8, 61.9419048385_8, 63.3582060271_8, 64.7654767358_8, &
      50.2654824574_8, 51.8169824873_8, 53.3508435853_8, 54.8685009575_8, 56.3712071531_8, 57.8600629728_8, 59.3360419635_8, 60.8000100548_8, 62.2527414665_8, 63.6949317159_8, 65.1272083475_8, 66.5501398542_8, 67.9642431481_8  &
      ], shape(SphericalBesselJZero))
      
    real*8, parameter :: BesselJZero(0:MAXL, 1:MAXN) = reshape([ &
      2.40482555770_8, 3.83170597021_8, 5.13562230184_8, 6.38016189592_8, 7.58834243451_8, 8.77148381596_8, 9.93610952423_8, 11.0863700192_8, 12.2250922637_8, 13.3543004779_8, 14.4755006861_8, 15.5898478845_8, 16.6982499339_8, &
      5.52007811029_8, 7.01558667043_8, 8.41724414069_8, 9.76102312968_8, 11.0647094885_8, 12.3386041975_8, 13.5892901706_8, 14.8212687270_8, 16.0377741909_8, 17.2412203825_8, 18.4334636670_8, 19.6159669040_8, 20.7899063601_8, &
      8.65372791291_8, 10.1734681351_8, 11.6198411721_8, 13.0152007217_8, 14.3725366716_8, 15.7001740797_8, 17.0038196678_8, 18.2875828325_8, 19.5545364310_8, 20.8070477893_8, 22.0469853647_8, 23.2758537263_8, 24.4948850439_8, &
      11.7915344390_8, 13.3236919363_8, 14.7959517824_8, 16.2234661603_8, 17.6159660498_8, 18.9801338752_8, 20.3207892136_8, 21.6415410199_8, 22.9451731319_8, 24.2338852578_8, 25.5094505542_8, 26.7733225455_8, 28.0267099500_8, &
      14.9309177085_8, 16.4706300509_8, 17.9598194950_8, 19.4094152264_8, 20.8269329570_8, 22.2177998966_8, 23.5860844356_8, 24.9349278877_8, 26.2668146412_8, 27.5837489636_8, 28.8873750635_8, 30.1790611788_8, 31.4599600353_8, &
      18.0710639679_8, 19.6158585105_8, 21.1169970530_8, 22.5827295931_8, 24.0190195248_8, 25.4303411542_8, 26.8201519834_8, 28.1911884595_8, 29.5456596710_8, 30.8853789677_8, 32.2118561997_8, 33.5263640756_8, 34.8299869903_8, &
      21.2116366299_8, 22.7600843806_8, 24.2701123136_8, 25.7481666993_8, 27.1990877660_8, 28.6266183073_8, 30.0337223866_8, 31.4227941923_8, 32.7958000373_8, 34.1543779239_8, 35.4999092054_8, 36.8335713419_8, 38.1563775047_8, &
      24.3524715308_8, 25.9036720876_8, 27.4205735500_8, 28.9083507809_8, 30.3710076671_8, 31.8117167240_8, 33.2330417628_8, 34.6370893521_8, 36.0256150639_8, 37.4000999772_8, 38.7618070179_8, 40.1118232710_8, 41.4510923079_8, &
      27.4934791320_8, 29.0468285349_8, 30.5692044955_8, 32.0648524071_8, 33.5371377118_8, 34.9887812946_8, 36.4220196683_8, 37.8387173829_8, 39.2404479952_8, 40.6285537190_8, 42.0041902367_8, 43.3683609475_8, 44.7219435432_8, &
      30.6346064684_8, 32.1896799110_8, 33.7165195092_8, 35.2186707386_8, 36.6990011287_8, 38.1598685620_8, 39.6032394161_8, 41.0307736916_8, 42.4438877433_8, 43.8438014203_8, 45.2315741035_8, 46.6081326763_8, 47.9742935313_8, &
      33.7758202136_8, 35.3323075501_8, 36.8628565113_8, 38.3704724348_8, 39.8576273022_8, 41.3263832540_8, 42.7784816132_8, 44.2154085053_8, 45.6384441822_8, 47.0487007377_8, 48.4471513873_8, 49.8346535104_8, 51.2119670041_8, &
      36.9170983537_8, 38.4747662348_8, 40.0084467335_8, 41.5207196704_8, 43.0137377234_8, 44.4893191232_8, 45.9490159980_8, 47.3941657556_8, 48.8259303816_8, 50.2453269553_8, 51.6532516682_8, 53.0504989591_8, 54.4377769283_8, &
      40.0584257646_8, 41.6170942128_8, 43.1534537784_8, 44.6697431166_8, 46.1678535129_8, 47.6493998067_8, 49.1157737248_8, 50.5681846798_8, 52.0076914567_8, 53.4352271570_8, 54.8516190760_8, 56.2576047151_8, 57.6538448119_8, &
      43.1997917132_8, 44.7593189977_8, 46.2979966772_8, 47.8177856915_8, 49.3203606864_8, 50.8071652030_8, 52.2794539036_8, 53.7383253720_8, 55.1847479393_8, 56.6195802665_8, 58.0435879282_8, 59.4574569084_8, 60.8618046825_8, &
      46.3411883717_8, 47.9014608872_8, 49.4421641104_8, 50.9650299062_8, 52.4715513985_8, 53.9630265584_8, 55.4405920689_8, 56.9052499920_8, 58.3578890253_8, 59.7993016310_8, 61.2301979773_8, 62.6512173882_8, 64.0629378249_8, &
      49.4826098974_8, 51.0435351836_8, 52.5860235068_8, 54.1116155698_8, 55.6216509098_8, 57.1173027815_8, 58.5996056312_8, 60.0694769983_8, 61.5277351668_8, 62.9751135342_8, 64.4122724129_8, 65.8398088044_8, 67.2582645563_8  &      
      ], shape(BesselJZero))
  
  contains
    
    real*8 function factorial(n)
        implicit none
        integer, intent(in) :: n

        if (n<0) then
          write(*,*) "Tried to calculate factorial of negative argument."
	  stop
        end if

        if (n>170) then
          write(*,*) "Tried to calculate factorial with n>170. This would lead to numeric overflow."
	  stop
        end if

        select case (n)
          case ( 0)
            factorial =                            1._8
          case ( 1)
            factorial =                            1._8
          case ( 2)
            factorial =                            2._8
          case ( 3)
            factorial =                            6._8
          case ( 4)
            factorial =                           24._8
          case ( 5)
            factorial =                          120._8
          case ( 6)
            factorial =                          720._8
          case ( 7)
            factorial =                         5040._8
          case ( 8)
            factorial =                        40320._8
          case ( 9)
            factorial =                       362880._8
          case (10)
            factorial =                      3628800._8
          case (11)
            factorial =                     39916800._8
          case (12)
            factorial =                    479001600._8
          case (13)
            factorial =                   6227020800._8
          case (14)
            factorial =                  87178291200._8
          case (15)
            factorial =                1307674368000._8
          case (16)
            factorial =               20922789888000._8
          case (17)
            factorial =              355687428096000._8
          case (18)
            factorial =             6402373705728000._8
          case (19)
            factorial =           121645100408832000._8
          case (20)
            factorial =          2432902008176640000._8
          case (21)
            factorial =         51090942171709440000._8
          case (22)
            factorial =       1124000727777607680000._8
          case (23)
            factorial =      25852016738884976640000._8
          case (24)
            factorial =     620448401733239439360000._8
          case default
            factorial = gamma(real(n+1, 8))
        end select
    end function factorial   
    
    
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    !>
    !> Computes the associated Legendre polynomial \f$P_{lm}(x)\f$.
    !> Here m and l are integers satisfying  \f$0 \leq m \leq l\f$,
    !> while x lies in the range \f$-1 \leq x \leq 1\f$.
    !>
    !> Code fragment for \f$P_l^m(x)\f$ taken from
    !>
    !> Numerical Recipes in Fortran 77: The Art of Scientific Computing
    !>              (ISBN 0-521-43064-X)
    !> pg. 246ff
    !>
    !> and modified to give \f$P_{lm}(x)\f$:
    !> \f$ P_{lm}(x) = (-1)^m P_l^m (x) \f$, see
    !>
    !> Abramowitz and Stegun: Handbook of Mathematical Functions
    !> Section 8. Legendre Functions (pg. 332)
    !>
    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    real*8 function LegendreP(l,m,x)
      implicit none
      integer, intent(in) :: l, m
      real*8 ::x

      integer :: i,ll
      real*8 :: fact,pll,pmm,pmmp1,somx2

      pll = 0._8

      if ( (m < 0) .or. (m > l) .or. (abs(x) > 1) .or.  (l<0)) then
        write(*,*) 'Invalid arguments for LegendreP(',l,m,x,')'
	stop
      endif

      pmm = 1._8     ! Compute P_m^m

      if (m > 0) then
        somx2 = sqrt((1._8-x)*(1._8+x))
        fact  = 1._8

        do i = 1,m
           pmm  = -pmm * fact * somx2
           fact = fact+2._8
        enddo
      endif

      if (l == m) then
        LegendreP = pmm
      else
        pmmp1 = x*(2._8*m+1._8)*pmm  ! Compute P_m+1^m

        if (l == m+1) then
          LegendreP = pmmp1
        else                  ! Compute P_l^m , l > m + 1
          do ll = m+2,l
            pll   = (x*(2._8*ll-1._8)*pmmp1-(ll+m-1._8)*pmm)/real(ll-m,kind=8)
            pmm   = pmmp1
            pmmp1 = pll
          enddo

          LegendreP = pll
        endif
      endif

      LegendreP = (-1._8)**m * LegendreP

    end function LegendreP
    
    
    ! see notes sheet [D] and besselstuff.nb
    real*8 function SphericalBesselJ(l,x)
      implicit none
      real*8, intent(in) :: x
      integer, intent(in) :: l
      
      integer :: p
      real*8 :: cx, sxx
      
      integer, parameter :: maxp = 6
      
      real*8, parameter :: Ccoeffs(0:maxp, 0:12) = reshape([ &
                              0._8,           0._8,           0._8,        0._8,      0._8,  0._8, 0._8, &
                             -1._8,           0._8,           0._8,        0._8,      0._8,  0._8, 0._8, &
                             -3._8,           0._8,           0._8,        0._8,      0._8,  0._8, 0._8, &
                            -15._8,           1._8,           0._8,        0._8,      0._8,  0._8, 0._8, &
                           -105._8,          10._8,           0._8,        0._8,      0._8,  0._8, 0._8, &
                           -945._8,         105._8,          -1._8,        0._8,      0._8,  0._8, 0._8, &
                         -10395._8,        1260._8,         -21._8,        0._8,      0._8,  0._8, 0._8, &
                        -135135._8,       17325._8,        -378._8,        1._8,      0._8,  0._8, 0._8, &
                       -2027025._8,      270270._8,        6930._8,       36._8,      0._8,  0._8, 0._8, &
                      -34459425._8,     4729725._8,     -135135._8,      990._8,     -1._8,  0._8, 0._8, &
                     -654729075._8,    91891800._8,    -2837835._8,    25740._8,    -55._8,  0._8, 0._8, &
		   -13749310575._8,  1964187225._8,   -64324260._8,   675675._8,  -2145._8,  1._8, 0._8, &
  	          -316234143225._8, 45831035250._8, -1571349780._8, 18378360._8, -75075._8, 78._8, 0._8  & 
            ], shape(Ccoeffs))
      
      real*8, parameter :: Scoeffs(0:maxp, 0:12) = reshape([ &
                              1._8,             0._8,           0._8,          0._8,       0._8,     0._8, 0._8, &
                              1._8,             0._8,           0._8,          0._8,       0._8,     0._8, 0._8, &
                              3._8,            -1._8,           0._8,          0._8,       0._8,     0._8, 0._8, &
                             15._8,            -6._8,           0._8,          0._8,       0._8,     0._8, 0._8, &
                            105._8,           -45._8,           1._8,          0._8,       0._8,     0._8, 0._8, &
                            945._8,          -420._8,          15._8,          0._8,       0._8,     0._8, 0._8, &
                          10395._8,         -4725._8,         210._8,         -1._8,       0._8,     0._8, 0._8, &
                         135135._8,        -62370._8,        3150._8,        -28._8,       0._8,     0._8, 0._8, &
                        2027025._8,       -945945._8,       51975._8,       -630._8,       1._8,     0._8, 0._8, &
                       34459425._8,     -16216200._8,      945945._8,     -13860._8,      45._8,     0._8, 0._8, &
                      654729075._8,    -310134825._8,    18918900._8,    -315315._8,    1485._8,    -1._8, 0._8, &
                    13749310575._8,   -6547290750._8,   413513100._8,   -7567560._8,   45045._8,   -66._8, 0._8, &
                   316234143225._8, -151242416325._8,  9820936125._8, -192972780._8, 1351350._8, -3003._8, 1._8  &
            ], shape(Scoeffs))

      if (x==0._8) then
        if (l==0) then
	  sphericalBesselJ = 1._8
	else
	  sphericalBesselJ = 0._8
	endif
      else
	cx   = cos(x)
	sxx  = sin(x)/x
      
        sphericalBesselJ = 0.
	
	do p=0,maxp
	  sphericalBesselJ = sphericalBesselJ + x**(2*p-l) * ( Ccoeffs(p,l) * cx +  Scoeffs(p,l) * sxx )
	end do
	
      endif
      
    end function
    
    
    real*8 function Rfunc_Raitza(n,l,a,r)
      implicit none
      integer, intent(in) :: n, l
      real*8, intent(in) :: r, a
      
      real*8 :: xnl, NNnl
      
      xnl          = SphericalBesselJZero(l,n)
      NNnl         = (a*a*a)/2._8*SphericalBesselJ(l+1,xnl)
      Rfunc_Raitza = NNnl * SphericalBesselJ(l, xnl/a * r)
      
    end function
    
    
    real*8 function Rfunc_Wang(n,l,a,r)
      implicit none
      integer, intent(in) :: n, l
      real*8, intent(in) :: r, a
      
      real*8 :: xnl, NNnl
      
      xnl        = BesselJZero(l,n)
      NNnl       = a*a/2._8 * ( bessel_jn(l+1, xnl) )**2
      Rfunc_Wang = bessel_jn(l, xnl/a * r) / sqrt( NNnl)
      
    end function
    
    real*8 function MMfunc(l,m)
      implicit none
      integer, intent(in) :: l,m
      
      if (m<=l) then
        MMfunc = sqrt( (2._8*l+1._8)/(4._8*pi) * factorial(l-m)/factorial(l+m) )
      else
        MMfunc = 0._8
      endif
    end function
    
    real*8 function Pfunc(l,m,costheta)
      implicit none
      integer, intent(in) :: l,m
      real*8, intent(in) :: costheta
      
      if (m<=l) then
        Pfunc = LegendreP(l,m,costheta) * sqrt(1._8-costheta*costheta)
      else
        Pfunc = 0._8
      endif
    end function

    real*8 function Efunc(m,Phi)
      implicit none
      integer, intent(in) :: m
      real*8, intent(in) :: Phi
      
      Efunc = cos(m*Phi)
      
    end function
    
    real*8 function spherical_r(rv,r2)
      implicit none
      real*8, intent(in) :: rv(3)
      real*8, intent(out), optional :: r2
      real*8 :: rsq
      
      rsq           = dot_product(rv, rv)
      spherical_r   = sqrt(rsq)
      
      if (present(r2)) r2 = rsq
      
    end function

    real*8 function spherical_costheta(rv)
      implicit none
      real*8, intent(in) :: rv(3)
      real*8 :: r

      r = spherical_r( rv )
	
      if (r > 0._8) then
  	spherical_costheta = rv(3)/r
      else
	spherical_costheta = 1._8
      endif
      
   end function
   
   
    real*8 function spherical_phi(rv)
      implicit none
      real*8, intent(in) :: rv(3)

      if ((rv(1) == 0._8) .and. (rv(2) == 0._8)) then
        spherical_phi = 0._8
      else
        spherical_phi = atan2(rv(2), rv(1))
      end if
    end function
    
    real*8 function Bfunc(n, l, m, rv, use_Raitza_definition, maxR)
      implicit none
      integer, intent(in) :: n, l, m
      real*8, intent(in)  :: rv(3), maxR
      logical, intent(in) :: use_Raitza_definition
      
      real*8 :: r, r2, costheta, phi
      
      r        = spherical_r(       rv, r2)
      costheta = spherical_costheta(rv    )
      phi      = spherical_phi(     rv    )
      
      if (use_Raitza_definition) then ! second factor is identical
        Bfunc = Rfunc_Raitza(n,l,maxR,r) * r2 * ( MMFunc(l,m) * Pfunc(l,m,costheta) * Efunc(m,Phi) )
      else
	Bfunc = Rfunc_Wang(  n,l,maxR,r) * r2 * ( MMFunc(l,m) * Pfunc(l,m,costheta) * Efunc(m,Phi) )
      endif

    end function

end module
