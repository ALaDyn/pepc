#
#  Makefile for treemp and test programs
#

BGPSYS = /bgsys/drivers/ppcfloor

MPI_DIR  = -L$(BGPSYS)/comm/lib -L$(BGPSYS)/runtime/SPI
PREFIX = ..

#  Get machine-dependent flags

#  --------------------------------------------------------------------------------------
#  You shouldn't need to edit anything below here unless you're adding new source code
#  to add/modify compiler options:
#   - add option in ./configure (./configure --help lists all available options)
#   - or modify configure.in 
#  --------------------------------------------------------------------------------------

VISIT   = 
DEFINES = 

INCLUDE_MPI = -I$(BGPSYS)/comm/include

FC      = bgxlf90
#CC      = mpcc
FFLAGS  =  -WF,-DHAVE_PRIVATE_CONFIGS $(INCLUDE_MPI) -qarch=440 -qtune=440 -qnosave -qsuffix=f=f90 -qsuffix=cpp=F90 -O3
#LDFLAGS =  -L/bgl/local/lib   -L$(BGPSYS)/lib

LIBPEPC   = -L../lpepcsrc -llpepc
LIBS_MPI = $(MPI_DIR) -lmpich.cnk -ldcmfcoll.cnk -ldcmf.cnk -lpthread -lrt -lSPI.cna
LIBVISIT  =    
LIBNETCDF = @NETCDF@
LIBS      = -lm $(LIBPEPC) $(LIBVISIT) $(LIBNETCDF) $(LIBS_MPI) 

.SUFFIXES: .f90 .F90


# -------------------------------------------------------------------------------------------

# Source files

# -------------------------------------------------------------------------------------------

VISIT.F90   =   vis_parts_nbody.F90

PPSRC.F90   =   pepce.F90 

MODULES.f90 =   physvars.f90 utils.f90

SOURCES.f90 =	\
		setup.f90 stamp.f90 \
		configure.f90 face.f90 cutvector.f90 \
		randion.f90 maxwell1.f90 special_start.f90 cold_start.f90 scramble_v.f90 \
		forces.f90 force_direct.f90 error_test.f90 \
		velocities.f90 push.f90 \
	 	energy_cons.f90 potenergy.f90 kinenergy.f90\
		param_dump.f90 \
		open_files.f90 close_files.f90 restore_p1.f90

# -------------------------------------------------------------------------------------------

# Names of application object files derived from sources

APPOBJS = $(PPSRC.F90:.F90=.o) $(SOURCES.f90:.f90=.o) $(NCOBJS)
VISITOBJS = $(VISIT.F90:.F90=.o) 
APPMODS =  $(MODULES.f90:.f90=.o)
MODS = $(APPMODS)

default: pepce

#  compile rules

.f90.o:   
	$(FC) -c $(FFLAGS) $(DEFINES) $<

.F90.o:   
	$(FC) -c $(FFLAGS) $(DEFINES) $<

#  explicit rules for f90 modules to avoid conflict with built-in ones
physvars.o: 
	$(FC) -c $(FFLAGS) $(DEFINES) physvars.f90

#.c.o:   
#	$(CC) -c $(CFLAGS) $<


# -----------------------------------------------------------------------------------------
#  targets
# Names of application object files derived from sources
#APPOBJS = $(PPSRC.F90:.F90=.o) $(SOURCES.f90:.f90=.o)
#APPMODS =  $(MODULES.f90:.f90=.o)
#VISITOBJS = $(VISIT.F90:.F90=.o) 
#MODS = $(APPMODS) $(PMODS)

#all: MODS pepce

#  compile mode
#.f90.o:   
#	$(FC) -c $(FFLAGS) $(DBFLAGS) $<

#.F90.o:   
#	$(FC) -c $(FFLAGS) $(DBFLAGS) $<


# -----------------------------------------------------------------------------------------
#  targets

pepce:	lpepc $(APPMODS) $(APPOBJS)
	@echo "Creating application binary ../bin/pepce ..."
	$(FC)  $(FFLAGS) $(LDFLAGS) -o ../bin/pepce $(APPOBJS) $(MODS) $(LIBPEPC) $(LIBVISIT) $(LIBS_MPI)
	@echo "... done\n"

pepc-visit:	lpepc $(APPMODS) $(APPOBJS) $(VISITOBJS)
	@echo "Creating application binary ../bin/pepcevis ..."
	$(FC)  $(FFLAGS) $(LDFLAGS) -o ../bin/pepcevis $(APPOBJS) $(MODS) $(VISITOBJS) $(LIBPEPC) $(LIBVISIT) $(LIBS_MPI)
	@echo "... done\n"

# Update PEPC library and headers
lpepc:  ../lpepcsrc/liblpepc.a
	cd ../lpepcsrc; make -f makefile_bgp lpepc; cd ../pepc-e
	/bin/ln -sf $(PREFIX)/lpepcsrc/treevars.mod $(PREFIX)/pepc-e/treevars.mod
	/bin/ln -sf $(PREFIX)/lpepcsrc/tree_utils.mod $(PREFIX)/pepc-e/tree_utils.mod
	/bin/ln -sf $(PREFIX)/lpepcsrc/utils.mod $(PREFIX)/pepc-e/utils.mod



debug:	$(OBJECTS)
	@echo "Loading object files using flags $(DBFLAGS)"
	$(FC) $(LDFLAGS)  $(VISITLIBS) $(DBFLAGS)  -o $@ $(OBJECTS)


rand:	 rantest.o
	$(FC) $(FFLAGS) -o rand rantest.o

clean:
	/bin/rm -f bin/*.o  *% *~ bin/key rand *.o *.pif core *.mod 

cleanbin: /bin/rm -r pepc debug core

cleancore: 	
	/bin/rm $(pepcobjs) 

cleandata: 
	/bin/rm -f fort.* *.dat *.out *.gle 

depend:
	./f90depend -u -I/usr/lpp/ppe.poe/include/thread *.f90

default: pepce

### DO NOT DELETE OR EDIT THIS LINE
# Everything from here on down is generated by f90depend
# so do NOT add any translation rules below here.

#--- Include-Dependencies

#--- Module-Dependencies

close_files.o: physvars.o
cold_start.o: physvars.o utils.o
configure.o: physvars.o
cutvector.o: physvars.o
energy_cons.o: physvars.o utils.o
face.o: physvars.o
forces.o: physvars.o utils.o
kinenergy.o: physvars.o
open_files.o: physvars.o
param_dump.o: physvars.o utils.o
pepce.o: physvars.o utils.o
potenergy.o: physvars.o
push.o: physvars.o
randion.o: physvars.o utils.o
scramble_v.o: physvars.o utils.o
setup.o: physvars.o
special_start.o: physvars.o utils.o
velocities.o: physvars.o utils.o

