#
#  Makefile for treemp and test programs
#

PREFIX = ..

#  Get machine-dependent flags

include ../makefile.defs

LIBPEPC   = -L../lpepcsrc/$(MACH) -llpepc
LIBS      = $(LIBPEPC)

.SUFFIXES: .f90


# -------------------------------------------------------------------------------------------

# Source files

# -------------------------------------------------------------------------------------------

MODULES.f90 =   physvars.f90 utils.f90 benchmarking.f90

SOURCES.f90 =	\
		setup.f90 stamp.f90 \
		configure.f90 face.f90 cutvector.f90 \
		randion.f90 maxwell1.f90 special_start.f90 cold_start.f90 scramble_v.f90 \
		forces.f90 force_direct.f90 error_test.f90 \
		velocities.f90 push.f90 \
	 	energy_cons.f90 potenergy.f90 kinenergy.f90\
		param_dump.f90 \
		open_files.f90 close_files.f90 restore_p1.f90 pepce.f90

# -------------------------------------------------------------------------------------------

# Names of application object files derived from sources
# Prefix added for multi-arch builds

appobjs = $(addprefix $(MACH)/, $(SOURCES.f90:.f90=.o)) \
	  $(addprefix $(MACH)/, $(NCOBJS) )
appmods =  $(addprefix $(MACH)/, $(MODULES.f90:.f90=.o))
mods = $(appmods)

default: dirs pepce
all: dirs pepce
dirs: 	
	if [ ! -d $(MACH) ]; then mkdir $(MACH); fi

#  compile rules
$(MACH)/%.o: %.f90  
	$(CPP) $(CPPFLAGS) $< $(MACH)/$<
	$(FCPRE) $(FC) -c $(FFLAGS) $(DEFINES) $(MACH)/$< -o $@


#  explicit rules for f90 modules to avoid conflict with built-in ones
$(MACH)/physvars.o: physvars.f90
	$(CPP) $(CPPFLAGS) physvars.f90 $(MACH)/physvars.f90
	$(FCPRE) $(FC) -c $(FFLAGS) $(DEFINES) $(MACH)/physvars.f90 -o $@

$(MACH)/%.o: %.c  
	$(CC) -c $(CFLAGS) $< -o $@


# -----------------------------------------------------------------------------------------
#  targets
pepce:	lpepc $(appmods) $(appobjs)
	@echo "Creating application binary $(EXECNAME) ..."
	$(LDPRE) $(LD) $(LDFLAGS) -o $(EXECNAME) $(appobjs) $(appmods) $(LIBPEPC) $(LDLIBS)
	@echo "... done"

# Update PEPC library and headers
lpepc:  ../lpepcsrc/$(MACH)/liblpepc.a
#	cd ../lpepcsrc; make lpepc; cd ../pepc-e
	/bin/ln -sf $(PREFIX)/lpepcsrc/$(MACH)/treevars.mod $(PREFIX)/pepc-e/treevars.mod
	/bin/ln -sf $(PREFIX)/lpepcsrc/$(MACH)/tree_utils.mod $(PREFIX)/pepc-e/tree_utils.mod
	/bin/ln -sf $(PREFIX)/lpepcsrc/$(MACH)/utils.mod $(PREFIX)/pepc-e/utils.mod

clean:
	$(RM) $(MACH)/*.o  *% *~ bin/key rand *.o *.pif core *.mod $(MACH)/*.mod $(EXECNAME)
	$(RM) -r $(MACH)

default: pepce

### DO NOT DELETE OR EDIT THIS LINE
# Everything from here on down is generated by f90depend
# so do NOT add any translation rules below here.

#--- Include-Dependencies

#--- Module-Dependencies

close_files.o: physvars.o
cold_start.o: physvars.o utils.o
configure.o: physvars.o
cutvector.o: physvars.o
energy_cons.o: physvars.o utils.o
face.o: physvars.o
forces.o: physvars.o utils.o
kinenergy.o: physvars.o
open_files.o: physvars.o
param_dump.o: physvars.o utils.o
pepce.o: physvars.o utils.o
potenergy.o: physvars.o
push.o: physvars.o
randion.o: physvars.o utils.o
scramble_v.o: physvars.o utils.o
setup.o: physvars.o
special_start.o: physvars.o utils.o
velocities.o: physvars.o utils.o

